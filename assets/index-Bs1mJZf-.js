import{a as ge,j as t,m as Re,A as xt}from"./vendor-motion-Bl2lDopP.js";import{u as b,a as bt,t as he,b as I,s as vt,B as ee,d as Oe,c as ye,g as wt,H as Ee,V as G,A as yt,e as jt,f as N,M as Pe,h as Ae,i as X,j as kt,E as fe,k as It,l as St,T as Ct,D as Le,m as Mt,n as Tt}from"./vendor-tldraw-CaaMemrL.js";import{r as f}from"./vendor-apollo-B9XqHIAo.js";import"./vendor-axios-CFwfAwt2.js";import{g as Nt}from"./vendor-lodash-992l3ZN7.js";import{b as _e,h as xe,u as be}from"./vendor-firebase-BKQqa5bK.js";import{m1 as je,m2 as Pt,p as F,gi as z,l0 as u,m3 as At,m4 as ke,a as Ie,m5 as Ve,aV as Ue,gU as De,m6 as He,m7 as $e,m8 as qe,m9 as Ge,U as S,bk as Ze,dP as We,iJ as ve,G as Ye,gV as Qe,m as le,ma as Ke,t as R,jQ as ze,mb as Lt,a9 as Xe,T as Fe,kr as Je,ia as zt,ko as et,a2 as tt,ag as Ft,h9 as Se,iU as Ce,h6 as Bt,i5 as Rt,g$ as Ot,iI as Et,b1 as _t,js as Vt,jt as Ut,gh as Dt,gY as Ht,mc as $t,jR as qt,ew as Gt,md as Zt,P as at,lh as Wt,jJ as Yt,li as Qt,me as Kt,mf as Xt}from"./index-JhqgbpkX.js";import{c as Jt,B as ea,e as ta,u as k,I as aa}from"./vendor-i18next-TC5y0B3W.js";import{Z as sa,s as na,c as ia}from"./vendor-react-aria-BW9JtD2p.js";import{b as ra}from"./download-BM-WjQMK.js";import{C as oa}from"./LCMRealtime-hph6rUCz.js";import{r as la}from"./arrow-right-DJCRfyiv.js";import"./vendor-amplitude-core-CQMkGYFj.js";import"./vendor-fabric-Bg02ktlP.js";import"./vendor-radix-ui-DX5JiNHB.js";import"./vendor-mui-DTp04zm4.js";import"./vendor-graphql-DeSYh9DC.js";import"./vendor-react-router-Bm0RsDwP.js";import"./vendor-sentry-BZZLy1DV.js";import"./vendor-markdown-1uD3znr6.js";import"./i18n-resources-43uzMSBc.js";import"./vendor-hls-cbDBXQj9.js";import"./vendor-photoswipe-UqzIRFho.js";import"./objectDestructuringEmpty-YVl7faCL.js";import"./baseline-arrow-downward-zIQhHbGH.js";import"./GenerationModeNavigation-BeGzJJIs.js";(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};e.SENTRY_RELEASE={id:"0ec442be81a4ee21bfcf5745e8ef10bc76836958"}}catch{}})();try{(function(){var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new e.Error().stack;a&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[a]="75c756d5-83fb-4cdb-baba-0163bb636cd2",e._sentryDebugIdIdentifier="sentry-dbid-75c756d5-83fb-4cdb-baba-0163bb636cd2")})()}catch{}(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};e._sentryModuleMetadata=e._sentryModuleMetadata||{},e._sentryModuleMetadata[new e.Error().stack]=function(a){for(var n=1;n<arguments.length;n++){var s=arguments[n];if(s!=null)for(var r in s)s.hasOwnProperty(r)&&(a[r]=s[r])}return a}({},e._sentryModuleMetadata[new e.Error().stack],{"_sentryBundlerPluginAppKey:pixai-web-app-key":!0})}catch{}})();const O=[{locale:"en-US",tldrawLocale:"en",pixaiLocale:"en"},{locale:"ja-JP",tldrawLocale:"ja",pixaiLocale:"ja"},{locale:"ko-KR",tldrawLocale:"ko-kr",pixaiLocale:"kr"}],ca="https://cdn.simplelocalize.io/f432b1a2b9f449a79fb818436dcf4a8c/_latest",da=([e],[a])=>["default"].includes(a)?`${ca}/${e}/${a}`:Pt([O.find(({locale:n})=>n===e)?.pixaiLocale||O[0].pixaiLocale],[a]),Z=Jt();Z.use(ea).init({load:"currentOnly",backend:{backends:[ta],backendOptions:[{loadPath:da}]},ns:["default","generation"],defaultNS:"default",fallbackNS:"default",lng:O.find(e=>e.pixaiLocale===je.resolvedLanguage)?.locale,fallbackLng:"en-US",returnEmptyString:!1,nonExplicitSupportedLngs:!0,debug:!1,interpolation:{escapeValue:!1},react:{bindI18n:"languageChanged"}});Z.on("loaded",e=>{for(const[a,n]of Object.entries(e)){const s=O.find(({locale:r})=>r===a);if(s)for(const r in n){const i=je.getResourceBundle(s.pixaiLocale,r);i&&Z.addResourceBundle(a,r,i,!0,!1)}}});je.on("languageChanged",e=>{const a=O.find(n=>n.pixaiLocale===e);a?Z.changeLanguage(a.locale):Z.changeLanguage(O[0].locale)});function ie({type:e,shape:a,children:n}){const s=b(),r=f.useRef(null),[i,o]=f.useState(0);f.useEffect(()=>{const p=r.current;if(!p)return;const g=new ResizeObserver(()=>{o(p.offsetHeight)});return g.observe(p),o(p.offsetHeight),()=>g.disconnect()},[n]);const l=ge(0),c=ge(0),d=ge(0);return bt("position layers",()=>{const p=s.getCamera(),g=s.getShapePageBounds(a);if(g)if(l.set(he((p.x+g.x+g.width/2)*p.z)),e==="top"){const m=he((p.y+g.y)*p.z),h=i+1;c.set(Math.max(m,h))}else{const m=he((p.y+g.y+g.height+8)*p.z),h=s.getViewportScreenBounds().height-i-1;d.set(Math.min(m,h))}},[s,a,i]),t.jsx(Re.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},style:{x:l,y:e==="top"?c:d,pointerEvents:"all"},className:"z-[var(--layer-canvas)] tl-overlays__item text-primary",transition:{type:"spring",damping:20,stiffness:300},children:t.jsx("div",{ref:r,className:F("absolute left-[50%] flex items-center justify-center translate-x-[-50%]",e==="top"?"bottom-0":"top-0"),children:n})},`${e}-${a.id}`)}const E=e=>["marker","marker-lasso","marker-geo"].includes(e.type),te=e=>{const a=!!e.meta.pixai_isBaseImage;return a&&u(e.type==="genmedia"||e.type==="image","base image shape type is not genmedia or image"),a},ne=e=>e.type==="frame"&&!!e.meta.pixai_outpaintFrameOf;async function Me(e,a){const n=a.type==="genmedia"?a.props.currentAssetId:a.props.assetId;if(n){const s=e.getAsset(n);if(s?.meta.media)return z.fromMedia(s.meta.media);if(s?.props.src)return fetch(s.props.src).then(r=>r.blob()).then(r=>z.fromFile(new File([r],"base.png",{type:"image/png"})))}}function st(e,a){const n=a.type==="genmedia"?a.props.currentAssetId:a.props.assetId;u(n,"The inpaint target does not contain an image");const s=e.getAsset(n);return u(s,"Base shape asset not found"),{width:s.props.w,height:s.props.h}}function re(e,a,n,s,r,i){return{priority:1e3,model:"pixai-panelplugin",modelId:"",workflowName:e,width:a.width,height:a.height,samplingSteps:25,cfgScale:5.5,batchSize:1,fillEditorType:i,inputs:{baseImage:{media_id:n},mask:{media_id:s},prompt:r,seed:At()}}}const nt=_e(8),ce=_e(Object.keys(ke)[0]);function pa({shapes:e,baseShape:a}){const{t:n}=k(),s=b(),{data:r}=Ie(),i=xe(nt),o=xe(ce),[l,c]=f.useState(""),d=f.useRef(null);f.useLayoutEffect(()=>{const y=d.current;y&&(y.style.height="auto",y.style.height=y.scrollHeight+"px")},[l]);const[p,g]=Ve(),m=Ue("mlg"),h=()=>{const y=st(s,a),v=ve({...y,maxEdge:2048});return u(v.width&&v.height,"Invalid image size"),v},w=I("valuesToCalc",()=>re(o,h(),"1","1","1girl","inpaint"),[s,o]),{data:j,isValidating:C}=De(w),x=async()=>{if(r?.id===void 0){Ye(null,{fromPath:"gen-submit"});return}const y=[...e].sort((M,U)=>-vt(M,U)),v=ee.Common(Oe(e.map(M=>s.getShapePageBounds(M)))),L=ee.FromPoints(s.getShapePageTransform(a).invert().applyToPoints(v.corners)),B=ye(),_=L.x-i,V=L.y-i,W=L.w+i*2,Y=L.h+i*2;s.createShape({id:B,type:"genmedia",x:_,y:V,props:{w:W,h:Y,pending:"Preparing...",prompts:l,shouldReceiveMarker:!1,isInpaint:!0,derivationOfShape:a.id,crop:{topLeft:{x:_/a.props.w,y:V/a.props.h},bottomRight:{x:(_+W)/a.props.w,y:(V+Y)/a.props.h}}},meta:{inpaintOfShape:a.id},parentId:a.id,index:wt(y[0].index)}).select(B);try{const M=new ee(a.x,a.y,a.props.w,a.props.h),U=await s.getSvg(e,{bounds:M,background:!1,padding:0});u(U,"Failed to render mask shapes");let Q;const D=e.filter(T=>T.props.isPaint);D.length&&(Q=await s.getSvg(D,{bounds:M,background:!1,padding:0}),u(Q,"Failed to render paint shapes")),s.deleteShapes(e.map(T=>T.id));const ae=a.type==="genmedia"?a.props.currentAssetId:a.props.assetId;u(ae,"The inpaint target does not contain an image");const se=s.getAsset(ae);u(se,"Base shape asset not found");const P=ve({width:se.props.w,height:se.props.h,maxEdge:2048});u(P.width&&P.height,"Invalid image size");let H=await Me(s,a);u(H,"Failed to generate base image"),Q&&(H=await ma(H,Q));const $=await H.toMedia({maxWidthOrHeight:2048,async onCompressed(T){const{width:ht,height:ft}=await T.getDimensions();P.width=ht,P.height=ft}});u($,"Failed to upload base image");const pe=await it(U,i,P.width,P.height),ue=await z.fromFile(new File([pe],"mask.png",{type:"image/png"})).toMedia({maxWidthOrHeight:2048,onCompressed:void 0});u(ue,"Failed to upload mask image");const K=re(o,P,$.id,ue.id,l,"inpaint"),Ne=(await Qe({parameters:K})).data?.createGenerationTask;le("generate_task_submit",Ke({taskId:Ne?.id,isWorkflowGenerativeFill:!0,hasBrush:e.some(T=>T.type==="marker"),hasBox:e.some(T=>T.type==="marker-geo"),hasLasso:e.some(T=>T.type==="marker-lasso"),...K}),{extraDestinations:["gtm"]}),s.updateShape({id:B,type:"genmedia",props:{pending:"Waiting..."},meta:{generationTask:Ne}},{ephemeral:!0})}catch(M){console.error(M),R.error(String(M)),s.deleteShape(B)}};return t.jsx(He,{enable:p&&!m,setEnable:g,children:t.jsxs("div",{className:"relative flex flex-col justify-center items-center gap-1 p-1 w-96 rounded-md bg-background shadow-lg",children:[t.jsx($e,{}),t.jsx(qe,{ref:d,className:F("px-2 pt-2 pb-9 w-full min-h-[calc(4.5em+1rem)] max-h-[calc(9em+1rem)] text-sm","rounded bg-neutral-50 dark:bg-neutral-700 outline-none resize-none placeholder:text-neutral-500"),"data-tutorial-target":"prompts-input",placeholder:n("generation:prompts.prompts-placeholder"),value:l,onChange:y=>c(y.target.value)}),t.jsxs("div",{className:"absolute bottom-2 right-2 flex items-center gap-2",children:[t.jsx(Ge,{}),t.jsxs(S,{labelClassName:"flex items-center gap-1",variant:"filled",color:l?"theme":"normal",size:"small",busy:C,disabled:!l,onPress:x,children:[n("generation:submit.lets-go.label"),r&&t.jsx(Ze,{iconClassName:"!size-3",children:t.jsx(We,{value:j?.actualPrice??0,loading:C,className:"!text-inherit font-normal",iconClassName:"hidden",valueClassName:"text-xs"})})]})]})]})})}async function ma(e,a){const{width:n,height:s}=await e.getDimensions(),r=new OffscreenCanvas(n,s),i=r.getContext("2d");await ze(e,async l=>{const c=new Image;c.src=l,c.crossOrigin="anonymous",await new Promise((d,p)=>{c.onload=d,c.onerror=p}),i.drawImage(c,0,0)});const o=new Blob([new XMLSerializer().serializeToString(a)],{type:"image/svg+xml"});return await ze(o,async l=>{const c=new Image;c.src=l,await new Promise((d,p)=>{c.onload=d,c.onerror=p}),i.drawImage(c,0,0)}),z.fromOffscreenCanvas(r,"painted.png")}async function it(e,a=0,n,s){const r="http://www.w3.org/2000/svg",i=e.querySelector("defs")??document.createElementNS(r,"defs"),o=document.createElementNS(r,"filter");o.setAttribute("id","featheringFilter"),i.appendChild(o);const l=document.createElementNS(r,"feColorMatrix");l.setAttribute("type","matrix"),l.setAttribute("values","0 0 0 20 -10 0 0 0 20 -10 0 0 0 20 -10 0 0 0 20 -10"),o.appendChild(l);const c=document.createElementNS(r,"feGaussianBlur");c.setAttribute("in","SourceGraphic"),c.setAttribute("stdDeviation",a.toString()),o.appendChild(c),e.setAttribute("filter","url(#featheringFilter)");const d=e.querySelectorAll("[stroke]");for(const h of d)h.setAttribute("stroke","#ffffff"),h.setAttribute("opacity","1.0");e.style.backgroundColor="black";const p=new Blob([new XMLSerializer().serializeToString(e)],{type:"image/svg+xml"}),g=URL.createObjectURL(p),m=new Image;return m.src=g,new Promise((h,w)=>{m.onload=async()=>{const j=new OffscreenCanvas(n,s);j.getContext("2d").drawImage(m,0,0,m.width,m.height,0,0,n,s),j.convertToBlob({type:"image/png"}).then(h).catch(w),URL.revokeObjectURL(g)},m.onerror=j=>{w(j)}})}function ua(e){const{inputPrompts:a,mode:n,caption:s,originalPrompts:r}=e,i=a.split(",").map(o=>o.trim()).filter(o=>o.length>0).map(o=>`((${o}))`).join(", ");return n==="inpaint"?[i,r].filter(o=>o.length>0).join(", "):[i,r,s].filter(o=>o.length>0).join(", ")}function ga({frameShape:e,baseShape:a}){const{t:n}=k(),s=b(),{data:r}=Ie(),i=xe(ce),[o,l]=f.useState(""),c=f.useRef(null);f.useLayoutEffect(()=>{const x=c.current;x&&(x.style.height="auto",x.style.height=x.scrollHeight+"px")},[o]);const[d,p]=Ve(),g=Ue("mlg"),m=()=>{const x=st(s,a),y=ve({width:e.props.w*(x.width/a.props.w),height:e.props.h*(x.height/a.props.h),maxEdge:2048});return u(y.width&&y.height),y},h=I("valuesToCalc",()=>re(i,m(),"","","1girl","outpaint"),[s,i]),{data:w,isValidating:j}=De(h),C=async()=>{if(r?.id===void 0){Ye(null,{fromPath:"gen-submit"});return}const x=ye();s.createShape({...a,...e,id:x,type:"genmedia",props:{w:e.props.w,h:e.props.h,pending:"Preparing...",prompts:o},meta:{...a.meta,generationTask:null}}).select(x);const y=v=>{s.updateShape({id:x,type:"genmedia",props:{pending:v}},{ephemeral:!0})};try{s.deleteShape(e);const v=m(),L=v.width/e.props.w,B=Math.floor(a.x*L),_=Math.floor(a.y*L),V=Math.floor(a.props.w*L),W=Math.floor(a.props.h*L),Y=await Me(s,a);u(Y,"Failed to generate base image");const M=await Y.toFile(),U=await fa(M,B,_,V,W,v.width,v.height),D=await z.fromFile(new File([U],"base.png",{type:"image/png"})).toMedia({maxWidthOrHeight:2048,onCompressed:void 0});u(D,"Failed to upload base image");const ae=await ha(B,_,V,W,v.width,v.height),P=await z.fromFile(new File([ae],"mask.png",{type:"image/png"})).toMedia({maxWidthOrHeight:2048,onCompressed:void 0});u(P,"Failed to upload mask image");const H=async()=>{const{data:q}=await Lt({mediaId:D.id});if(q.error)throw q.error;return q.output?.[0]||""};y(`${n("generation:fill.notice.captioning-image")}`);let $="";try{$=await H(),y(`${n("generation:fill.notice.append-prompt",{caption:$})}`)}catch(q){R.error("Cannot get image captions: "+q)}const pe=ua({mode:"outpaint",originalPrompts:a.meta.generationTask?.parameters.prompts||(a.type==="genmedia"?a.props.prompts:null)||"",inputPrompts:o,caption:$}),me=re(i,v,D.id,P.id,pe,"outpaint"),K=(await Qe({parameters:me})).data?.createGenerationTask;le("generate_task_submit",Ke({taskId:K?.id,isWorkflowGenerativeFill:!0,...me}),{extraDestinations:["gtm"]}),s.updateShape({id:x,type:"genmedia",props:{w:v.width,h:v.height,pending:"Waiting..."},meta:{generationTask:K}},{ephemeral:!0}).zoomToSelection()}catch(v){console.error(v),R.error(String(v)),s.deleteShape(x)}};return t.jsx(He,{enable:d&&!g,setEnable:p,children:t.jsxs("div",{className:"relative flex flex-col justify-center items-center gap-1 p-1 w-96 rounded-md bg-background shadow-lg",children:[t.jsx($e,{}),t.jsx(qe,{ref:c,className:F("px-2 pt-2 pb-9 w-full min-h-[calc(4.5em+1rem)] max-h-[calc(9em+1rem)] text-sm","rounded bg-neutral-50 dark:bg-neutral-700 outline-none resize-none placeholder:text-neutral-500"),placeholder:n("generation:prompts.prompts-placeholder"),value:o,onChange:x=>l(x.target.value)}),t.jsxs("div",{className:"absolute bottom-2 right-2 flex items-center gap-2",children:[t.jsx(Ge,{}),t.jsxs(S,{labelClassName:"flex items-center gap-1",variant:"filled",color:o?"theme":"normal",size:"small",busy:j,disabled:!o,onPress:C,children:[n("generation:submit.lets-go.label"),r&&t.jsx(Ze,{iconClassName:"!size-3",children:t.jsx(We,{value:w?.actualPrice??0,loading:j,className:"!text-inherit font-normal",iconClassName:"hidden",valueClassName:"text-xs"})})]})]})]})})}function ha(e,a,n,s,r,i){return new Promise((o,l)=>{const c=new OffscreenCanvas(r,i),d=c.getContext("2d");d.fillStyle="white",d.fillRect(0,0,r,i),d.fillStyle="black",d.fillRect(e,a,n,s),c.convertToBlob({type:"image/png"}).then(o).catch(l)})}function fa(e,a,n,s,r,i,o){const l=new Image;return l.crossOrigin="anonymous",l.src=URL.createObjectURL(e),new Promise((c,d)=>{l.onload=()=>{const p=new OffscreenCanvas(i,o);p.getContext("2d").drawImage(l,a,n,s,r),p.convertToBlob({type:"image/png"}).then(c).catch(d)},l.onerror=p=>{URL.revokeObjectURL(l.src),d(p)}})}function xa(){const e=b();return I("should display toolbar",()=>e.isInAny("select.idle","select.brushing","select.scribble_brushing","select.editing_shape","select.pointing_shape","select.pointing_selection","select.pointing_handle","marker.idle","marker-lasso.idle","marker-geo.idle","marker-eraser.idle")&&!e.getInstanceState().isChangingStyle,[e])?t.jsxs(t.Fragment,{children:[t.jsx(ba,{}),t.jsx(va,{})]}):null}function ba(){const e=b(),a=I("selectedShapes",()=>e.getSelectedShapes().filter(E),[e]),n=I("baseShape",()=>{if(!a.length)return e.getShapeAtPoint(e.inputs.currentPagePoint,{margin:Ee/e.getZoomLevel(),renderingOnly:!0,filter:te});const r=e.findShapeAncestor(a[0],te);if(r)return a.every(i=>e.findShapeAncestor(i,o=>o.id===r.id))?r:void 0},[a,e]),s=I("shapes",()=>a.length?a:n?Oe(e.getSortedChildIdsForParent(n).map(r=>e.getShape(r))).filter(E):[],[a,n,e]);return n&&s.length?t.jsx(ie,{type:"bottom",shape:n,children:t.jsx(pa,{baseShape:n,shapes:s})},n.id):null}function va(){const e=b(),a=I("frameShape",()=>{const s=e.getOnlySelectedShape();return s?ne(s)?s:e.findShapeAncestor(s,ne):e.getShapeAtPoint(e.inputs.currentPagePoint,{margin:Ee/e.getZoomLevel(),renderingOnly:!0,filter:ne})},[e]),n=I("baseShape",()=>{if(!a)return;const s=e.getShape(a.meta.pixai_outpaintFrameOf);if(s)return u(te(s),"outpaint base shape invalid"),s},[e,a]);return a&&n?t.jsx(ie,{type:"bottom",shape:a,children:t.jsx(ga,{baseShape:n,frameShape:a})},a.id):null}const wa=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M5 2V1h5v1zm-.25-2A.75.75 0 0 0 4 .75V1h-.5A1.5 1.5 0 0 0 2 2.5v10A1.5 1.5 0 0 0 3.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 11.5 1H11V.75a.75.75 0 0 0-.75-.75zM11 2v.25a.75.75 0 0 1-.75.75h-5.5A.75.75 0 0 1 4 2.25V2h-.5a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-10a.5.5 0 0 0-.5-.5z",clipRule:"evenodd"})}),oe=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M2.5 1h10A1.5 1.5 0 0 1 14 2.5v10a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 1 12.5v-10A1.5 1.5 0 0 1 2.5 1m0 1a.5.5 0 0 0-.5.5v5.864l1.682-1.682a.45.45 0 0 1 .647.01l3.545 3.798l2.808-2.808a.45.45 0 0 1 .636 0L13 9.364V2.5a.5.5 0 0 0-.5-.5zM2 12.5V9.636l1.989-1.988l3.542 3.794L8.941 13H2.5a.5.5 0 0 1-.5-.5m10.5.5h-2.345l-1.672-1.847L11 8.636l2 2V12.5a.5.5 0 0 1-.5.5M6.65 5.5a.85.85 0 1 1 1.7 0a.85.85 0 0 1-1.7 0m.85-1.75a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5",clipRule:"evenodd"})}),ya=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsxs("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,children:[t.jsx("path",{d:"M7 22a5 5 0 0 1-2-4m-1.7-4A6.8 6.8 0 0 1 2 10c0-4.4 4.5-8 10-8s10 3.6 10 8s-4.5 8-10 8a12 12 0 0 1-5-1"}),t.jsx("path",{d:"M5 18a2 2 0 1 0 0-4a2 2 0 0 0 0 4"})]})}),rt=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M12.5 2h-10a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5v-10a.5.5 0 0 0-.5-.5m-10-1A1.5 1.5 0 0 0 1 2.5v10A1.5 1.5 0 0 0 2.5 14h10a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 12.5 1z",clipRule:"evenodd"})}),ja=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M3.135 6.158a.5.5 0 0 1 .707-.023L7.5 9.565l3.658-3.43a.5.5 0 0 1 .684.73l-4 3.75a.5.5 0 0 1-.684 0l-4-3.75a.5.5 0 0 1-.023-.707",clipRule:"evenodd"})}),ka=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M3.292.049a.5.5 0 0 1 .535.077L12.86 7.95a.5.5 0 0 1-.306.878l-3.334.147l1.931 4.244a.5.5 0 0 1-.247.662l-2.153.98a.5.5 0 0 1-.662-.247L6.153 10.37l-2.29 2.416A.5.5 0 0 1 3 12.44V.504a.5.5 0 0 1 .292-.455M4 1.599v9.589l1.938-2.044a.5.5 0 0 1 .818.137l2.035 4.463l1.242-.566l-2.031-4.463a.5.5 0 0 1 .433-.707l2.82-.124z",clipRule:"evenodd"})}),Ia=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M7.5 1.05a.45.45 0 0 1 .45.45v6.914l2.232-2.232a.45.45 0 1 1 .636.636l-3 3a.45.45 0 0 1-.636 0l-3-3a.45.45 0 1 1 .636-.636L7.05 8.414V1.5a.45.45 0 0 1 .45-.45M2.5 10a.5.5 0 0 1 .5.5V12c0 .554.446 1 .996 1h7.005A1 1 0 0 0 12 12v-1.5a.5.5 0 0 1 1 0V12a2 2 0 0 1-1.999 2H3.996A1.997 1.997 0 0 1 2 12v-1.5a.5.5 0 0 1 .5-.5",clipRule:"evenodd"})}),Sa=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.36.73a.5.5 0 0 1 .708 0l5.203 5.202a.5.5 0 0 1 0 .707l-5.316 5.316l-1.608 1.609a1.5 1.5 0 0 1-2.122 0l-3.789-3.79a1.5 1.5 0 0 1 0-2.12l1.609-1.61zm.354 1.06L4.106 6.398l4.496 4.496l4.608-4.608zm-.82 9.811L3.398 7.107L2.143 8.36a.5.5 0 0 0 0 .708l3.79 3.789a.5.5 0 0 0 .706 0z",clipRule:"evenodd"})}),Ca=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M1.5 2a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1m3 0a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1M8 1.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0m2.5.5a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1m3.5-.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0M1.5 14a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1m.5-3.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0M1.5 8a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1M2 4.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0M13.5 11a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1m.5-3.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0M13.5 5a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1M5 13.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0m2.5.5a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1m3.5-.5a.5.5 0 1 1-1 0a.5.5 0 0 1 1 0m2.5.5a.5.5 0 1 0 0-1a.5.5 0 0 0 0 1M4 5a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1zm1 0h5v5H5z",clipRule:"evenodd"})}),ot=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M11.854 1.146a.5.5 0 0 0-.707 0L3.714 8.578a1 1 0 0 0-.212.314L2.04 12.303a.5.5 0 0 0 .657.657l3.411-1.463a1 1 0 0 0 .314-.211l7.432-7.432a.5.5 0 0 0 0-.708zm-7.432 8.14l7.078-7.08L12.793 3.5l-7.078 7.078l-1.496.641l-.438-.438z",clipRule:"evenodd"})}),Ma=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"M6.4 21L5 19.6l4.825-4.85q.575-.575.875-1.3t.3-1.525v-5.1L9.4 8.4L8 7l4-4l4 4l-1.4 1.4L13 6.825v5.1q0 .8.3 1.525t.875 1.3L19 19.6L17.6 21L12 15.4L6.4 21Z"})}),Ta=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M5.5 1a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zM3 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 0 1H11v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4h-.5a.5.5 0 0 1-.5-.5M5 4h5v8H5z",clipRule:"evenodd"})}),Na=e=>{const{t:a}=k(),n=b();if(!e.length)return[];const s=e[0],r=[];return s.type==="genmedia"&&s.meta.inpaintOfShape&&r.push({label:a("action.merge-inpaint"),Icon:Ma,disabled:!!s.props.pending||!!s.props.alert,onClick:()=>Pa(n,s)}),s.type!=="genbox"&&r.push({label:a("action.delete"),Icon:Ta,onClick:()=>{n.updateShapes(e.map(i=>({id:i.id,type:i.type,isLocked:!1}))),n.deleteShapes(e.map(i=>i.id))}}),r};async function Pa(e,a){u(a.props.currentAssetId,"Inpaint asset ID not found");const n=e.getAsset(a.props.currentAssetId);u(n,"Inpaint asset not found"),u(n.type==="image","Inpaint asset is not an image"),u(n.props.src,"Inpaint asset src not found"),u(typeof a.meta.inpaintOfShape=="string","Base shape ID not found");const s=e.getShape(a.meta.inpaintOfShape);u(s,"Base shape not found"),u(s.type==="genmedia","Base shape is not a genmedia shape"),u(s.props.currentAssetId,"Base shape current asset ID not found");const r=e.getAsset(s.props.currentAssetId);u(r,"Base shape asset not found"),u(r.type==="image","Base shape asset is not an image"),u(r.props.src,"Base shape asset src not found");const i=new Image;i.crossOrigin="anonymous",i.src=r.props.src,await new Promise(x=>{i.onload=x});const o=new Image;o.crossOrigin="anonymous",o.src=n.props.src,await new Promise(x=>{o.onload=x});const l=document.createElement("canvas");l.width=r.props.w,l.height=r.props.h;const c=l.getContext("2d");u(c,"Canvas context not found"),c.drawImage(i,0,0),u(a.props.crop,"Inpaint should have crop");const d=G.From(a.props.crop.topLeft),p=G.From(a.props.crop.bottomRight),g=G.MulV(d,{x:o.width,y:o.height}),m=G.MulV(p,{x:o.width,y:o.height}),h=G.MulV(d,{x:i.width,y:i.height}),w=G.MulV(p,{x:i.width,y:i.height});c.drawImage(o,g.x,g.y,m.x-g.x,m.y-g.y,h.x,h.y,w.x-h.x,w.y-h.y);const j=l.toDataURL("image/png"),C=yt.createId();e.createAssets([{id:C,type:"image",typeName:"asset",props:{name:"Merged Image "+C,src:j,w:r.props.w,h:r.props.h,mimeType:"image/png",isAnimated:!1},meta:{}}]).deleteShape(a.id).updateShape({id:s.id,type:s.type,props:{currentAssetId:C,assetIds:s.props.assetIds.map(x=>x===s.props.currentAssetId?C:x)},meta:{generationTask:null}},{squashing:!0}).deleteAssets([a.props.currentAssetId,s.props.currentAssetId]).select(s.id)}async function Aa(e,a){const n=e.getCurrentPageShapes().filter(E);if(n.length)try{await Xe({title:t.jsx(Fe,{i18nKey:"generation:fill.editor.tool.outpaint.switch-confirm.title"}),description:t.jsx(Fe,{i18nKey:"generation:fill.editor.tool.outpaint.switch-confirm.description"})}),e.deleteShapes(n)}catch{return}const s=lt(e,a),r=e.getShapePageBounds(a);return r&&e.zoomToBounds(r.clone().expandBy(Math.max(r.w,r.h)*.15)),s}function lt(e,a){const n=e.getShapeParent(a.id);if(n?.meta.pixai_outpaintFrameOf===a.id)return e.select(n.id),n.id;const s=ye();return e.createShape({id:s,type:"frame",x:a.x,y:a.y,props:{w:a.props.w,h:a.props.h},meta:{pixai_outpaintFrameOf:a.id}}).reparentShapes([a],s).select(s).setCurrentTool("select"),s}function La(e,a){const n=e.getSortedChildIdsForParent(a.id);return e.reparentShapes(n,e.getShapeParent(a)?.id||e.getCurrentPageId()).deleteShape(a.id),n}function ct(e){const a=e.props;if(!a)throw new Error("Shape is missing props.");if(typeof a.w!="number"||typeof a.h!="number")throw new Error("Shape is missing width or height.")}async function za(e,a,{filter:n,format:s,comment:r,includeSelf:i},o={}){ct(a);const l=new ee(a.x,a.y,a.props.w,a.props.h),c=e.getCurrentPageShapes().filter(d=>{if(d.id===a.id)return!1;const p=e.getShapeMaskedPageBounds(d);return p?l.includes(p):!1}).filter(d=>!n||n(d)).map(d=>d.id);return i&&c.push(a.id),we(e,c,s,o,{comment:r})}async function we(e,a,n="png",s={},r={}){if(!a.length)return;const i=await e.getSvg(a,s);if(!i)throw new Error("Could not construct SVG.");switch(n){case"webp":case"jpeg":case"png":return jt(i,e.environment.isSafari,{type:n,quality:1,scale:1,...r}).then(o=>{if(!o)throw Error("Could not render image.");return o});default:throw new Error(`Export type ${n} not supported.`)}}const Fa=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"m19.35 11.72l-2.13 2.13l-1.41-1.42l-7.71 7.71L3.5 22L2 20.5l1.86-4.6l7.71-7.71l-1.42-1.41l2.13-2.13l7.07 7.07M16.76 3A3 3 0 0 1 21 3a3 3 0 0 1 0 4.24l-1.92 1.92l-4.24-4.24L16.76 3M5.56 17.03L4.5 19.5l2.47-1.06L14.4 11L13 9.6l-7.44 7.43Z"})}),Ba=f.forwardRef(function(a,n){const s=b(),r=I("currentTool",()=>s.getCurrentTool(),[s]),i=I("selectedShapes",()=>s.getSelectedShapes(),[s]);if(r.id==="select"){if(i.some(E))return t.jsx(J,{ref:n,children:t.jsx(de,{})});if(i.some(o=>o.meta.pixai_outpaintFrameOf))return t.jsx(J,{ref:n,children:t.jsx(_a,{})})}return r.id==="marker"?t.jsx(J,{ref:n,children:t.jsx(Ra,{})}):r.id==="marker-geo"?t.jsx(J,{ref:n,children:t.jsx(Oa,{})}):r.id==="marker-lasso"?t.jsx(J,{ref:n,children:t.jsx(Ea,{})}):null}),J=f.forwardRef(function({children:a},n){return t.jsx(Re.div,{ref:n,layout:!0,className:"z-[var(--layer-canvas)] absolute top-4 right-4 flex w-64 origin-top-right items-center rounded bg-zinc-50 dark:bg-zinc-800/80 font-bold dark:text-white shadow-lg backdrop-blur-lg",initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},transition:{type:"spring",duration:.42},children:t.jsx("div",{className:"relative flex size-full flex-col gap-4 overflow-hidden p-3",children:a})},"active-toolbox")}),Ra=N(()=>{const{t:e}=k(),a=b(),n=a.getStyleForNextShape(Pe);return t.jsxs(t.Fragment,{children:[t.jsx(Je,{variant:"half-filled",label:e("generation:image-edit.brush-size"),sliderOutputProps:{className:"font-semibold"},minValue:5,maxValue:100,step:1,value:n,onChange:s=>{a.setStyleForNextShapes(Pe,s,{squashing:!0})}}),t.jsx(Te,{title:e("generation:image-edit.brush-color")}),t.jsx(de,{})]})}),Oa=N(()=>{const{t:e}=k();return t.jsxs(t.Fragment,{children:[t.jsx(Te,{title:e("generation:image-edit.shape-color")}),t.jsx(de,{})]})}),Ea=N(()=>{const{t:e}=k();return t.jsxs(t.Fragment,{children:[t.jsx(Te,{title:e("generation:image-edit.shape-color")}),t.jsx(de,{})]})}),Te=N(({title:e})=>{const{t:a}=k(),n=b(),s=n.getStyleForNextShape(Ae),r=n.getStyleForNextShape(X);return t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{children:e}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(zt,{isSelected:s,onChange:i=>{i||n.setStyleForNextShapes(X,X.defaultValue,{squashing:!0}),n.setStyleForNextShapes(Ae,i,{squashing:!0})}}),t.jsxs("label",{className:F("flex items-center",s&&"cursor-pointer"),children:[t.jsx(oa,{className:"min-w-0 w-6 h-6 rounded-l-md rounded-r-none border-black/50 dark:border-white/50 disabled:border-black/20 disabled:dark:border-white/20",disabled:!s,hex:r,onChange:i=>{n.setStyleForNextShapes(X,i,{squashing:!0})}}),t.jsx("div",{className:F("flex items-center h-6 px-2 font-normal border border-l-0 rounded-r-md",s?"border-black/50 dark:border-white/50":"text-neutral-500 dark:text-neutral-400 border-black/20 dark:border-white/20"),children:r})]}),window.EyeDropper&&t.jsx(S,{className:"h-6",disabled:!s,size:"small",onPress:()=>{new window.EyeDropper().open().then(({sRGBHex:o})=>{n.setStyleForNextShapes(X,o,{squashing:!0})}).catch(()=>{R.error(a("style-panel.color.failed-to-pick"))})},startIconClassName:"-mt-px size-6",icon:t.jsx(Fa,{className:"m-auto"})})]})]})}),de=N(()=>{const{t:e}=k(["generation"]),[a,n]=be(nt),[s,r]=be(ce);return t.jsxs(t.Fragment,{children:[t.jsx(Je,{variant:"half-filled",label:e("generation:fill.editor.tool.inpaint.feathering"),sliderOutputProps:{className:"font-semibold"},minValue:0,maxValue:32,step:4,value:a,onChange:n}),t.jsx(et,{label:e("generation:fill.editor.tool.inpaint.model"),value:s,onChange:r,children:Object.entries(ke).map(([i,o])=>t.jsx(tt,{variant:"circle",className:"text-sm font-normal",value:i,children:o},i))})]})}),_a=N(()=>{const{t:e}=k(),[a,n]=be(ce);return t.jsx(t.Fragment,{children:t.jsx(et,{label:e("generation:fill.editor.tool.inpaint.model"),value:a,onChange:n,children:Object.entries(ke).map(([s,r])=>t.jsx(tt,{variant:"circle",className:"text-sm font-normal",value:s,children:r},s))})})}),Va=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"M9.9 19q-2.425 0-4.163-1.575T4 13.5q0-2.35 1.738-3.925T9.9 8h6.3l-2.6-2.6L15 4l5 5l-5 5l-1.4-1.4l2.6-2.6H9.9q-1.575 0-2.738 1T6 13.5Q6 15 7.163 16T9.9 17H17v2H9.9Z"})}),Ua=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"M7 19v-2h7.1q1.575 0 2.738-1T18 13.5q0-1.5-1.163-2.5T14.1 10H7.8l2.6 2.6L9 14L4 9l5-5l1.4 1.4L7.8 8h6.3q2.425 0 4.163 1.575T20 13.5q0 2.35-1.738 3.925T14.1 19H7Z"})}),Da=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5q0-2.725 1.888-4.612T9.5 3q2.725 0 4.612 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3l-1.4 1.4ZM9.5 14q1.875 0 3.188-1.313T14 9.5q0-1.875-1.313-3.188T9.5 5Q7.625 5 6.312 6.313T5 9.5q0 1.875 1.313 3.188T9.5 14Zm-1-1.5v-2h-2v-2h2v-2h2v2h2v2h-2v2h-2Z"})}),Ha=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",d:"m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5q0-2.725 1.888-4.612T9.5 3q2.725 0 4.612 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3l-1.4 1.4ZM9.5 14q1.875 0 3.188-1.313T14 9.5q0-1.875-1.313-3.188T9.5 5Q7.625 5 6.312 6.313T5 9.5q0 1.875 1.313 3.188T9.5 14ZM7 10.5v-2h5v2H7Z"})}),dt=N(()=>t.jsx("div",{className:"z-[var(--layer-canvas)] absolute bottom-4 left-4",children:t.jsxs("div",{className:"flex h-full items-center gap-4",children:[t.jsx(pt,{}),t.jsx(mt,{})]})}));dt.displayName="track(CanvasCTA)";const pt=N(()=>{const e=b(),a=e.getZoomLevel();return t.jsxs("div",{className:"flex items-center -space-x-px rounded-md bg-zinc-50 dark:bg-zinc-800/80",children:[t.jsx(S,{className:"rounded-r-none",disabled:a===kt,icon:t.jsx(Ha,{}),onPress:()=>{e.zoomOut(void 0,{duration:200,easing:fe.easeInOutQuint})}}),t.jsxs(S,{className:"w-16 rounded-none tabular-nums",onPress:()=>{e.resetZoom(void 0,{duration:200,easing:fe.easeInOutQuint})},children:[(a*100).toFixed(0),"%"]}),t.jsx(S,{className:"rounded-l-none",disabled:a===It,icon:t.jsx(Da,{}),onPress:()=>{e.zoomIn(void 0,{duration:200,easing:fe.easeInOutQuint})}})]})});pt.displayName="track(Zoom)";const mt=N(()=>{const e=b();return t.jsxs("div",{className:"flex items-center -space-x-px rounded-md bg-zinc-50 dark:bg-zinc-800/80",children:[t.jsx(S,{className:"rounded-r-none",disabled:!e.getCanUndo(),icon:t.jsx(Ua,{}),onPress:()=>{e.undo()}}),t.jsx("div",{className:"h-full w-px bg-zinc-200"}),t.jsx(S,{className:"rounded-l-none",disabled:!e.getCanRedo(),icon:t.jsx(Va,{}),onPress:()=>{e.redo()}})]})});mt.displayName="track(UndoRedo)";const $a=8,A=({name:e,kbd:a})=>t.jsx("div",{className:"flex items-center gap-1",children:t.jsx("span",{children:e})});function qa(){const{t:e}=k(),{me:a}=Ft(),n=b(),s=gt(),r=Ga(),i=I("toolbar tools",()=>{const o=n.getCurrentPageShapes().find(te),l=async()=>{const c=n.getCurrentPageShapes().filter(ne);if(c.length)try{await Xe({title:e("generation:fill.editor.tool.inpaint.switch-confirm.title"),description:e("generation:fill.editor.tool.inpaint.switch-confirm.description")}),n.select(...new Set(c.flatMap(d=>La(n,d)))),setTimeout(()=>{n.zoomToSelection()},4)}catch{return!1}return!0};return[{id:"hand",name:t.jsx(A,{name:e("tool.hand"),kbd:"H"}),icon:$t},{id:"select",name:t.jsx(A,{name:e("tool.select"),kbd:"V"}),icon:ka},{id:"divider-select",type:"separator"},{id:"marker",name:t.jsx(A,{name:e("tool.marker.label"),kbd:"I"}),icon:ot,onClick:async()=>{await l()&&n.setCurrentTool("marker")}},{id:"marker-geo",name:t.jsx(A,{name:e("tool.marker-box.label"),kbd:"ctrl+I"}),icon:rt,onClick:async()=>{await l()&&n.setCurrentTool("marker-geo")}},{id:"marker-lasso",name:t.jsx(A,{name:e("tool.marker-lasso.label"),kbd:"shift+I"}),icon:ya,onClick:async()=>{await l()&&n.setCurrentTool("marker-lasso")}},{id:"marker-eraser",name:t.jsx(A,{name:e("tool.marker-eraser"),kbd:"ctrl+shift+I"}),icon:Sa,onClick:async()=>{await l()&&n.setCurrentTool("marker-eraser")}},{id:"outpaint",name:t.jsx(A,{name:e("generation:fill.editor.outpaint")}),icon:Ca,selected:!!n.getOnlySelectedShape()?.meta.pixai_outpaintFrameOf,disabled:!o,onClick:()=>Aa(n,o)},{id:"separator-marker",type:"separator"},{id:"set-base-image",name:t.jsx(A,{name:e("generation:fill.editor.tool.set-base-image.label")}),icon:oe,onClick:s},{id:"download-fill-modified",name:t.jsx(A,{name:e("generation:fill.editor.tool.download-modified.label")}),icon:Ia,disabled:!o,onClick:async()=>{const c=n.getShape(o.id);u(c,"base shape not found");const d=await za(n,c,{includeSelf:!0});u(d,"failed to render image"),ra(d,`pixai-fill-modified_${Date.now()}.png`);const p=c.meta.generationTask?.userId;le("image_dl",{scene:"generator-edit",authorId:p,isMyMedia:a?a.id===p:void 0})}},{id:"use-as-generator-base",name:t.jsx(A,{name:e("generation:image-operation.use-base-image")}),icon:qt,disabled:!o,onClick:()=>r(o)}]},[s,e,n]);return t.jsxs(xt,{mode:"popLayout",children:[t.jsx("div",{className:"z-[calc(var(--layer-canvas)+1)] absolute left-4 right-4 top-4 flex justify-center gap-4 pointer-events-none",children:t.jsx("div",{className:"flex items-center justify-center overflow-hidden rounded bg-zinc-50 dark:bg-zinc-800 shadow-lg pointer-events-auto",children:i.map(o=>t.jsx(ut,{tool:o},o.id))})},"tools"),t.jsx(dt,{},"cta"),t.jsx(Ba,{},"active-toolbox")]})}const ut=N(({tool:e,onClick:a})=>{const n=b(),s=n.getCurrentTool(),[r,i]=f.useState(!1),[o,l]=f.useState(!1);if(e.type==="separator")return t.jsx("div",{className:"w-px h-1/2 bg-zinc-400 dark:bg-zinc-600"});const c=p=>p.type==="tool-group"&&p.tools.some(g=>c(g))||!p.type&&p.selected===!0||s.id===p.id,d=()=>{if(!(e.disabled||e.type==="tool-group"))if(a?.(),e.onClick){const p=e.onClick();p instanceof Promise&&(l(!0),p.finally(()=>l(!1)))}else n.setCurrentTool(e.id)};return t.jsxs(sa,{isOpen:r,onOpenChange:i,children:[t.jsx(Se,{trigger:t.jsxs(S,{variant:"ghost",className:F("focus:outline-0 focus-visible:outline-2 disabled:opacity-60",c(e)&&"bg-blue-500 focus-within:bg-blue-400 hover:bg-blue-400 active:bg-blue-300 dark:focus-within:bg-blue-600 dark:hover:bg-blue-600 dark:active:bg-blue-700"),labelClassName:"relative flex h-10 px-3 justify-center items-center gap-2 dark:text-white",busy:o,disabled:e.disabled,onPress:d,children:[t.jsxs("div",{className:"inline-flex gap-2 items-center",children:[t.jsx(e.icon,{className:"size-4"}),e.withName&&t.jsx("span",{className:"text-xs",children:e.name})]}),e.type==="tool-group"&&t.jsx("div",{className:"absolute left-0 right-0 bottom-0 flex justify-center",children:t.jsx(ja,{className:F("size-4 opacity-50",r&&"rotate-180")})})]}),children:t.jsx("p",{className:"p-2",children:e.tooltip||e.name})},e.id),e.type==="tool-group"&&t.jsx(na,{children:t.jsx(ia,{children:({close:p})=>t.jsx("div",{className:"flex w-auto items-center justify-center overflow-hidden bg-zinc-50 dark:bg-zinc-800 p-0",children:t.jsx("div",{className:"flex max-w-80 flex-wrap",children:e.tools.map(g=>t.jsx(ut,{tool:g,onClick:p},g.id))})})})})]})});function gt(){const e=f.useContext(Ce),a=f.useRef();return f.useEffect(()=>{const n=window.document.createElement("input");n.type="file",n.accept="image/png,image/jpeg",a.current=n;async function s(r){const i=r.target.files;!i||i.length===0||(e.current.setBaseImageFromFile(i[0],{cate:"local"}),n.value="")}return n.addEventListener("change",s),()=>{a.current=void 0,n.removeEventListener("change",s)}},[e]),f.useCallback(()=>{a.current?.click()},[a])}function Ga(){const e=b(),{setValues:a}=Bt(),{dispatch:n}=f.useContext(Rt),[,s]=f.useContext(Ot),[,r]=f.useContext(Et),{data:{samplingMethods:i}={}}=_t();return f.useCallback(async o=>{const l=e.getShape(o.id);u(l,"base shape not found");const c=Date.now();if(l.type==="genmedia"&&l.meta.generationTask){const m=l.meta.generationTask,h=Vt(m),w=Ut({task:m,baseImageMedia:h?await Dt({id:h}).then(j=>j.data.media):void 0,allowedSamplingMethods:i});a(w)}ct(l);const d=new ee(l.x,l.y,l.props.w,l.props.h),p=e.getCurrentPageShapes().filter(m=>{const h=e.getShapeMaskedPageBounds(m);return h?d.includes(h):!1}).filter(m=>E(m)?m.props.isPaint:!0),g=[];e.visitDescendants(l,m=>{const h=e.getShape(m);if(!h)return!1;E(h)&&!h.props.isPaint&&g.push(h)}),g.length&&e.updateShapes(g.map(m=>({id:m.id,type:m.type,opacity:0})));try{if(p.length<=1){const m=await Me(e,l);u(m,"failed to get base image"),a(h=>({...h,baseImage:m}))}else{const m=await we(e,p.map(w=>w.id),"png",{bounds:d});u(m,"failed to render image");const h=new File([m],`pixai-fill-reference_${c}.png`,{type:"image/png"});a(w=>({...w,baseImage:z.fromFile(h)}))}}finally{g.length&&e.updateShapes(g.map(m=>({id:m.id,type:m.type,opacity:1})))}if(g.length){const m=await e.getSvg(g,{bounds:d,background:!1,padding:0});u(m,"failed to render inpaint shapes");const h=await it(m,$a,l.props.w,l.props.h),w=new File([h],`pixai-fill-mask_${c}.png`,{type:"image/png"}),j=await we(e,[...p.map(x=>x.id),...g.map(x=>x.id)],"png",{bounds:d});u(j,"failed to render preview");const C=new File([j],`pixai-fill-preview_${c}.png`,{type:"image/png"});a(x=>({...x,inpaintMaskImage:z.fromFile(w),previewImage:z.fromFile(C)}))}else a(m=>({...m,inpaintMaskImage:void 0,previewImage:void 0}));le("use_as_base_click",{scene:"fill"}),s([]),r(m=>({...m,dirty:!0})),n({type:"set-mode",value:Ht.Generate})},[e,i,s,r,n,a])}function Za(){const e=b();return I("currentPageShapeIds",()=>e.getCurrentPageShapeIds(),[e]).size>0?null:t.jsxs(t.Fragment,{children:[t.jsx(Ya,{}),t.jsx(Wa,{})]})}function Wa(){const{t:e}=k(),a=gt(),n=Qa();return t.jsx("div",{className:"z-[var(--layer-canvas)] absolute inset-0 grid place-items-center",children:t.jsxs("div",{className:"relative flex flex-col gap-10 p-16 text-base rounded-3xl border-2 border-neutral-200 dark:border-neutral-700 bg-background",children:[t.jsx("div",{className:"text-4xl font-light",children:e("generation:fill.editor.start.title")}),t.jsxs("div",{className:"flex flex-col gap-2 pr-20",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(S,{className:"p-4 w-48 h-48",size:"large",onPress:a,children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("div",{}),t.jsx(oe,{className:"size-16 text-neutral-500 dark:text-neutral-400"}),e("generation:fill.editor.start.choose")]})}),t.jsx(S,{className:"p-4 w-48 h-48",size:"large",onPress:n,children:t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("div",{}),t.jsx(wa,{className:"size-16 text-neutral-500 dark:text-neutral-400"}),e("generation:fill.editor.start.clipboard")]})})]}),t.jsx("div",{className:"text-sm",children:e("generation:fill.editor.start.drop-tip")})]}),t.jsx("div",{className:"absolute -bottom-5 -right-6",children:t.jsx(Gt,{expression:"happy",width:140,height:140})})]})})}function Ya(){const{t:e}=k();return t.jsx("div",{className:"z-[var(--layer-canvas)] absolute left-0 top-0 bottom-0 grid place-items-center",children:t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("p",{className:"flex-1 basis-0 flex items-end pl-6 whitespace-pre text-[var(--fg-color)] text-base rotate-3",children:e("generation:fill.editor.start.import-tip")}),t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"70",height:"35",viewBox:"0 0 70 35",className:"text-[color:rgb(var(--fg-color)/.75)]",children:[t.jsx("defs",{children:t.jsx("marker",{id:"arrow-head",orient:"auto",markerWidth:"6",markerHeight:"6",refX:"0",refY:"3",children:t.jsx("path",{d:"M 0 0 L 0 6 L 5.19 3 Z",fill:"currentColor"})})}),t.jsx("path",{id:"arrow-line",markerEnd:"url(#arrow-head)",strokeWidth:"2",fill:"none",stroke:"currentColor",d:"M 60 5 Q 56 25 15 25"})]}),t.jsx("div",{className:"flex-1 basis-0"})]})})}function Qa(){const{t:e}=k(),a=f.useContext(Ce);return f.useCallback(async()=>{try{const n=window.navigator.clipboard;if(!n)throw new Error("Clipboard API not supported");const s=await n.read();for(const r of s){const i=r.types.find(l=>["image/png","image/jpeg","image/webp"].includes(l));if(!i)continue;const o=await r.getType(i);a.current.setBaseImageFromFile(new File([o],`clipboard.${i.slice(6)}`,{type:i}),{cate:"clipboard"});return}R.error(e("generation:fill.editor.start.clipboard-no-image"))}catch(n){R.error(e("generation:fill.editor.start.clipboard-failed",{error:String(n)}))}},[a,e])}const Ka=e=>t.jsxs("svg",{viewBox:"0 0 512 512",width:"1.2em",height:"1.2em",...e,children:[t.jsx("path",{fill:"currentColor",d:"M256 112a56 56 0 1 1 56-56a56.06 56.06 0 0 1-56 56Z"}),t.jsx("path",{fill:"currentColor",d:"m432 112.8l-.45.12l-.42.13c-1 .28-2 .58-3 .89c-18.61 5.46-108.93 30.92-172.56 30.92c-59.13 0-141.28-22-167.56-29.47a73.79 73.79 0 0 0-8-2.58c-19-5-32 14.3-32 31.94c0 17.47 15.7 25.79 31.55 31.76v.28l95.22 29.74c9.73 3.73 12.33 7.54 13.6 10.84c4.13 10.59.83 31.56-.34 38.88l-5.8 45l-32.19 176.19q-.15.72-.27 1.47l-.23 1.27c-2.32 16.15 9.54 31.82 32 31.82c19.6 0 28.25-13.53 32-31.94s28-157.57 42-157.57s42.84 157.57 42.84 157.57c3.75 18.41 12.4 31.94 32 31.94c22.52 0 34.38-15.74 32-31.94a57.17 57.17 0 0 0-.76-4.06L329 301.27l-5.79-45c-4.19-26.21-.82-34.87.32-36.9a1.09 1.09 0 0 0 .08-.15c1.08-2 6-6.48 17.48-10.79l89.28-31.21a16.9 16.9 0 0 0 1.62-.52c16-6 32-14.3 32-31.93S451 107.81 432 112.8Z"})]}),Xa=e=>t.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e,children:t.jsxs("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,children:[t.jsxs("path",{strokeDasharray:16,strokeDashoffset:16,d:"M12 3c4.97 0 9 4.03 9 9",children:[t.jsx("animate",{fill:"freeze",attributeName:"stroke-dashoffset",dur:"0.3s",values:"16;0"}),t.jsx("animateTransform",{attributeName:"transform",dur:"1.5s",repeatCount:"indefinite",type:"rotate",values:"0 12 12;360 12 12"})]}),t.jsx("path",{strokeDasharray:64,strokeDashoffset:64,strokeOpacity:.3,d:"M12 3c4.97 0 9 4.03 9 9c0 4.97 -4.03 9 -9 9c-4.97 0 -9 -4.03 -9 -9c0 -4.97 4.03 -9 9 -9Z",children:t.jsx("animate",{fill:"freeze",attributeName:"stroke-dashoffset",dur:"1.2s",values:"64;0"})})]})}),Ja=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M12.5 3h-10A1.5 1.5 0 0 0 1 4.5v5A1.5 1.5 0 0 0 2.5 11h5a.5.5 0 0 1 .354.146L10 13.294V11.5a.5.5 0 0 1 .5-.5h2A1.5 1.5 0 0 0 14 9.5v-5A1.5 1.5 0 0 0 12.5 3m-10-1h10A2.5 2.5 0 0 1 15 4.5v5a2.5 2.5 0 0 1-2.5 2.5H11v2.5a.5.5 0 0 1-.854.354L7.293 12H2.5A2.5 2.5 0 0 1 0 9.5v-5A2.5 2.5 0 0 1 2.5 2",clipRule:"evenodd"})}),es=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M7.5 9.125a1.625 1.625 0 1 0 0-3.25a1.625 1.625 0 0 0 0 3.25m0 1a2.625 2.625 0 1 0 0-5.25a2.625 2.625 0 0 0 0 5.25",clipRule:"evenodd"})}),ts=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 2.5a.5.5 0 0 1 .5-.5h5.586a.5.5 0 0 1 .353.146l2.415 2.415a.5.5 0 0 1 .146.353V12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5zM3.5 1A1.5 1.5 0 0 0 2 2.5v10A1.5 1.5 0 0 0 3.5 14h8a1.5 1.5 0 0 0 1.5-1.5V4.914a1.5 1.5 0 0 0-.44-1.06l-2.414-2.415A1.5 1.5 0 0 0 9.086 1zm1 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1z",clipRule:"evenodd"})}),Be=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M11 1.5a.5.5 0 0 0-1 0V4H5V1.5a.5.5 0 0 0-1 0V4H1.5a.5.5 0 0 0 0 1H4v5H1.5a.5.5 0 0 0 0 1H4v2.5a.5.5 0 0 0 1 0V11h5v2.5a.5.5 0 0 0 1 0V11h2.5a.5.5 0 0 0 0-1H11V5h2.5a.5.5 0 0 0 0-1H11zM10 10V5H5v5z",clipRule:"evenodd"})}),as=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M12.146 1.146a.5.5 0 0 1 .707 0l2 2a.5.5 0 0 1 0 .708l-3.942 3.942a1 1 0 0 1-.26.188L6.724 9.947a.5.5 0 0 1-.671-.67l1.963-3.928a1 1 0 0 1 .188-.26zm.354 1.061l-3.59 3.59l-1.037 2.076l.254.254l2.077-1.038L13.793 3.5zM10 2L9 3H4.9c-.428 0-.72 0-.944.019c-.22.018-.332.05-.41.09a1 1 0 0 0-.437.437c-.04.078-.072.19-.09.41C3 4.18 3 4.472 3 4.9v6.2c0 .428 0 .72.019.944c.018.22.05.332.09.41a1 1 0 0 0 .437.437c.078.04.19.072.41.09c.225.019.516.019.944.019h6.2c.428 0 .72 0 .944-.019c.22-.018.332-.05.41-.09a1 1 0 0 0 .437-.437c.04-.078.072-.19.09-.41c.019-.225.019-.516.019-.944V7l1-1v5.12c0 .403 0 .735-.022 1.006c-.023.281-.072.54-.196.782a2 2 0 0 1-.874.874c-.243.124-.501.173-.782.196c-.27.022-.603.022-1.005.022H4.88c-.403 0-.735 0-1.006-.022c-.281-.023-.54-.072-.782-.196a2 2 0 0 1-.874-.874c-.124-.243-.173-.501-.196-.782C2 11.856 2 11.523 2 11.12V4.88c0-.403 0-.735.022-1.006c.023-.281.072-.54.196-.782a2 2 0 0 1 .874-.874c.243-.124.501-.173.782-.196C4.144 2 4.477 2 4.88 2z",clipRule:"evenodd"})}),ss=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M3.95 2.95V4.5a.45.45 0 0 1-.9 0v-2a.45.45 0 0 1 .45-.45h8a.45.45 0 0 1 .45.45v2a.45.45 0 1 1-.9 0V2.95h-3v9.1h1.204a.45.45 0 0 1 0 .9h-3.5a.45.45 0 1 1 0-.9H6.95v-9.1z",clipRule:"evenodd"})}),ns={frame:Be,geoframe:Be,text:ss,geo:rt,image:oe,genmedia:oe,draw:ot,marker:as,dialogue:Ja,pose:Ka},is=({shape:e,showIcon:a,contentClassName:n})=>{const{t:s}=k(),r=b(),i=f.useMemo(()=>{if(e.meta.isPageFrame)return t.jsx(ts,{className:"m-1 mr-3 size-6 shrink-0"});try{if(e.type==="genmedia"){const c=e;if(c.props.pending)return t.jsx("div",{className:"mr-2 flex size-8 shrink-0 items-center justify-center",children:t.jsx(Xa,{className:"size-5 shrink-0"})});u(c.props.currentAssetId,"GenMedia shape must have a currentAssetId");const d=r.getAsset(c.props.currentAssetId);return u(d,"Asset not found"),u(d.props.src,"Asset must have a src"),t.jsx(Se,{placement:"right",trigger:t.jsx("img",{src:d.props.src,className:"mr-2 size-8 shrink-0 object-cover",alt:""}),children:t.jsx("img",{src:d.props.src,className:"h-full w-40 rounded-sm",alt:""})})}}catch(c){console.warn("Failed to render genmedia icon. Falling back to default.",c)}const l=ns[e.type];return l?t.jsx(l,{className:"m-2 mr-4 size-4 shrink-0"}):t.jsx(es,{className:"mr-2 size-8 shrink-0"})},[e]),o=f.useMemo(()=>{if(e.type==="genmedia"){const d=e;return d.props.isInpaint?`[${s("shape.genmedia.inpaint")}] ${d.props.prompts}`:d.props.prompts?`[${s("shape.genmedia")}] ${d.props.prompts}`:"Generated"}if(e.type==="marker")return s("tool.marker");if(e.type==="marker-lasso")return s("tool.marker-lasso");if(e.type==="marker-geo")return s("tool.marker-box");if(e.type==="genbox"){const d=e;return`${s("tool.genbox.label")} (${d.props.w}x${d.props.h})`}if(e.type==="geo")return s("tool."+e.props.geo);if(e.type==="frame"&&e.meta.pixai_outpaintFrameOf)return s("generation:fill.editor.tool.outpaint.name");const l=e.props;if(l.text)return l.text;if(l.name)return l.name;const c=s("tool."+e.type);return c||Zt(e.type)},[e,s]);return t.jsxs("div",{className:"flex w-full items-center",children:[a&&i,t.jsx("div",{className:F("shrink truncate overflow-ellipsis whitespace-normal text-xs",n),children:o})]})},rs=e=>t.jsx("svg",{viewBox:"0 0 15 15",width:"1.2em",height:"1.2em",...e,children:t.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"M6.854 3.146a.5.5 0 0 1 0 .708L3.707 7H12.5a.5.5 0 0 1 0 1H3.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708 0",clipRule:"evenodd"})});function os({shape:e}){const a=b(),n=e.props.assetIds.length,s=e.props.currentAssetId,r=e.props.assetIds.findIndex(o=>o===s),i=o=>{const l=e.props.assetIds[o];a.updateShape({id:e.id,type:"genmedia",props:{currentAssetId:l}})};return n>1?t.jsxs("div",{className:"flex items-center justify-center gap-2 p-1 w-64 h-10 rounded bg-background shadow-lg",children:[t.jsx(S,{className:"size-8 p-0",variant:"ghost",onPress:()=>i((r-1+n)%n),children:t.jsx(rs,{className:"size-4"})}),t.jsxs("div",{className:"flex-1 px-8 text-center text-sm tabular-nums",children:[r+1," / ",n]}),t.jsx(S,{className:"size-8 p-0",variant:"ghost",onPress:()=>i((r+1)%n),children:t.jsx(la,{className:"size-4"})})]}):null}const ls=()=>{const e=b(),a=I("selectedShapes",()=>e.getSelectedShapes(),[e]);return I("should display toolbar",()=>e.isInAny("select.idle","select.brushing","select.scribble_brushing","select.editing_shape","select.pointing_shape","select.pointing_selection","select.pointing_handle")&&!e.getInstanceState().isChangingStyle,[e])&&a.length?t.jsxs(t.Fragment,{children:[t.jsx(ie,{type:"top",shape:a[0],children:t.jsx(cs,{shapes:a})}),t.jsx(ie,{type:"bottom",shape:a[0],children:t.jsx(ps,{shapes:a})})]}):null};function cs({shapes:e}){const a=e[0],n=Na(e);return t.jsxs("div",{className:"flex items-center justify-center gap-0.5 mb-2 p-0.5 min-w-60 max-w-[44rem] h-9 rounded-md bg-background shadow-lg",children:[t.jsx("div",{className:"ml-2 min-w-48 max-w-60",children:t.jsx(is,{shape:a,contentClassName:"line-clamp-1"})}),t.jsx("div",{className:"flex-1"}),n.map(s=>t.jsx(ds,{...s},s.label))]})}const ds=e=>{const a=b();return t.jsx(Se,{placement:"top",trigger:t.jsx(S,{variant:"ghost",className:"size-8 p-2",onPress:async()=>{await e.onClick(),a.getContainer().focus()},disabled:e.disabled,children:t.jsx(e.Icon,{className:"size-4 text-zinc-800 dark:text-inherit"})},e.label),children:t.jsx("p",{className:"p-2",children:e.label})})},ps=N(({shapes:e})=>{const a=e[0];return e.length===1&&a.type==="genmedia"?t.jsx(os,{shape:a}):null});function Hs(){const e=f.useContext(Ce),a=f.useMemo(()=>St(),[]),n=s=>{const{meta:r}=s.getDocumentSettings();r?.initialized===void 0&&(s.user.updateUserPreferences({isDarkMode:!1,isSnapMode:!0}),s.updateInstanceState({isGridMode:!0}),s.updateDocumentSettings({gridSize:8,meta:{initialized:!0}})),e.current.editor=s};return f.useEffect(()=>()=>{e.current.editor=null},[e]),t.jsx(aa,{i18n:Z,children:t.jsxs(Ct,{className:"focus-within:outline-none",assetUrls:a,onMount:n,overrides:{contextMenu:()=>[]},hideUi:!0,components:{Background:()=>t.jsx("div",{className:"z-[var(--layer-background)] absolute inset-0 bg-background"}),Spinner:()=>t.jsx(at,{inline:!0}),LoadingScreen:ms,ErrorFallback:s=>t.jsx(Le,{...s}),ErrorScreen:({children:s})=>t.jsx(Le,{error:s})},children:[t.jsx(fs,{}),t.jsx(Za,{}),t.jsx(xa,{}),t.jsx(ls,{}),t.jsx(qa,{})]})})}function ms(){return t.jsx("div",{className:"grid place-items-center h-full",children:t.jsx(at,{})})}const us=()=>{const{i18n:e}=k(),a=b();f.useEffect(()=>{const n=()=>{const s=O.find(r=>r.locale===e.language)?.tldrawLocale;u(s,`unsupported locale: ${e.language}`),a.user.updateUserPreferences({locale:s})};return n(),e.on("languageChanged",n),()=>{e.off("languageChanged",n)}},[a,e])};function gs(e){switch(e){case"pending":return"Waiting...";case"completed":return"Finalizing...";case"failed":return null;case"running":return"Generating...";case"waiting":return"Waiting...";default:return"[Unknown]"}}const hs=()=>{const e=b(),{data:a}=Ie(),n=Wt();f.useEffect(()=>{if(!a)return;const s=async r=>{const i=e.getCurrentPageShapes().filter(o=>o.type==="genmedia");for(const o of r){const l=i.find(c=>c.props.pending!==null&&c.meta.generationTask?.id===o.id);if(l)if(o.status==="completed"){const c=await Xt(e,o);e.updateShape({id:l.id,type:"genmedia",props:{currentAssetId:c[0],assetIds:c,pending:null},meta:{generationTask:o}},{ephemeral:!0})}else o.status==="failed"?e.updateShape({id:l.id,type:"genmedia",props:{pending:null,alert:"Generation Failed"}},{ephemeral:!0}):o.status!=="running"&&o.status!=="waiting"?e.updateShape({id:l.id,type:"genmedia",props:{pending:null,alert:"Unknown Status: "+o.status}},{ephemeral:!0}):e.updateShape({id:l.id,type:"genmedia",props:{pending:gs(o.status)},meta:{generationTask:o}},{ephemeral:!0})}};if(n){const r=Yt.subscribe(i=>{s([i])});return()=>{r.unsubscribe()}}else{const r=window.setInterval(async()=>{const i=await Qt({last:30,parameterFields:Kt}),o=Nt(i.data?.me?.tasks?.edges?.map(l=>l?.node));s(o)},5e3);return()=>window.clearInterval(r)}},[a,e,n])},fs=()=>{Mt(),Tt(),us(),hs();const e=b();return f.useEffect(()=>{function a({name:n,count:s}){R.error(`You've reached the maximum number of shapes allowed on ${n} (${s}). Please delete some shapes or move to a different page to continue.`)}return e.addListener("max-shapes",a),()=>{e.removeListener("max-shapes",a)}},[e]),f.useEffect(()=>{function a(){for(const r of e.getSelectedShapes()){const i=r;if(te(i)&&!e.getShapeParent(i)&&!(i.type==="genmedia"&&i.meta.generationTask&&i.meta.generationTask.status!=="completed")){if((i.x!==0||i.y!==0||i.rotation)&&(e.updateShape({id:i.id,type:i.type,x:0,y:0,rotation:void 0},{squashing:!0}),e.getShapeParent(i.id)?.meta.pixai_outpaintFrameOf!==i.id)){const l=e.getCurrentPageShapes().find(c=>c.type==="frame"&&c.meta.pixai_outpaintFrameOf===i.id);l&&e.updateShape({id:i.id,type:i.type,parentId:l.id,x:0,y:0})}const o=i.type==="genmedia"?i.props.currentAssetId:i.props.assetId;if(o){const l=e.getAsset(o);if(l&&(i.props.w!==l.props.w||i.props.h!==l.props.h)){if(e.isIn("select.resizing")&&!e.getCurrentPageShapes().find(E)){const c=lt(e,i),p=e.getCurrentTool().getCurrent().info;e.getCurrentTool().transition("idle").transition("resizing",p),e.updateShape({id:c,type:"frame",props:{w:l.props.w,h:l.props.h}},{squashing:!0})}e.updateShape({id:i.id,type:i.type,x:0,y:0,props:{w:l.props.w,h:l.props.h}},{squashing:!0})}}}i.meta.pixai_outpaintFrameOf&&(e.getShape(i.meta.pixai_outpaintFrameOf)||e.deleteShape(i.id))}const{erasingShapeIds:n}=e.getCurrentPageState(),s=n.filter(r=>!e.getShape(r)?.meta.pixai_isBaseImage);s.length!==n.length&&e.setErasingShapes(s)}return e.addListener("change",a),()=>{e.removeListener("change",a)}},[e]),null};export{fs as TldrawSideEffect,Hs as default};
