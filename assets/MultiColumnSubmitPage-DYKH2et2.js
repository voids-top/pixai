const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/index-Bs1mJZf-.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-motion-Bl2lDopP.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-apollo-B9XqHIAo.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-graphql-DeSYh9DC.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-amplitude-core-CQMkGYFj.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-tldraw-CaaMemrL.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-axios-CFwfAwt2.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-lodash-992l3ZN7.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-firebase-BKQqa5bK.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-fabric-Bg02ktlP.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-radix-ui-DX5JiNHB.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-mui-DTp04zm4.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-i18next-TC5y0B3W.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-tldraw-DkB09obf.css","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/index-JhqgbpkX.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-react-router-Bm0RsDwP.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-sentry-BZZLy1DV.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-react-aria-BW9JtD2p.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-markdown-1uD3znr6.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/i18n-resources-43uzMSBc.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-hls-cbDBXQj9.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-photoswipe-UqzIRFho.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/vendor-photoswipe-Nx4y_V0V.css","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/index-Cxs7Cmj3.css","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/download-BM-WjQMK.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/LCMRealtime-hph6rUCz.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/objectDestructuringEmpty-YVl7faCL.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/baseline-arrow-downward-zIQhHbGH.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/GenerationModeNavigation-BeGzJJIs.js","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/LCMRealtime-Dzzp4BTj.css","https://cdn.pixai.art/artifacts/app-0ec442be81a4ee21bfcf5745e8ef10bc76836958/assets/arrow-right-DJCRfyiv.js"])))=>i.map(i=>d[i]);
import{j as e,A as Ns,m as Is}from"./vendor-motion-Bl2lDopP.js";import{r as c,s as se}from"./vendor-apollo-B9XqHIAo.js";import{dU as ea,dH as ta,p as w,m as E,T as I,U as V,gN as sa,gO as na,gP as aa,dK as yt,fd as He,dY as Ne,P as ue,gQ as Ie,aG as kt,bN as be,gR as wt,gj as Pe,fc as Ct,fj as Ss,eS as Nt,gS as It,gT as ia,a as Y,aD as Ms,gU as oa,l as St,gV as ra,t as D,bk as ns,dP as la,dM as ca,ag as Ge,gW as da,bq as _s,gX as Mt,dS as Ts,dT as Ps,gY as z,gZ as Ke,g_ as _t,g$ as he,dy as de,h0 as Je,h1 as Ls,h2 as ma,h3 as Es,fn as As,gu as ua,h4 as Ds,h5 as ha,h6 as M,aL as ga,h7 as fa,h8 as xa,h9 as as,fu as pa,ha as ba,dB as ja,hb as qe,hc as va,dx as Ye,hd as ya,dZ as ka,aC as wa,d_ as Ca,dW as Na,fL as we,G as me,he as Rs,hf as W,hg as Ia,hh as X,hi as Q,hj as Z,cB as Fs,hk as Os,b3 as Xe,aP as Vs,hl as Sa,gt as ae,hm as Ma,hn as Tt,ce as Bs,ho as zs,ap as _a,hp as Pt,ab as ht,hq as Lt,at as Ta,hr as Qe,hs as is,ak as Ws,dE as $s,ht as Pa,hu as La,fH as Ea,hv as Aa,hw as Us,b as ie,hx as Da,hy as gt,aF as Ze,fG as Ra,hz as Fa,hA as Oa,aV as et,aT as Hs,ci as Gs,hB as Va,hC as Ba,hD as za,aj as Ks,hE as Wa,hF as $a,hG as Ua,hH as Ha,hI as Ga,hJ as Ka,u as Le,b7 as os,hK as tt,cg as Ja,hL as qa,hM as Ya,hN as Xa,b0 as Qa,hO as Za,bZ as ei,hP as ti,hQ as si,hR as ni,hS as ai,hT as ii,cf as oi,c2 as ri,b5 as Js,hU as li,eE as ci,cz as di,L as qs,hV as ft,hW as Ys,hX as Xs,hY as mi,aN as ui,c7 as hi,ch as gi,c3 as fi,b6 as xi,c8 as pi,bu as bi,hZ as ji,h_ as vi,h$ as rs,i0 as ls,i1 as yi,i2 as Qs,i3 as ki,i4 as wi,i5 as oe,i6 as Ci,i7 as Ni,i8 as Ii,i9 as Si,ia as Mi,ib as _i,ic as Ti,id as Pi,ie as Li,e0 as Zs,e3 as Re,ig as Fe,gq as Me,ih as ve,e1 as ot,ii as rt,ij as Ei,ik as en,gi as fe,il as Ai,gh as Di,e6 as Ri,im as Fi,io as tn,ip as Oi,iq as cs,fI as Vi,ir as sn,is as Bi,it as zi,b1 as nn,iu as Wi,iv as $i,al as Ui,iw as Hi,a9 as an,ix as Gi,iy as Ki,iz as Ji,aE as on,iA as rn,c5 as qi,iB as Yi,iC as ln,iD as Et,dg as cn,iE as dn,iF as Xi,iG as Qi,iH as Zi,k as eo,ac as to,iI as At,iJ as so,iK as no,iL as ao,iM as io,iN as oo,a_ as mn,iO as ro,ez as lo,iP as co,iQ as mo,bm as ds,iR as uo,iS as ho,iT as go,iU as Dt,iV as fo,iW as un,fi as hn,bO as xo,iX as po,iY as bo,fo as jo,cW as gn,c4 as vo,iZ as yo,i_ as ko,i$ as wo,j0 as Co,j1 as No,j2 as _e,j3 as Io,j4 as So,aQ as Mo,j5 as _o,j6 as To,j7 as Po,j8 as Lo,j9 as Rt,fe as Eo,ja as fn,jb as xn,jc as Ao,jd as pn,je as Do,jf as Ft,jg as Ro,jh as Fo,ji as Oo,jj as bn,jk as Vo,jl as Bo,ca as ye,jm as zo,jn as Wo,jo as $o,jp as Uo,jq as Ho,jr as Go,js as Ko,cD as ms,br as Jo,jt as qo,ju as Yo,D as Xo,ev as lt,bl as us,jv as Qo,jw as Zo,jx as er,M as tr,jy as sr,dv as nr}from"./index-JhqgbpkX.js";import{z as ar,Q as Ot,P as Vt,O as Te,R as Ee,B as ir,A as xt,n as or,C as rr,S as lr,Z as cr,$ as ct,s as dr,c as mr,j as ur,a2 as hr,a3 as jn,a4 as pt,i as gr}from"./vendor-react-aria-BW9JtD2p.js";import{C as fr}from"./GenerationModeNavigation-BeGzJJIs.js";import{b as Bt,P as vn,K as yn,h as zt,e as xr,N as A,$ as st,k as pr,u as kn,W as wn,G as ee,a as br,g as jr}from"./vendor-firebase-BKQqa5bK.js";import{M as vr,a as yr,u as kr}from"./index-DDDieZ2E.js";import{T as wr}from"./TaskPublishDialog-C6g-yNPm.js";import{u as k,T as Cr}from"./vendor-i18next-TC5y0B3W.js";import{B as O,d as Nr,C as Ir,I as H,D as Cn,b as Sr,e as Nn,g as In,O as Mr,Q as Wt,Y as Se,H as bt,h as Sn,j as _r,v as Tr,q as Mn,Z as xe,F as _n,a0 as Pr,aa as Lr,ap as Er,ag as Ar,ah as Tn,x as Dr,ae as Pn,af as Ln,ab as je,a9 as hs,aq as Rr}from"./vendor-mui-DTp04zm4.js";import{i as Fr}from"./outline-download-B1qcKnqG.js";import{C as Or,a as Vr}from"./vendor-axios-CFwfAwt2.js";import{g as $t}from"./rand-CeqwHrxf.js";import{E as Br,h as zr,m as Wr,B as $r,i as En,a as An,p as Ur,g as Hr,L as Gr,N as Kr,b as Jr,C as qr}from"./LCMRealtime-hph6rUCz.js";import{f as F}from"./vendor-fabric-Bg02ktlP.js";import{L as Dn,j as Yr,d as Xr,c as Qr}from"./vendor-react-router-Bm0RsDwP.js";import{N as Zr}from"./TrainLoraEvent-YJOi9HOY.js";import{g as ne}from"./vendor-graphql-DeSYh9DC.js";import{L as U,D as te,d as el,N as Ut,a as Rn,M as tl}from"./LoraSelectContext-DhHbgVG-.js";import{D as pe,q as Fn,g as Ht,p as sl}from"./vendor-lodash-992l3ZN7.js";import{i as nl}from"./baseline-delete-Dbq3-3Bm.js";import{_ as al}from"./vendor-amplitude-core-CQMkGYFj.js";import"./vendor-sentry-BZZLy1DV.js";import"./vendor-markdown-1uD3znr6.js";import"./i18n-resources-43uzMSBc.js";import"./vendor-hls-cbDBXQj9.js";import"./vendor-tldraw-CaaMemrL.js";import"./vendor-radix-ui-DX5JiNHB.js";import"./vendor-photoswipe-UqzIRFho.js";import"./objectDestructuringEmpty-YVl7faCL.js";import"./baseline-arrow-downward-zIQhHbGH.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t.SENTRY_RELEASE={id:"0ec442be81a4ee21bfcf5745e8ef10bc76836958"}}catch{}})();try{(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},s=new t.Error().stack;s&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[s]="3a660355-da75-4428-898d-73af9506a82c",t._sentryDebugIdIdentifier="sentry-dbid-3a660355-da75-4428-898d-73af9506a82c")})()}catch{}(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t._sentryModuleMetadata=t._sentryModuleMetadata||{},t._sentryModuleMetadata[new t.Error().stack]=function(s){for(var n=1;n<arguments.length;n++){var a=arguments[n];if(a!=null)for(var i in a)a.hasOwnProperty(i)&&(s[i]=a[i])}return s}({},t._sentryModuleMetadata[new t.Error().stack],{"_sentryBundlerPluginAppKey:pixai-web-app-key":!0})}catch{}})();const Gt=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M4 15V9h8V4.16L19.84 12L12 19.84V15H4Z"})});function jt(t){return e.jsx(ea,{children:e.jsx(il,{...t})})}function il(t){const s=ta(t.group),n=c.useCallback(({open:a})=>e.jsx(ol,{open:a,...t}),[t]);return e.jsxs("div",{className:w("flex flex-col justify-center bg-background overflow-y-auto relative",t.className),style:t.style,children:[e.jsx(vr,{group:t.group,wrapperProps:{className:w("py-8 !cursor-default mlg:!cursor-pointer",s&&"hidden")},uploadTrigger:n,maxAllowedMedia:1,dropzoneOpts:{noClick:!0},onUploadSuccess:()=>{E("panel_image_import",{scene:t.trackingScene,cate:"local"})}}),s&&e.jsxs("div",{className:"w-full flex flex-col items-center justify-center mlg:justify-between h-full p-4 gap-2",children:[e.jsx("p",{children:e.jsx(I,{i18nKey:"generation:enhance-image.image-select.selected-title"})}),e.jsx(yr,{group:t.group,wrapperProps:{className:"bg-neutral-100 dark:bg-neutral-700 flex-none rounded-lg max-h-[calc(100%-12px)] max-w-full w-fit h-fit min-h-0"},imgProps:{className:"max-mlg:max-h-[max(calc(50vh-132px),320px)] max-mlg:w-full max-h-full max-w-full object-contain rounded-lg mx-auto"},usePublicUrl:!0}),e.jsx("div",{className:"hidden mlg:block h-[1lh]"}),e.jsx(Gt,{className:"mlg:hidden size-8 text-gray-300 dark:text-gray-700 rotate-90 self-center"})]})]})}function ol(t){const{open:s,...n}=t;return e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"pt-1 hidden mlg:block",children:e.jsx(I,{i18nKey:"generation:enhance-image.image-select.import-from-tasks"})}),e.jsx("p",{className:"hidden mlg:block",children:e.jsx(I,{i18nKey:"generation:enhance-image.image-select.select-to-upload"})}),e.jsx(rl,{...n,trigger:a=>e.jsx(V,{variant:"outlined",className:"mlg:hidden rounded-full font-medium",onPress:()=>{E("generator_tab_select_task_history_click",{scene:t.trackingScene}),a()},children:e.jsx(I,{i18nKey:"generation:enhance-image.image-select.select-from-task"})})}),e.jsx(V,{variant:"outlined",className:"rounded-full font-medium",onPress:()=>{s()},children:e.jsx(I,{i18nKey:"generation:enhance-image.image-select.upload-image"})})]})}function rl(t){const s=document.getElementById("workbench-layout-overlays"),n=c.useCallback(({onClose:a,item:i})=>{i.media&&(E("panel_image_import",{scene:t.trackingScene,cate:"task"}),t.onImageSelect?.(i)),a()},[t.onImageSelect]);return e.jsx(sa,{onSelectItem:n,enableBatchMediaSelect:!0,trigger:({onOpen:a})=>t.trigger(a),DrawerProps:{container:s}})}const Ae=yn(),On=Bt({}),ll=t=>vn({children:t.children,store:Ae}),Vn=Bt({selectedPresetPlugin:"handfix",extraArgs:{}});function Bn(){return na(Vn,{store:Ae})}function cl(){return zt(Vn,{store:Ae})}function dl(){return aa(On,{store:Ae})}function ml(){return zt(On,{store:Ae})}function ul(){const t=yt(),{lastResultTaskId:s}=ml(),{data:n}=He(s??se),a=n?.parameters?.inputs?.image.media_id,{data:i}=Ne(a??se),o=n?.media,r=i?.width&&i.height?{width:i.width,height:i.height}:void 0,l=a===t[0],d=c.useRef(null),{t:m}=k();return e.jsx("div",{className:"bg-background dark:border-neutral-700 flex w-full overflow-y-auto",children:s?e.jsxs("div",{className:"w-full flex flex-col mlg:justify-between mlg:h-full p-4 gap-2",children:[e.jsx(wr,{ref:d,scene:"generator-enhance"}),e.jsx("p",{className:"self-center",children:e.jsx(I,{i18nKey:"generation:enhance-image.result.result-title"})}),n?o?e.jsxs("div",{className:"relative self-center",children:[e.jsx(Ie,{id:n.id,originalUrl:kt(n.media),thumbnailUrl:be(n.media),fileName:`${wt({task:n})}.${Pe({task:n})}`,imgClassName:w("rounded-lg max-mlg:max-h-[max(calc(50vh-132px),320px)]",!l&&"opacity-50"),scene:"generator-enhance"}),n?.status==="completed"&&e.jsx(O,{variant:"contained",className:"px-3 absolute bottom-2 left-2",onClick:()=>d.current?.open(n),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ct,{className:"size-5"}),m("artwork:publish")]})})]}):e.jsx(Ss,{className:w("rounded-lg max-mlg:w-[max(calc(50vh-132px),320px)] max-mlg:self-center",!r&&"w-full h-full"),id:n?.id,status:n.status,contentStyleProps:{className:w("rounded-lg",!r&&"py-8"),style:r?{aspectRatio:(r.width??1)/(r.height??1)}:void 0}}):e.jsx(ue,{}),e.jsx("div",{className:"hidden mlg:block h-[1lh]"})]}):e.jsx("p",{className:"text-center w-full py-8 text-2xl text-neutral-400 my-auto",children:e.jsx(I,{i18nKey:"generation:enhance-image.result.display-placeholder"})})})}function hl(t){const{plugin:s,events:n,isMember:a}=t;if(!n)return null;const o=(s?n.filter(r=>r.workflows?.includes(s.workflowName)):[])[0];return o&&o.userType==="member"&&a?o:null}function gl(t){if(t)return[t.workflowName,t.workflowVersion].join(":")}function fl(){const{data:t}=It(),{data:s,mutate:n}=ia(),{t:a}=k(["generation"]),{data:i}=Y(),o=Ms(i),r=yt()[0],l=r?.startsWith("upload")?void 0:r,d=dl(),{selectedPresetPlugin:m,extraArgs:u}=cl(),h=c.useMemo(()=>{const y=t&&m?t[m]:Object.values(t??{})[0];return{workflowName:gl(y),inputs:{image:{type:"media",media_id:l},...u},model:"pixai-panelplugin"}},[t,m,l,u]),{data:g,isValidating:v}=oa(h),[f,x]=St(async()=>{try{E("enhance_generate_click",{cate:m});const y=await ra({parameters:h});d(C=>{C.lastResultTaskId=y.data?.createGenerationTask?.id}),n(),D.success(a("generation:submit.notice.task-submitted"))}catch(y){D.error(y.message)}},[h,m]),p=hl({events:s,plugin:t?.handfix,isMember:o}),b=p!=null&&p.countRemains>0;return e.jsxs(ar,{onSubmit:y=>y.preventDefault(),className:"overflow-auto bg-background mlg:border-l mlg:border-t max-mlg:sticky max-mlg:bottom-0 max-mlg:max-h-[50vh] dark:border-neutral-700",children:[e.jsx(xl,{}),e.jsx("div",{className:"sticky bottom-0 p-4 bg-background/80 border-t border-zinc-800/10 dark:border-white/10 backdrop-blur-lg",children:e.jsx(V,{disabled:!l,busy:f.loading,onPress:()=>{x()},color:"theme",variant:"filled",className:"w-full rounded-lg items-center font-semibold px-4 h-auto py-2",labelClassName:"w-full items-center justify-center gap-2",children:e.jsxs("p",{className:"flex gap-1 items-center mx-auto w-fit",children:[a(b?"generation:submit.free-generation.label":"generation:submit.lets-go.label"),i&&!b&&e.jsx(ns,{iconClassName:"",children:e.jsx(la,{value:g?.actualPrice??0,loading:v,className:"!text-inherit font-normal",iconClassName:"hidden",valueClassName:"text-xs"})}),i&&b&&e.jsxs(ns,{children:[e.jsx("span",{className:"font-bold",children:p?.countRemains}),"/",e.jsx("span",{className:"text-xs",children:a("generation:submit.free-generation.remaining-times",{remaining:p.countTotal})})]})]})})})]})}const gs=Nt({base:["relative -mb-px p-2 text-sm text-center cursor-default","after:absolute after:inset-x-0 after:-bottom-1 after:h-0.5 after:bg-black dark:after:bg-white"],variants:{selected:{true:"",false:"after:hidden"},disabled:{true:"text-black/50 dark:text-white/50"}}});function xl(){return e.jsxs(Ot,{children:[e.jsxs(Vt,{className:"flex *:flex-1 px-4 py-1 border-b border-black/10 dark:border-white/10",children:[e.jsx(Te,{id:"preset",className:({isSelected:t,isDisabled:s})=>gs({selected:t,disabled:s}),children:e.jsx(I,{i18nKey:"generation:enhance-image.parameters.tabs.preset.label"})}),e.jsxs(Te,{id:"custom",isDisabled:!0,className:({isSelected:t,isDisabled:s})=>gs({selected:t,disabled:s}),children:[e.jsx(I,{i18nKey:"generation:enhance-image.parameters.tabs.custom.label"}),e.jsx("span",{className:"ml-2 inline-block px-1.5 text-[10px] leading-4 uppercase tracking-wide text-neutral-500 dark:text-neutral-400 bg-zinc-200 dark:bg-zinc-700 rounded-full",children:"Coming soon"})]})]}),e.jsx(Ee,{id:"preset",children:e.jsx(bl,{})})]})}const pl=Nt({slots:{root:"flex flex-col items-center gap-2 outline-none group",image:"w-full aspect-square rounded-lg",label:"-mb-1 text-center"},variants:{skeleton:{true:{image:"bg-black dark:bg-white animate-pulse"},false:{image:"group-data-[selected]:outline outline-2 outline-offset-2 outline-theme-primary"}}},defaultVariants:{skeleton:!1}});function bl(){const{data:t,isLoading:s,mutate:n}=It(),a=Object.entries(t??{}).map(([l,d])=>({id:l,...d})),[i,o]=Bn(),r=pl();return e.jsxs(Ot,{selectedKey:i.selectedPresetPlugin,onSelectionChange:l=>o(d=>{const m=l;d.selectedPresetPlugin=m,d.extraArgs=vl(t[m])}),children:[e.jsx("div",{className:"relative grid grid-cols-[repeat(auto-fill,minmax(72px,1fr))] gap-4 p-4 border-b border-black/10 dark:border-white/10",children:s||!a.length?e.jsxs(e.Fragment,{children:[Array.from({length:3}).map((l,d)=>e.jsxs("div",{className:r.root({className:!s&&!a.length&&"invisible"}),style:{opacity:.3-.3/3*d},children:[e.jsx("div",{className:r.image({skeleton:!0})}),e.jsx("p",{className:r.label({className:"prepend-zws"})})]},`skeleton-${d}`)),!s&&!a.length&&e.jsxs("div",{className:"absolute inset-0 grid place-content-center place-items-center",children:[e.jsx("p",{children:e.jsx(I,{i18nKey:"generation:enhance-image.messages.load-plugin-list-failed"})}),e.jsx(V,{variant:"ghost",className:"h-7 px-2",onPress:()=>void n(),children:e.jsx(I,{i18nKey:"action:retry.label"})})]})]}):e.jsx(Vt,{items:a,className:"contents",children:l=>e.jsxs(Te,{className:r.root({className:"relative"}),children:[e.jsx("img",{src:l.image,alt:"",className:r.image()}),e.jsx("p",{className:r.label(),children:e.jsx(I,{i18nKey:l.label})}),xr({new:A.union(!0,A.intersection(A.string.minLength(20),A.when(d=>Nr().isSameOrBefore(d,"second"))))},l)&&e.jsx(ca,{className:"absolute -top-1 -right-1"})]})})}),e.jsx(jl,{pluginName:i.selectedPresetPlugin})]})}const fs={Text:"text",Radios:"radios"};function jl(t){const{data:s}=It(),n=t.pluginName?s?.[t.pluginName]:void 0,a=Object.entries(n?.args??{}).map(([l,d])=>({name:l,...d})),[i,o]=Bn(),{beingMember:r}=Ge();return e.jsx("div",{className:"p-4 space-y-4",children:a.map(l=>st(l).with({hidden:!0},()=>null).with({type:A.optional(fs.Text),value:A.optional(A.string),placeholder:A.optional(A.string)},d=>e.jsxs(ir,{value:i.extraArgs?.[d.name],onChange:m=>o(u=>{u.extraArgs??={},u.extraArgs[d.name]=m}),className:"flex flex-col",children:[e.jsx(xt,{className:"mb-2",children:e.jsx("span",{className:"block -my-1",children:e.jsx(I,{i18nKey:d.label,defaults:d.label||d.name})})}),e.jsx(or,{placeholder:d.placeholder,className:"h-14 min-h-8 px-2.5 py-1.5 bg-transparent rounded-md ring-1 ring-inset ring-black/15 dark:ring-white/15 focus:outline outline-2 -outline-offset-1 outline-black/80 dark:outline-white/80 resize-y"})]},d.name)).with({type:fs.Radios,membershipDialogTitle:A.optional(A.string),membershipDialogContent:A.optional(A.string),options:A.intersection({length:A.number.gt(0)},A.array({value:A.string,label:A.optional(A.string),image:A.optional(A.string),membership:A.optional(A.boolean)}))},d=>e.jsxs(rr,{isRequired:!0,orientation:"horizontal",value:i.extraArgs?.[d.name],onChange:m=>{if(d.options.find(h=>h.value===m)?.membership&&!r){da({dialogTitle:e.jsx(I,{i18nKey:d.membershipDialogTitle,defaults:d.membershipDialogTitle}),dialogBody:e.jsx(I,{i18nKey:d.membershipDialogContent,defaults:d.membershipDialogContent}),trackingLocation:"emotion-plugin"});return}o(h=>{h.extraArgs??={},h.extraArgs[d.name]=m})},children:[e.jsx(xt,{className:"block mb-2",children:e.jsx("span",{className:"block -my-1",children:e.jsx(I,{i18nKey:d.label,defaults:d.label||d.name})})}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-3",children:d.options.map(m=>e.jsxs(lr,{value:m.value,className:"relative flex flex-col items-center gap-1.5 rounded-lg group",children:[e.jsx("img",{src:m.image,alt:m.label,className:w("w-full aspect-square object-cover object-center rounded-md shadow-[0_0_0_1px_theme(colors.zinc.200)]","group-data-[selected]:outline outline-2 outline-offset-2 outline-theme-primary")}),m.membership&&e.jsx(_s,{className:"absolute top-0.5 right-0.5 size-5"}),e.jsx("span",{className:"block px-2 rounded-full group-data-[selected]:text-white group-data-[selected]:bg-theme-primary",children:e.jsx(I,{i18nKey:m.label,defaults:m.label||m.value})})]},m.value))})]})).otherwise(()=>null))})}function vl(t){const s={};if(t.args)for(const[n,a]of Object.entries(t.args))a.value&&(s[n]=a.value);return s}function yl(){const t=c.useMemo(Ts,[]);return e.jsx(ll,{children:e.jsx(Ps.Provider,{value:t,children:e.jsxs(Ee,{id:z.EnhanceImage,className:"contents",children:[e.jsx("div",{className:"hidden mlg:flex flex-col mlg:overflow-hidden",style:{gridArea:"left"},children:e.jsx(wl,{})}),e.jsxs("main",{className:w("relative flex flex-col min-h-0 mlg:[grid-area:main/2/main/-1] max-mlg:row-end-[-1]"),children:[e.jsx(Ke,{className:w("m-3 mlg:hidden","[&>div]:flex [&>div]:flex-col [&>div]:items-center [&>div>p]:text-center","[&>div>a]:mx-auto [&>div>a]:py-1")}),e.jsx("div",{className:"flex px-4 py-1",children:e.jsx(_t,{className:"flex-wrap"})}),e.jsxs("div",{className:"grid grid-rows-[auto_1fr_auto] mlg:grid-rows-none mlg:grid-cols-[2fr_1fr] flex-1 gap-x-4 min-h-0 relative",children:[e.jsxs("div",{className:"flex flex-col mlg:grid mlg:grid-cols-2 border-x border-t dark:border-neutral-700 relative mlg:overflow-y-auto",children:[e.jsx(Cl,{}),e.jsx(Gt,{className:"hidden mlg:block absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 size-8 text-gray-300 dark:text-gray-700 mlg:rotate-0 rotate-90"}),e.jsx(ul,{})]}),e.jsx(fl,{})]})]})]})})})}const kl=c.memo(Mt);function wl(){const[,t]=c.useContext(he),s=de(),n=c.useCallback(a=>{a.media&&(E("panel_image_import",{scene:"enhance",cate:"task"}),s([a.media.id])),a.task&&t(Je(a.task)??[])},[]);return e.jsx(kl,{className:"flex-1",onSelectItem:n,enableBatchMediaSelect:!0})}function Cl(){const t=de(),s=c.useCallback(n=>{n?.media&&t([n.media.id])},[]);return e.jsx(jt,{onImageSelect:s,trackingScene:"enhance"})}function Nl(t){const[,s]=c.useContext(Ls),n=ma(t.task,t.task.mediaId),a=Es(t.task)===0&&As(t.task);function i(){E("publish_btn_click",{path:"animated",scene:"panel"}),s({taskId:t.task.id,mediaIdx:n,baseMedia:t.task.media,openPublishDialog:!0})}const{t:o}=k(["artwork","generation"]);return e.jsxs("div",{className:w("flex items-center gap-2",t.className),style:t.style,children:[e.jsx("span",{className:"flex-1 -mx-1"}),a&&e.jsxs(O,{className:"flex-none box-content px-3 bg-purple-700 text-white font-medium whitespace-nowrap",onClick:i,children:[e.jsx(Ct,{className:"w-5 h-5 -ml-1 mr-1"}),o("artwork:publish")]})]})}const Il=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M19.75 6.5a.75.75 0 0 1-.75-.75V5h-.75a.75.75 0 0 1 0-1.5H19v-.75a.75.75 0 0 1 1.5 0v.75h.75a.75.75 0 0 1 0 1.5h-.75v.75a.75.75 0 0 1-.75.75M8.799 3.728a.34.34 0 0 1 .1-.18c.046-.04.082-.048.102-.048s.056.007.102.049a.34.34 0 0 1 .1.178a6.57 6.57 0 0 0 1.767 3.304a6.55 6.55 0 0 0 3.303 1.767c.07.014.135.053.178.1c.042.046.049.082.049.102s-.007.056-.049.102a.34.34 0 0 1-.178.1a6.56 6.56 0 0 0-3.303 1.768a6.56 6.56 0 0 0-1.766 3.302a.34.34 0 0 1-.101.18c-.046.04-.082.048-.102.048s-.056-.007-.102-.049a.34.34 0 0 1-.1-.178a6.57 6.57 0 0 0-1.767-3.304a6.55 6.55 0 0 0-3.303-1.767a.34.34 0 0 1-.179-.1c-.04-.047-.048-.082-.049-.102c0-.02.008-.056.049-.101a.34.34 0 0 1 .18-.102a6.56 6.56 0 0 0 3.302-1.766a6.56 6.56 0 0 0 1.767-3.303M9 2c-.883 0-1.52.695-1.67 1.422A5.06 5.06 0 0 1 5.97 5.97a5.06 5.06 0 0 1-2.546 1.36c-.728.15-1.424.788-1.423 1.673c.002.882.697 1.517 1.423 1.668a5.05 5.05 0 0 1 2.547 1.358c.87.871 1.22 1.88 1.359 2.549C7.48 15.305 8.118 16 9 16c.885 0 1.521-.695 1.672-1.423a5.06 5.06 0 0 1 1.358-2.546a5.06 5.06 0 0 1 2.548-1.36c.727-.15 1.422-.787 1.422-1.67c0-.885-.695-1.521-1.423-1.672a5.05 5.05 0 0 1-2.546-1.359a5.06 5.06 0 0 1-1.359-2.548C10.521 2.695 9.885 2 9.002 2M9.5 16.954v1.796c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 0 0 1.75-1.75v-7.5a1.75 1.75 0 0 0-1.75-1.75h-1.796a2.7 2.7 0 0 0-.15-1.5h1.946A3.25 3.25 0 0 1 22 11.25v7.5A3.25 3.25 0 0 1 18.75 22h-7.5A3.25 3.25 0 0 1 8 18.75v-1.946a2.7 2.7 0 0 0 1.5.15M12 13.75a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 0 1.5h-5.5a.75.75 0 0 1-.75-.75m.75 2.25a.75.75 0 0 0 0 1.5h3.5a.75.75 0 0 0 0-1.5zm-10 3a.75.75 0 0 0 0 1.5h.75v.75a.75.75 0 0 0 1.5 0v-.75h.75a.75.75 0 0 0 0-1.5H5v-.75a.75.75 0 0 0-1.5 0V19z"})}),Sl=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"m14 7l-5 5l5 5V7z"})});function Ml(t){const{task:s}=t,{t:n}=k(["artwork","generation"]),a=c.useMemo(()=>Je(s)?.filter(x=>!x.deleted&&x.mediaId!==null).map(x=>ua(x.mediaId))??[],[s]),[,i]=St(async()=>{E("image_dl_all_click");try{await Promise.all(a.map((f,x)=>o(f,x)))}catch{D.error(n("generation:image-operation.notice.batch-image-download-failed"))}},[a]);function o(f,x){return Ds(f,`${wt({task:s,mediaIdx:x})}.${Pe({task:s})}`,{skipConversion:!1})}const[,r]=c.useContext(Ls),[,l]=c.useContext(he),{updateTaskFavoriteDelete:d}=ha(),[m,u]=c.useState(!0),h=s?.parameters?.prompts??"",{handleChange:g}=M(),v=c.useCallback(()=>{ga.confirm({dismissable:!0,className:"mlg:w-[600px] max-w-full",heading:n("generation:prompt-helper.rewritten-prompt.inspect-dialog.title"),content:e.jsx(fa,{prompts:h,segmentedPrompts:s?.parameters?.segmentedPrompts}),confirmProps:{children:n("action:reuse"),onPress:()=>{g("prompts")(h)}}})},[h,g,n]);return e.jsxs("div",{className:w("flex items-center mlg:h-24 justify-end",t.className),children:[e.jsxs("div",{className:w("flex items-center gap-1","p-1 m-0 rounded-md","flex-row mlg:flex-col mlg:bg-neutral-200 mlg:dark:bg-neutral-700",!m&&"hidden"),style:t.style,children:[xa(s)&&e.jsx(as,{delay:250,placement:"left",trigger:e.jsx(V,{variant:"ghost",className:w("max-mlg:bg-neutral-5 max-mlg:dark:bg-neutral-700","h-9 px-2"),onPress:v,disabled:s.status==="waiting",children:e.jsx("span",{className:"flex items-center",children:e.jsx(Il,{className:"size-6"})})}),children:e.jsx("p",{className:"p-2",children:n("generation:prompt-helper.rewritten-prompt.inspect-button.label")})}),s.status==="completed"&&(s.parameters?.batchSize??0)>1&&e.jsx(as,{delay:250,placement:"left",trigger:e.jsx(V,{onPress:i,variant:"ghost",busy:"auto",className:w("max-mlg:bg-neutral-5 max-mlg:dark:bg-neutral-700","h-9 px-2"),children:e.jsxs("span",{className:"flex items-center",children:[e.jsx(Fr,{className:"size-6"}),e.jsx("p",{className:"mlg:hidden p-1",children:n("generation:image-operation.download-all-images")})]})}),children:e.jsx("p",{className:"p-2",children:n("generation:image-operation.download-all-images")})}),e.jsx(pa,{variant:"ghost",className:w("max-mlg:bg-neutral-5 max-mlg:dark:bg-neutral-700","h-9 px-2"),task:s,onSuccess:async()=>{r({}),l(x=>[...x].filter(b=>b.taskId!==s.id)),d(s.id,{type:"delete",target:!0}),Math.random()<.25&&await ba()},children:e.jsx(ja,{className:"size-6"})})]}),e.jsx(V,{variant:"ghost",className:w("invisible mlg:visible w-2 h-8 outline-transparent dark:outline-transparent rounded-none",!m&&"rounded-l-md",m?"bg-neutral-200 dark:bg-neutral-700":"bg-neutral-300 dark:bg-neutral-600",m?"text-neutral-400 dark:text-neutral-500":"text-neutral-700 dark:text-neutral-300"),onPress:()=>u(f=>!f),children:e.jsx(Sl,{className:w("size-6 absolute -right-2 top-8 transition-all duration-150",m&&"rotate-180")})})]})}const _l=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M13 3a9 9 0 0 0-9 9H1l3.89 3.89l.07.14L9 12H6a7 7 0 0 1 7-7a7 7 0 0 1 7 7a7 7 0 0 1-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.896 8.896 0 0 0 13 21a9 9 0 0 0 9-9a9 9 0 0 0-9-9Z"})});function Tl(t){const{reset:s}=M(),[,n]=c.useContext(he),[a,i]=c.useContext(qe),{t:o}=k(["generation","action"]),r={...t.classes,contentButton:"px-2 py-0.5 capitalize bg-zinc-200 hover:bg-zinc-300 dark:bg-zinc-700 dark:hover:bg-zinc-600 rounded transition"},l=c.useCallback(()=>{E("panel_reset_click"),s(),n([]),a!=null?i(""):(i(""),setTimeout(()=>{i(void 0)},0))},[a,s]);return e.jsxs(cr,{children:[e.jsxs(ct,{className:w(t.className,r?.button,"outline-none"),children:[e.jsx(_l,{className:r?.icon}),!t.iconOnly&&e.jsx("span",{children:o("generation:reset.label")})]}),e.jsxs(dr,{placement:"top end",className:w("entering:animate-[fade-in_75ms_var(--ease-out),scale-in_100ms_var(--ease-out)]","exiting:animate-[fade-out_100ms_var(--ease-out),scale-out_100ms_var(--ease-out)]","origin-bottom"),children:[e.jsxs(mr,{className:"text-sm p-4 bg-background ring-1 ring-black/10 rounded-lg drop-shadow-md outline-none",children:[e.jsx("p",{children:o("generation:reset.confirm-dialog.content")}),e.jsxs("div",{className:"mt-4 flex justify-center items-center gap-4",children:[e.jsx(ct,{slot:"close",className:r.contentButton,children:o("action:cancel")}),e.jsx(ct,{slot:"close",className:r.contentButton,onPress:l,children:o("action:confirm")})]})]}),e.jsx(ur,{children:e.jsx("svg",{width:12,height:12,viewBox:"0 0 12 12",className:"fill-background",style:{filter:"drop-shadow(0 1px rgb(0 0 0 / 10%))"},children:e.jsx("path",{d:"M0 0 L6 6 L12 0"})})})]})]})}async function Pl(t){const{data:s}=await va.post("",{inputs:t.mediaUrls});return s}const Ll=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"})}),El=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"m20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8l8-8z"})}),Al=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"})}),Dl=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M19 12.998h-6v6h-2v-6H5v-2h6v-6h2v6h6z"})});Ye({});const nt=yn(),Kt=ya({}),Rl=Bt(t=>Object.entries(t(Kt)).length),Jt=()=>kn(Kt,{store:nt}),Fl=t=>vn({children:t.children,store:nt}),qt=()=>zt(Rl,{store:nt}),zn=()=>pr(Kt,{store:nt}),ze=4;function Ol(){const[t]=c.useContext(qe),[s]=c.useContext(Rs);return s?e.jsx(Fl,{children:e.jsx(Vl,{children:e.jsx(Bl,{})})},t):null}function Vl(t){const{getValues:s,handleChange:n}=M(),[a,i]=Jt(),o=c.useRef(!1);c.useEffect(()=>{s()?.then(d=>{d.ipAdapter?.referenceImages?i(Object.fromEntries(d.ipAdapter.referenceImages.map(m=>[m,{mediaId:m,progress:1,valid:!0}]))):i({})}),o.current=!0},[]);const r=c.useMemo(()=>Object.values(a).some(d=>!d.valid),[a]),l=c.useMemo(()=>Object.values(a).length>0,[a]);return c.useEffect(()=>{n("ipAdapter.imagesAreValid")(!r)},[r]),c.useEffect(()=>{o.current&&n("ipAdapter.enabled")(l)},[l]),e.jsx(e.Fragment,{children:t.children})}function Bl(){const{t}=k(["artwork","generation"]),{values:s}=M(),[n]=Jt(),a=qt(),i=c.useRef({open:()=>{}}),o=W(s.modelId),r=Ia(o?.modelType),l=c.useMemo(()=>(s.ipAdapter?.referenceImages??[])?.length>0,[s.ipAdapter?.referenceImages]),d=c.useMemo(()=>Object.values(n).some(m=>!m.valid),[n]);return!l&&!r?null:e.jsx(X,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("h2",{className:"font-semibold text-[14px]",children:t("generation:character-reference.label")}),e.jsx(Ul,{onUploadClick:i.current?.open}),e.jsx("label",{className:"text-xs text-neutral-500 ml-auto font-medium",children:`${a}/${ze}`})]}),(d||!r)&&e.jsx(Q,{type:Z.Warning,children:t(r?"generation:character-reference.without-face-hint":"generation:character-reference.incompatible-model-used-hint")}),e.jsxs("div",{className:"flex gap-3 w-full items-center",children:[e.jsx(Wl,{}),e.jsx(zl,{ref:i})]})]})})}const zl=c.forwardRef(function(s,n){const{setValues:a}=M(),{data:i}=Y(),o=zn(),r=qt(),{t:l}=k(["generation"]),d=c.useCallback(v=>{if(r+v.length>ze)return D.error(l("generation:character-reference.notice.max-allowed",{number:ze}));const f=Object.fromEntries(v.map(x=>[$t(),{file:x,controller:new AbortController}]));m(f)},[r]),m=async v=>{const f=Object.entries(v);f.forEach(x=>{const[p,{file:b,controller:y}]=x;o(C=>{C[p]={progress:0,file:b,abortController:y}})}),await ka(f,4,async x=>{const[p,{file:b,controller:y}]=x;try{const C=await wa(b,{signal:y.signal,onProgress:S=>{o(T=>{T[p].progress=S})}});if(!C.media)throw new Error("Upload media failed");Ca(C.media.id,C.media),o(S=>{S[p].mediaId=C.media?.id,delete S[p].file});const _=kt(C.media);if(!_)return;const N=!!(await Pl({mediaUrls:[_]}))[0].hasFace;o(S=>{S[p].valid=N}),a(S=>({...S,ipAdapter:{...S.ipAdapter,referenceImages:[...S.ipAdapter?.referenceImages??[],C.media.id]}}))}catch(C){C instanceof Or||D.error(C.message),o(_=>{delete _[p]})}}),E("face_detection_image_upload_success")},{getRootProps:u,getInputProps:h,open:g}=Na({onDrop:d,onFileDialogOpen:()=>{E("face_detection_image_upload_click")},accept:{"image/png":[],"image/jpeg":[],"image/webp":[]}});return c.useImperativeHandle(n,()=>({open:g}),[g]),r===ze?null:e.jsxs(we,{variant:r>0?void 0:"grayish-sidebar",className:w(r>0?"font-medium cursor-pointer flex flex-col gap-3 items-center justify-center text-xs rounded-lg w-[72px] h-[72px] bg-neutral-200 dark:bg-neutral-600 text-black dark:text-white":"w-full"),onClick:v=>{if(v.preventDefault(),E("character_img"),i){const f=u();f&&f.onClick&&f.onClick(v)}else me()},children:[e.jsx("input",{...h(),disabled:i===void 0}),r>0?e.jsx(Ll,{className:"size-6"}):e.jsx("label",{children:l("generation:character-reference.add-image")})]})});function Wl(){const[t]=Jt();return e.jsx(e.Fragment,{children:Object.entries(t).map(([s,n])=>e.jsx($l,{id:s,...n},s))})}function $l(t){const{setValues:s}=M(),{data:n}=Ne(t.mediaId??se),a=zn(),i=c.useCallback(()=>{E("remove_face_detection_image_click"),t.abortController?.abort(),a(h=>{delete h[t.id]}),s(h=>h.ipAdapter?.referenceImages?{...h,ipAdapter:{...h.ipAdapter,referenceImages:h.ipAdapter.referenceImages.filter(g=>g!==t.mediaId)}}:h)},[t.abortController,t.id,a]),o=be(n),r=kr(t.file),l=o??r,d=!t.mediaId||t.valid==null,m=t.valid===!1,{t:u}=k(["generation"]);return e.jsxs("div",{className:"relative group h-[72px] w-[72px] bg-white dark:bg-neutral-700 rounded-lg",children:[l&&e.jsx("img",{className:"aspect-square object-cover rounded-lg h-full w-full",src:l,loading:"lazy",decoding:"async"}),d&&e.jsx("div",{className:"absolute top-0 left-0 w-full h-full backdrop-blur bg-white/40 flex items-center justify-center rounded-lg",children:e.jsx(Ir,{variant:t.progress>15?"determinate":void 0,value:t.progress})}),m&&e.jsx("div",{className:"absolute top-0 left-0 w-full h-full backdrop-blur bg-black/40 flex items-center justify-center rounded-lg",children:e.jsx("p",{className:"text-center text-xs text-white scale-75",children:u("generation:character-reference.face-not-recognized-hint")})}),e.jsx("button",{title:"Remove",className:w("absolute right-0 top-0 translate-x-1/2 -translate-y-1/2 bg-white text-black p-0 rounded-full"),onClick:()=>{i()},children:e.jsx(Fs,{className:"size-4"})})]})}function Ul(t){const s=c.useContext(Os),{t:n}=k(["generation"]);return e.jsx(Xe,{wrapperClassName:"py-6 px-4",TooltipProps:{placement:"start"},children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-3",children:n("generation:character-reference.help.suggested-images")}),e.jsx("section",{className:"flex gap-3 mb-8",children:["front-view","slightly-side-view","side-view"].map(a=>e.jsxs("figure",{children:[e.jsx("img",{className:"w-[120px] h-[180px] object-cover rounded-xl",src:n(`generation:character-reference.help.${a}.image-url`)}),e.jsx("figcaption",{className:"text-sm mt-1",children:n(`generation:character-reference.help.${a}.label`)})]},a))}),e.jsx("h2",{className:"text-xl font-bold mb-3",children:n("generation:character-reference.help.not-suggested")}),e.jsx("section",{className:"flex gap-3",children:e.jsxs("figure",{children:[e.jsx("img",{className:"w-[120px] h-[180px] object-cover rounded-xl",src:n("generation:character-reference.help.back-view.image-url")}),e.jsx("figcaption",{className:"text-sm mt-1",children:n("generation:character-reference.help.back-view.label")})]})}),e.jsxs("button",{className:"font-bold mt-4 text-[#7c38c4] underline max-w-80 text-left",onClick:()=>Hl({onUploadClick:t.onUploadClick,onControlNetClick:s.current?.openControlNet}),children:[">",e.jsx(Cr,{t:n,i18nKey:"generation:character-reference.tips.title",components:{br:e.jsx("br",{})}})]})]})})}function Hl(t){return new Promise((s,n)=>{const a=Vs({children:e.jsx(Gl,{onClose:()=>a.current?.close(),addCharacterImage:()=>t?.onUploadClick?.(),addControlNet:()=>{t?.onControlNetClick?.()}}),onClose:()=>s,fullWidth:!1,responsive:!0,dialogProps:{maxWidth:"md"}})})}function Gl(t){const{t:s}=k(["generation"]),{data:n}=Y(),i=qt()>0;return e.jsxs("div",{className:"px-4 py-6 relative",children:[e.jsx(H,{onClick:t.onClose,className:"absolute right-2 top-2",children:e.jsx(Al,{className:"size-6"})}),e.jsx("h2",{className:"font-bold",children:s("generation:character-reference.tips.title")}),e.jsx("p",{children:s("generation:character-reference.tips.description")}),e.jsxs("section",{className:"grid grid-cols-[minmax(0,160px),120px,minmax(0,160px)] items-center justify-items-center pt-4 justify-center",children:[e.jsxs("figure",{className:"flex flex-col items-center",children:[e.jsx("figcaption",{className:"font-bold mb-4 sm:leading-3",children:s("generation:character-reference.tips.original.caption")}),e.jsx("img",{className:"rounded-xl object-cover max-w-[120px] mt-auto",src:s("generation:character-reference.tips.original.image-url")})]}),e.jsx(Dl,{className:"size-6"}),e.jsxs("figure",{className:"flex flex-col items-center h-full",children:[e.jsx("figcaption",{className:"font-bold sm:leading-3",children:s("generation:character-reference.tips.openpose.caption")}),e.jsx("figcaption",{className:"font-light mb-1 text-xs",children:s("generation:character-reference.tips.openpose.subcaption")}),e.jsx("img",{className:"rounded-xl object-cover max-w-[120px] mt-auto",src:s("generation:character-reference.tips.openpose.image-url")})]})]}),e.jsx("section",{children:e.jsxs("figure",{className:"flex flex-col items-center col-start-2 col-span-1",children:[e.jsx(El,{className:"size-6 mb-2"}),e.jsx("img",{className:"rounded-xl object-cover max-w-[120px]",src:s("generation:character-reference.tips.result.image-url")})]})}),e.jsxs("section",{className:"flex items-center gap-3 mt-5",children:[e.jsx(we,{variant:"normal",className:"ml-auto",onClick:()=>{n?(t.addCharacterImage?.(),t.onClose?.(),E("hover_character_img")):me()},children:s("generation:character-reference.tips.action.add-character-image")}),e.jsx(we,{variant:"normal",onClick:()=>{i?(t.addControlNet?.(),t.onClose?.(),E("hover_character_cnet")):D.error(s("generation:character-reference.tips.add-character-first-waring"))},children:s("generation:character-reference.tips.action.add-control-net")})]})]})}(function(){var t=F.fabric.util.addListener,s=F.fabric.util.removeListener,n={passive:!1};F.fabric.util.object.extend(F.fabric.Canvas.prototype,{_onTouchStart:function(a){(!this.allowTouchScrolling||this.getActiveObject())&&a.preventDefault&&a.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(a)),this.__onMouseDown(a),this._resetTransformEventData();var i=this.upperCanvasEl,o=this._getEventPrefix();t(F.fabric.document,"touchend",this._onTouchEnd,n),t(F.fabric.document,"touchmove",this._onMouseMove,n),s(i,o+"down",this._onMouseDown)}})})();const dt=Sa("pixai:LatentEditor");class Kl extends Br{constructor(s,n){super(),this.canvasEl=s,this.containerEl=n;const a=F.fabric.Object.prototype.toObject,i=["id"];F.fabric.Object.prototype.toObject=function(o){if(o)return a.call(this,i.concat(o))}}_canvas;_mode="rectangle";_creationStartPos;_creationObj;defaultTextColor="#fff";defaultFillColor="rgba(0, 0, 0, 0.4)";count=1;get canvas(){if(!this._canvas)throw new Error("editor not initialized");return this._canvas}get mode(){return this._mode}init(s){const n=new F.fabric.Canvas(this.canvasEl,{preserveObjectStacking:!0,stopContextMenu:!0,width:s.width,height:s.height,allowTouchScrolling:!0,selection:!1});this._canvas=n,s.width&&s.height&&this.setSize(s.width,s.height,s.accordAxis),n.on("mouse:down",a=>{const i=this.getSelection(),o=this.canvas.getObjects().filter(r=>r.type==="rect");i!=null||o.length>=6?this.setMode("select"):this.setMode("rectangle"),this.mode!=="select"&&(this._creationStartPos=a.pointer,this.canvas.selection=!1)}),n.on("mouse:up",a=>{this._creationStartPos=void 0;const i=this._creationObj;i&&(i.width&&i.height&&i.width>=50&&i.height>=50&&(i.clone(o=>this.addLatentBox(this.count.toString(),o)),this.count+=1,this._creationObj=void 0),n.remove(i),this._creationObj=void 0),this.setMode("select")}),n.on("mouse:move",a=>{if(a.pointer&&this._creationStartPos){if(!this._creationObj){this.setMode("rectangle");const i=this._handleObjectCreation();i&&(this._creationObj=i,this.canvas.add(i),this.canvas.setActiveObject(i),this.canvas.selectionColor="#0000")}if(this._creationObj){const i=this._creationObj,o=this.canvas.getZoom(),r=this._creationStartPos.x-a.pointer.x,l=this._creationStartPos.y-a.pointer.y,d=r<0?this._creationStartPos.x:this._creationStartPos.x-r,m=l<0?this._creationStartPos.y:this._creationStartPos.y-l;i.set({left:d/o,top:m/o,width:Math.abs(r)/o,height:Math.abs(l)/o}),this.canvas.requestRenderAll()}}}),n.on("selection:created",a=>{dt("selection:created %o",a),this.emit("selection_change")}),n.on("selection:updated",a=>{dt("selection:updated %o",a),this.emit("selection_change")}),n.on("selection:cleared",a=>{dt("selection:cleared %o",a),this.emit("selection_change")}),n.on("object:added",a=>{if(a.target?.shouldParse){const i=a.target,o=Number(i.id);i.clone(r=>this.addLatentBox(a.target?.id,r)),!isNaN(o)&&this.count<=o&&(this.count=o+1),n.remove(i)}})}on(s,n){return super.on(s,n)}dispose(){if(this.removeAllListeners(),!!this._canvas)try{this._canvas.dispose()}catch(s){console.warn(`dispose with error: ${s}`)}}setSize(s,n,a){const i=this.containerEl.getBoundingClientRect(),o=a==="y"?1/0:i.width/s,r=a==="x"?1/0:i.height/n,l=Math.min(o,r),d=l;this.canvas.setDimensions({width:s*l,height:n*l}),this.canvas.setViewportTransform([d,0,0,d,0,0])}_handleObjectCreation(){if(this._mode==="rectangle"){const s=new F.fabric.Rect({fill:this.defaultFillColor,lockRotation:!0,lockScalingFlip:!0,originX:"left",originY:"top"});return s.setControlVisible("mtr",!1),s}}async addLatentBox(s,n){this.canvas.discardActiveObject(),n.type==="activeSelection"?(n.canvas=this.canvas,n.setCoords(),this.canvas.add(n)):this.canvas.add(n);const a=n;return a.setControlVisible("mtr",!1),await this.addTextToRect(s,a),this.canvas.setActiveObject(a),this.emit("latent_creation",{item:a}),a}async addTextToRect(s,n){const a=n.getCenterPoint(),i=new F.fabric.Text(s,{fontSize:32,fontWeight:700,lockRotation:!0,originX:"center",originY:"center",left:a.x,top:a.y,lockScalingX:!0,lockScalingY:!0,fill:"#FEE2E2",fontFamily:"monospace",selectable:!1,evented:!1});n.on("moving",()=>{const o=n.getCenterPoint();i.set({left:o.x,top:o.y})}),n.on("scaling",()=>{const o=n.getCenterPoint();i.set({left:o.x,top:o.y})}),n.on("removed",()=>{this.canvas.remove(i)}),this.canvas.add(i),n.id=s}setMode(s){this._mode=s,this.emit("mode_change")}getSelection(){return this.canvas.getActiveObject()}removeSelection(){const s=this.canvas.getActiveObjects();this.canvas.remove(...s),this.canvas.discardActiveObject(),this.emit("selection:change")}}const Wn=c.forwardRef((t,s)=>{const n=c.useRef(null),a=c.useRef(null),i=c.useRef(null),[o,r]=c.useState(!1),[l,d]=c.useState({left:0,top:0});c.useImperativeHandle(s,()=>i);const m=g=>{const v=i.current;if(!v)return;const f=v.canvas._offset;if(g.left==null||g.top==null||f==null||f.left==null||f.top==null)return;const x=v.canvas.getZoom();d({left:g.left*x,top:g.top*x})},u=c.useCallback(async({width:g=600,height:v=600})=>{i.current?.dispose();const f=n.current;if(!f)return;const x=a.current;if(!x)return;const p=new Kl(f,x);i.current=p,window.editor=p,p.init({width:g,height:v}),p.on("latent_creation",({item:b})=>{const y=b.id??$t().toString();r(!0),m(b),t.dispatchRegions?.({type:"add",payload:y}),b.on("selected",()=>{r(!0),m(b)}),b.on("editing:entered",()=>{r(!1)}),b.on("deselected",()=>{r(!1)}),b.on("moving",()=>{m(b)}),b.on("scaling",()=>{m(b)}),b.on("resizing",()=>{m(b)}),b.on("removed",()=>{t.dispatchRegions?.({type:"remove",payload:y})})})},[]);c.useEffect(()=>(u({width:t.width,height:t.height}),()=>{i.current?.dispose()}),[]);const h=e.jsxs("div",{className:w("relative overflow-hidden"),ref:a,children:[e.jsx("canvas",{ref:n,className:"border w-full"}),e.jsx(O,{className:w("absolute -translate-x-1/2 -translate-y-1/2 rounded-full","bg-white text-black min-w-0 p-1",{hidden:!o}),variant:"contained",style:{...l},onClick:()=>{const g=i?.current;g&&(g.removeSelection(),r(!1))},children:e.jsx(ae,{className:"size-6"})})]});return e.jsx("div",{className:w("w-full flex items-stretch justify-center",t.className),children:h})});Wn.displayName="DivisionEditor";const Jl=(t,s)=>{if(!t.width||!t.height)return;const n=t.getZoom(),a=t.width/n,i=t.height/n;return s.sort((r,l)=>Number(r.id)-Number(l.id)).flatMap(r=>{if(!r.width||!r.height||r.top==null||r.left==null)return[];const{width:l,left:d,top:m,height:u}=r,h=Math.max(0,Math.min(a,d)),g=Math.max(0,Math.min(i,m)),v=a/l,f=i/u;return[{id:r.id,division:[f,v],position:[g/(i/f),h/(a/v)]}]})},ql=t=>({type:"rect",...t.reduce((n,a)=>({divisions:[...n.divisions,a.division.join(":")],positions:[...n.positions,a.position.join(":")],weights:[...n.weights,a.weight]}),{divisions:[],positions:[],weights:[]})}),Yl=t=>{const s=t.objects.filter(n=>n.type==="rect").map(n=>({...n,shouldParse:!0}));return{...t,objects:s}};function Xl(t){return Pt(W(t)?.modelType)}function Ql(){const{values:{latentCouple:t,modelId:s}}=M(),n=Xl(s),{t:a}=k(["generation"]),[i,o]=c.useState(!1);return n||t?e.jsx(X,{help:e.jsx("img",{className:"w-[400px] min-h-[600px] rounded-lg",src:a("generation:composition.help-image-url")}),title:a("generation:composition.composition"),children:e.jsx(ac,{children:e.jsx(oc,{children:e.jsxs("div",{className:"flex flex-col gap-4",children:[!n&&e.jsx(Q,{type:Z.Warning,children:a("generation:composition.incompatible-model-used-hint")}),e.jsx(Zl,{openDialog:()=>o(!0)}),e.jsx(ec,{open:i,onClose:()=>o(!1)})]})})})}):null}function Zl(t){const{t:s}=k(["generation"]),[{previewImage:n},a]=c.useContext(Yt),{handleChange:i}=M(),{dispatch:o}=c.useContext(De),r=()=>{a(l=>({...l,savedEditor:void 0,previewImage:void 0})),o({type:"RESET"}),i("latentCouple")(void 0)};return e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{className:"w-[128px] h-[128px] rounded-xl border border-neutral-300",children:e.jsxs("div",{className:"flex relative w-full h-full",style:{aspectRatio:Tt(n)},children:[e.jsx(Ie,{originalUrl:n.url,fileName:`pixai-composition-preview_${Date.now()}.png`,imgClassName:"flex object-contain w-full h-full rounded-xl !object-center",height:n?.height,width:n?.width}),e.jsx(H,{onClick:r,className:"rounded-full bg-background absolute top-0 right-0 translate-x-3 -translate-y-3 shadow",children:e.jsx(ae,{className:"size-[14px]"})})]})}),e.jsx(we,{variant:"grayish-sidebar",className:"w-full",onClick:()=>{t.openDialog(),E("add_composition_click")},children:s(n?"generation:composition.edit-composition":"generation:composition.add-composition")})]})}function ec(t){const{values:s,handleChange:n}=M(),[{editorRef:a},i]=c.useContext(Yt),{state:o,dispatch:r}=c.useContext(De),{t:l}=k(["action","generation"]),d=c.useRef(!0),m=Bs(),u=zs(s);c.useEffect(()=>{!s.width&&!s.height&&!u&&o.length>1&&(r({type:"RESET"}),i(g=>({...g,savedEditor:void 0,previewImage:void 0})),D.info("Compositions cleared due to size changes"),d.current=!0)},[s.width,s.height,u]);const h=()=>{const g=a?.current?.current?.canvas;if(!g)return D.error("Canvas is invalid");if(o.some(x=>!x.prompts))return D.error("Some prompts are empty");const{objects:v}=g.toObject(),f=v.filter(x=>x.type==="rect");try{const x=Jl(g,f);if(!x)throw new Error("Division data is invalid");const p=o.flatMap(b=>{const y=x.find(C=>C.id===b.id);return y?[{division:y.division,position:y.position,weight:b.weight}]:b.id==="0"?{weight:b.weight,division:[1,1],position:[0,0]}:[]});i(b=>({...b,previewImage:{url:g.toDataURL({format:"PNG"}),height:g.height,width:g.width},savedEditor:Yl(g.toJSON(["id"]))})),n("latentCouple")(ql(p)),n("prompts")(o.map(b=>b.prompts).join(`
AND `)),E("add_composition_success"),t.onClose()}catch(x){D.error(x.message)}};return e.jsxs(Cn,{open:t.open,onClose:t.onClose,maxWidth:"md",fullWidth:!0,fullScreen:m,children:[e.jsxs(Sr,{className:"font-semibold",children:[l("generation:composition.composition"),e.jsx(_a,{inline:!0,className:"prose text-sm text-primary-light font-normal",children:l("generation:composition.helper")})]}),e.jsx(Nn,{className:"pt-2",children:e.jsx(tc,{})}),e.jsxs(In,{children:[e.jsx(O,{onClick:t.onClose,className:"capitalize",children:l("action:cancel")}),e.jsx(O,{variant:"contained",className:"font-bold",onClick:h,children:l("action:confirm")})]})]})}function tc(){const{dispatch:t}=c.useContext(De),[{savedEditor:s},n]=c.useContext(Yt),{values:a}=M(),i=c.useRef(null);return c.useEffect(()=>{const o=i.current?.current;requestAnimationFrame(()=>{o?.canvas.loadFromJSON(s,o?.canvas.renderAll.bind(o?.canvas))})},[]),c.useEffect(()=>{n(o=>({...o,editorRef:i}))},[]),e.jsxs(e.Fragment,{children:[e.jsx(Wn,{width:a.width,height:a.height,dispatchRegions:t,className:"max-w-[600px] max-h-[480px] md:max-w-[1024px]",ref:i}),e.jsx(sc,{})]})}function sc(){const{t}=k(["generation"]),{state:s}=c.useContext(De);return e.jsx("div",{className:"flex flex-col gap-4 py-4",children:s.map(n=>e.jsx(nc,{title:n.id==="0"?t(["generation:composition.global-region"]):`Area ${n.id}`,regionId:n.id},n.id))})}const mt=Array.from(Array(10).fill(void 0),(t,s)=>(s+1)/10);function nc(t){const{state:s,dispatch:n}=c.useContext(De),a=s.find(o=>o.id===t.regionId),i=c.useCallback(({weight:o,input:r})=>{o!=null?n({type:"change-weight",payload:{id:t.regionId,weight:o}}):r!=null&&n({type:"change-prompt",payload:{id:t.regionId,prompts:r}})},[t.regionId]);return a?e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-lg mb-2",children:t.title}),e.jsxs("div",{className:"flex gap-4 items-end",children:[e.jsx(Mr,{multiline:!0,className:"flex-1",minRows:2,placeholder:"prompts",onChange:o=>i({input:o.target.value}),value:a.prompts}),e.jsxs(Wt,{className:"min-w-[96px]",label:"Weight",value:a.weight,select:!0,slotProps:{select:{renderValue:o=>typeof o=="number"?o.toFixed(1):null}},children:[e.jsx("div",{className:"px-6 w-[300px] max-w-full flex items-center",children:e.jsx(Se,{min:.1,max:1,step:.1,value:a.weight,onChange:(o,r)=>typeof r=="number"&&i({weight:r}),marks:mt.map((o,r)=>({value:o,label:r===0||r===mt.length-1?o.toFixed(1):""}))})}),mt.map(o=>e.jsx(bt,{value:o,className:"hidden",children:o.toFixed(1)},o))]})]})]}):null}const[Yt,ac]=Ye({}),$n=[{id:"0",weight:.2,prompts:""}];function ic(t,s){switch(s.type){case"RESET":return $n;case"init":return s.payload;case"add":{const n=s.payload;return t.some(a=>a.id===n.toString())?t:[...t,{id:n.toString(),weight:.8,prompts:""}]}case"remove":{const n=s.payload,a=t.findIndex(o=>o.id===n.toString()),i=[...t];return i.splice(a,1),i}case"change-weight":{const{id:n,weight:a}=s.payload,i=t.findIndex(r=>r.id===n.toString());if(i<0)return t;const o=[...t];return o.splice(i,1,{...o[i],weight:a}),o}case"change-prompt":{const{id:n,prompts:a}=s.payload,i=t.findIndex(r=>r.id===n.toString());if(i<0)return t;const o=[...t];return o.splice(i,1,{...o[i],prompts:a}),o}default:throw new Error}}const[De,oc]=Ma(ic,$n);function xs(t){const{id:s}=t;return new Promise((n,a)=>{const i=Vs({children:e.jsx(lc,{modelId:s,loraBaseModelType:t.loraBaseModelType,onClose:async()=>{await i.current?.close(),a(ht)},onVersionSelect:async o=>{Lt(o.id,o),await i.current?.close(),n(o)},autoSelectFirst:t.autoSelectFirst}),onClose:()=>{a(ht)}})})}const rc=t=>e.jsx(Ea,{...t,onClickNext:()=>{},onClickPrev:()=>{},className:"mb-0 mt-4"});function lc(t){const{t:s}=k(["market"]),n=c.useRef(!1),a=20,[{before:i,after:o},r]=c.useState({}),l=e.jsxs(e.Fragment,{children:[e.jsx(Ta,{useSWR:Qe,extraArgs:{modelId:t.modelId,baseModelType:t.loraBaseModelType},getConnection:d=>d,pageSize:a,renderItem:d=>e.jsx(dc,{modelProps:{version:d},onClick:()=>{if(d.status!==is.available)return D.info("Selected version is not available yet");t.onVersionSelect(d)}},d.id),renderContainer:({children:d})=>e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(160px,1fr))] gap-4 max-w-6xl",children:d}),isPosSeq:!0,empty:e.jsx(cc,{}),before:i,after:o,onCursorChange:r,loading:e.jsx(ue,{}),onDataChange:d=>{if(n.current)return;d&&(n.current=!0);const m=ne(d);(m.length===1||t.autoSelectFirst&&m.length>0)&&(m[0]?.status!==is.available&&(D.warn(s("market:model.versions-empty")),t.onClose()),t.onVersionSelect(m[0]))},PagingButton:rc}),e.jsx(H,{onClick:t.onClose,className:"absolute top-0 right-0",children:e.jsx(ae,{})})]});return e.jsx("div",{className:"p-8",children:l})}function cc(){const{t}=k(["market"]);return e.jsx("div",{className:"p-8",children:e.jsx(Ws,{description:t("market:model.versions-empty")})})}function dc(t){const{version:s}=t.modelProps,n=$s(s.mediaId),a=Pa(La(s));return e.jsxs(O,{className:"flex flex-col",onClick:t.onClick,children:[e.jsxs("div",{className:"w-40 h-40 relative",children:[e.jsx("img",{src:n,className:"w-full h-full object-cover rounded-t-md"}),a&&e.jsx("span",{className:w("absolute text-xs px-2 py-1 rounded-lg top-0 left-0 ml-2 mt-2 ",a?.bgClassName),children:a?.label})]}),e.jsx("p",{className:"w-full font-mono font-bold p-1 rounded-xl text-sm truncate",title:s.name,children:s.name}),e.jsx("p",{className:"text-xs",children:new Date(s.updatedAt).toLocaleString()})]})}async function mc(t,s){return new Promise((n,a)=>{const i=Aa(e.jsx(uc,{modelId:t,loraBaseModelType:s,onSelectVersion:o=>{o?n(o):a(),i()}}))})}function uc(t){const{data:s,isLoading:n}=Qe({first:20,modelId:t.modelId,baseModelType:t.loraBaseModelType}),a=c.useRef(!1),i=ne(s)?.[0];return c.useEffect(()=>{n||a.current||(t.onSelectVersion(i||null),a.current=!0)},[n,i?.id]),null}function Xt(t){const{width:s,height:n}=t,a=c.useCallback(i=>{i.button!==0||i.ctrlKey||i.metaKey||i.shiftKey||(i.preventDefault(),t.onLabelClick?.(),i.currentTarget.parentElement?.click())},[t.onLabelClick]);return e.jsx(Sn,{disabled:t.disabled,title:t.title,className:"group/label relative m-0 isolate",sx:{margin:0,padding:0},control:e.jsx(_r,{className:w("z-10 absolute top-2 right-2 p-0 rounded text-primary","bg-background translate-x-1/2 -translate-y-1/2"),checked:t.selected,onChange:i=>t.onChange(i.target.checked)}),label:e.jsxs("a",{className:"flex flex-col items-center",tabIndex:-1,href:`/model/${t.modelId}`,target:"_blank",onClick:a,children:[e.jsxs("div",{className:w("relative rounded-xl m-[3px] overflow-hidden","ring-2 ring-offset-1 ring-transparent ring-offset-background-light","group-[&:has(:focus-visible)]/label:ring-purple-600","dark:group-[&:has(:focus-visible)]/label:ring-purple-400"),style:{width:s-6,height:n-6},children:[t.loading&&e.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:e.jsx(Ra,{className:"size-5 text-white animate-spin"})}),e.jsx("img",{className:"rounded-xl w-full h-full object-cover",src:t.previewUrl,loading:"lazy",decoding:"async"}),t.blurCover&&e.jsx(Fa,{className:"rounded-xl"}),t.showRefCount&&t.refCount!=null&&e.jsx(Oa,{refCount:t.refCount})]}),e.jsx("p",{className:"pt-1 h-[44px] leading-5 text-xs font-semibold line-clamp-2 break-all hyphens-auto",style:{width:s},children:t.title})]})})}function hc(t){const s=et("msm"),{preview:n,media:a,height:i=s?80:120,width:o=s?80:120}=t,r=n??be(a);return!t.versionId&&!t.modelId?e.jsx("div",{style:{height:i,width:o},children:"Model Deleted"}):e.jsx(Xt,{selected:t.selected,modelId:t.modelId,title:t.title,previewUrl:r,width:o,height:i,blurCover:t.blurCover,showRefCount:t.showRefCount,refCount:t.refCount,onChange:t.onToggle})}function Un(t){const[s,n]=Us(),[{selectedModelVersions:a,maxAllowedLoras:i,taskModelType:o},r]=c.useContext(U),l=et("msm"),{preview:d,media:m,height:u=l?80:120,width:h=l?80:120}=t,g=d??be(m),v=c.useMemo(()=>{const C=t.modelId;return C?Object.keys(a).includes(C):!1},[t.modelId,a]),f=c.useMemo(()=>Object.keys(a).length>=i,[a,i]),x=c.useMemo(()=>f&&!v,[f,v]),[p,b]=ie(async C=>{let _;const j=t.modelId;if(!j)return D.error("model id not exists");if(C){const N=await mc(j,o);Lt(N.id,N),_=N.id}el({modelId:j,versionId:_},C,r)},[t.modelId,o]),y=c.useCallback(()=>{f&&s&&(Ze({trackingLocation:"chosen-exccessive-lora-dialog"}),n())},[f,s]);return t.modelId?e.jsx(Xt,{disabled:x,selected:v,modelId:t.modelId,title:t.title,previewUrl:g,width:h,height:u,blurCover:t.blurCover,showRefCount:t.showRefCount,refCount:t.refCount,onChange:b,onLabelClick:y,loading:p}):e.jsx("div",{style:{height:u,width:h},children:"Model Deleted"})}function gc(t){const[s,n]=Us(),{values:a,setValues:i}=M(),[{selectedModelVersions:o,maxAllowedLoras:r,taskModelType:l},d]=c.useContext(U),{title:m,preview:u,media:h,height:g,width:v}=t,f=u??be(h),x=c.useMemo(()=>{const j=t.modelId;return j?Object.keys(o).includes(j):!1},[t.modelId,o]),p=c.useMemo(()=>{const j=a.lora??{};return Object.keys(j).length>=r},[a.lora,r]),b=c.useMemo(()=>p&&!x,[p,x]),[y,C]=ie(async j=>{E("outer_lora_click",{loraId:t.modelId});let N="";const S=t.modelId;let T="";if(S&&j)if(Da(t.modelType)){const P=await xs({id:S,autoSelectFirst:!0,loraBaseModelType:l});N=P.id,T=P.extra.triggerWords??""}else{const P=await xs({id:S,loraBaseModelType:l});N=P.id,T=P.extra.triggerWords??""}i(P=>{const L={...P.lora};if(j){if(!N)return P;L[N]=te}else if(N)delete L[N];else{const $=Object.entries(o).find(([ge])=>ge===S)?.[1].versionId;if(!$)return P;delete L[$]}let R=P.prompts;if(j&&T)R=[R,T].join(",");else if(R&&!j){const $=Object.entries(o).find(([ge])=>ge===S)?.[1].triggerWords;R=gt({prompts:R,triggerWords:$})}return{...P,lora:L,prompts:R}})},[t.modelId,o,l]),_=c.useCallback(()=>{p&&s&&(Ze({trackingLocation:"chosen-exccessive-lora-sidebar"}),n())},[p,s]);return t.modelId?e.jsx(e.Fragment,{children:e.jsx(Xt,{selected:x,disabled:b,modelId:t.modelId,title:t.title,previewUrl:f,width:v,height:g,blurCover:t.blurCover,onChange:j=>C(j),onLabelClick:_,loading:y})}):e.jsx("div",{style:{height:g,width:v},children:"Model Deleted"})}function fc(t){const s=c.useMemo(()=>Object.entries(t.lora??{}).map(([a])=>a),[t.lora]);return W(s)}function xc(t){const s=fc(t);return c.useMemo(()=>{const a=Object.entries(s??{}).flatMap(([i,o])=>o?[[o.modelId,{versionId:o.id,weight:t.lora?.[i]??te,modelId:o.modelId,triggerWords:o.extra.triggerWords,versionModelType:o.modelType,mediaId:o.mediaId,version:o}]]:[]);return Object.fromEntries(a)},[t.lora,s])??{}}function pc({lora:t,mutate:s}){const{t:n}=k(["market","generation"]),a=t.bookmarked,[i,o]=ie(async()=>{try{const r=!a;E(r?"bookmark_click":"delete_bookmark_click",{scene:"lora-select-preview",modelId:t.id}),await Ks.markGenerationModel({modelId:t.id,target:r,type:wn.Bookmark}),s?.(),D.info(n(r?"market:model.notice.bookmark-success":"market:model.notice.unbookmark-success"))}catch(r){if(r===ht)return;D.error(`Failed to bookmark. ${r?.message}`)}},[a,t.id]);return e.jsx(V,{variant:"ghost",size:"small",className:"my-1 py-1",busy:i,icon:a?e.jsx(Wa,{className:"text-purple-600 size-4"}):e.jsx($a,{className:"size-4"}),onPress:o,children:n(a?"generation:model.preview.bookmarked":"market:model.action.bookmark")})}function bc({modelId:t,weight:s,onChange:n,...a}){const{t:i}=k(["generation"]),o=c.useMemo(()=>`weight-slider-${t}`,[t]);c.useEffect(()=>{s==null&&n?.(te)},[]);const r=(s??0)<0||(s??0)>1;return e.jsxs(Mn,{...a,children:[e.jsxs("label",{htmlFor:o,className:"flex gap-1 text-sm",children:[i("generation:lora.weight"),e.jsx(Xe,{variant:"normal",TooltipProps:{placement:"top"},children:e.jsx("p",{className:"max-w-[36ch]",children:i("generation:lora.weight-range.help")})})]}),e.jsxs("div",{className:w("flex gap-2",r&&"text-amber-600"),children:[e.jsx(Se,{id:o,color:r?"error":void 0,size:"small",valueLabelDisplay:"auto",value:s??te,min:-2,max:2,step:.1,onChange:(l,d)=>{typeof d=="number"&&n?.(d)}}),e.jsx(xe,{type:"number",className:"w-[4em] text-sm",color:r?"error":void 0,size:"small",value:s??te,inputProps:{min:-2,max:2,step:.1},onChange:l=>{const d=Number(l.target.value);n?.(pe(d,-2,2))}})]})]})}const[Hn,jc]=Ye({});function vc({modelId:t,formLora:s,onChange:n,onRemove:a,baseModelType:i}){const{t:o}=k(["generation"]),[,r]=c.useContext(Hn),{versionId:l}=s,{data:d,isValidating:m,mutate:u}=Gs(t),{data:h,isValidating:g}=Qe({modelId:t,baseModelType:i,first:40}),v=ne(h),f=c.useCallback(p=>{n({...s,versionId:p.target.value})},[n,s]),x=c.useMemo(()=>v?.find(p=>p.id===l),[v,l]);return c.useEffect(()=>{r(p=>({...p,[t]:{validating:m||g,triggerWords:x?.extra?.triggerWords}}))},[x,m,g,t,r]),c.useEffect(()=>()=>{r(p=>{const b={...p};return delete b[t],b})},[t,r]),!d||!h?e.jsx("li",{className:"grid place-items-center p-4 h-40",children:e.jsx(ue,{inline:!0})}):e.jsxs("li",{className:"flex flex-col gap-2 p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"shrink-0 relative",children:[d.media?e.jsx("img",{loading:"lazy",decoding:"async",className:"inline-block align-bottom w-20 h-20 rounded object-cover",src:be(d.media)}):null,e.jsx(H,{className:"absolute top-1 left-1 p-0 text-black bg-white/70 -translate-x-1/2 -translate-y-1/2",size:"small",onClick:a,children:e.jsx(Fs,{})})]}),e.jsxs("div",{className:"h-20 min-w-0",children:[e.jsx(pc,{lora:d,mutate:u}),e.jsx(Dn,{to:`/model/${d.id}`,target:"_blank",children:e.jsx("h4",{className:"line-clamp-2 font-medium break-all",children:d.title})})]})]}),v.length&&l?e.jsxs(e.Fragment,{children:[v.length>1?e.jsx(Va,{versionId:l,versions:v,onChange:f}):null,e.jsx(bc,{modelId:t,weight:s.weight,onChange:p=>{n?.({...s,weight:p})}})]}):e.jsx(Tr,{severity:"warning",className:"px-4 py-0",icon:e.jsx(Ba,{}),children:o("generation:model.preview.no-version")})]})}function yc({outsideContextState:t,setOutsideContext:s,onClose:n}){const{t:a}=k(["generation"]),{setValues:i}=M(),[o]=c.useContext(U),[r]=c.useContext(Hn),l=Object.entries(o.selectedModelVersions),[d,m]=ie(async()=>{const h=l.map(([f,x])=>[f,{...x,triggerWords:r[f]?.triggerWords}]),g=Object.values(t.selectedModelVersions).map(f=>f.triggerWords).filter(f=>!!f?.length),v=h.map(([,{triggerWords:f}])=>f).filter(f=>!!f?.length);return i(f=>({...f,lora:Object.fromEntries(h.map(([,{versionId:x,weight:p}])=>[x,p])),prompts:za({prompts:f.prompts,wordsToDelete:g,wordsToAppend:v})})),s(f=>({...f,selectedModelVersions:Object.fromEntries(h)})),E("lora_selected",{loraId:l.map(([f])=>f).join(":"),location:t.tab}),n()},[l,r,t,i,n]),u=Object.values(r).some(h=>h.validating)||d;return e.jsx(V,{busy:u,disabled:l.some(([,h])=>!h.versionId),variant:"filled",onPress:m,className:"w-full",children:a("generation:lora.preview.confirm")})}function kc(){const[t]=c.useContext(U),s=Object.entries(t.selectedModelVersions);return e.jsxs("div",{className:w(s.length>=t.maxAllowedLoras?"text-amber-600":s.length>=Ut?"text-theme-primary":"text-primary-light"),children:["(",s.length,"/",t.maxAllowedLoras,")"]})}function wc({outsideContextState:t,setOutsideContext:s,onClose:n,...a}){const{t:i}=k(["generation"]),[o,r]=c.useContext(U),l=Object.entries(o.selectedModelVersions),{data:{membership:d}={}}=Hs();return e.jsx(jc,{defaultValue:{},children:e.jsxs("div",{...a,className:w("flex flex-col gap-2",a.className),children:[e.jsxs("div",{className:"flex-1 flex flex-col gap-2 pt-3 px-4 overflow-x-visible overflow-y-auto",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline",children:[e.jsx("h3",{className:"flex-1 text-xl font-medium",children:i("generation:lora.preview.title")}),e.jsx(kc,{})]}),!d&&e.jsx("button",{className:"text-sm text-theme-primary",onClick:()=>{Ze({trackingLocation:"lora-use-more"})},children:i("generation:lora.list.use-more")})]}),l.length?e.jsx("ul",{className:"flex flex-col -mx-4 divide-y divide-background-light border-b border-t border-background-light",children:l.map(([m,u])=>e.jsx(vc,{modelId:m,formLora:u,onChange:h=>{r(g=>({...g,selectedModelVersions:{...g.selectedModelVersions,[m]:h}}))},baseModelType:o.taskModelType,onRemove:()=>{r(h=>{const g={...h.selectedModelVersions};return delete g[m],{...h,selectedModelVersions:g}})}},m))}):e.jsx("div",{className:"grid place-items-center h-32",children:e.jsx("p",{className:"text-gray-500",children:i("generation:lora.preview.no-selection")})})]}),e.jsx("div",{className:"p-4",children:e.jsx(yc,{outsideContextState:t,setOutsideContext:s,onClose:n})})]})})}function Cc(t){const{t:s}=k(["generation"]),{data:n,isLoading:a}=Qe({modelId:t.modelId,baseModelType:t.baseModelType,first:20}),i=ne(n),o=i.map(l=>({...l,key:l.id,type:l.modelType??ee.UnknownLora})),r=c.useCallback(l=>{l!==t.versionId&&t.onVersionChange(o.find(d=>d.id===l))},[t,o]);return!a&&i.length<1?e.jsx("p",{className:"text-xs italic text-stone-600 dark:text-stone-300",children:e.jsx(I,{i18nKey:"generation:generation.lora.no-compatible-lora-version"})}):a?e.jsx(V,{variant:"outlined",icon:e.jsx(Ua,{loading:!0,className:"size-4 animate-spin"}),disabled:!0,size:"small",className:"w-fit"}):e.jsx(Ha,{isDisabled:a,items:o,selectedKey:t.versionId,onSelectionChange:l=>r(l),"aria-label":"Select LoRA version",buttonClassName:"pl-1 [--ui-size:1.25rem] h-[26px] max-w-full [&>span:nth-child(2)]:min-w-0",placeholder:s("generation:model.select.lora-version.placeholder"),children:l=>e.jsx(Ga,{id:l.id,startIcon:e.jsx(Ic,{modelType:Ka(l)}),labelClassName:"flex-initial truncate inline-flex items-center",children:e.jsx("span",{className:"pl-1 truncate",children:l.name})},l.id)})}function Nc(t){return st(t.loraBaseModelType).with(ee.Dit7BModel,()=>({label:"DiT",className:"bg-[#E4C1F9]"})).with(ee.SdV1Model,()=>({label:"SDv1",className:"bg-[#FCF6BD]"})).with(ee.SdxlModel,()=>({label:"SDXL",className:"bg-[#D0F4DD]"})).otherwise(()=>({label:"LoRA",className:"bg-stone-300"}))}function Ic(t){k(["market"]);const{label:s,className:n}=Nc({loraBaseModelType:t.modelType})??{};return e.jsx("div",{className:w("rounded-2xl px-1.5 py-0.5 flex items-center text-black",n,t.className),children:e.jsx("p",{className:"font-medium",children:s})})}function Sc(){const{validation:t}=M(),s=Array.isArray(t.lora),{t:n}=k(["common","generation"]),[a,i]=c.useState(!1),[{open:o},r]=Le(),[l]=c.useContext(qe),{data:d,loading:m}=Hs(),u=d?.membership?.privilege.lora??Ut;return c.useEffect(()=>{o==="lora"&&setTimeout(()=>{i(!0),r(h=>({...h,open:null}))},1e3)},[o]),e.jsxs(X,{help:e.jsx("img",{className:"w-[400px] min-h-[600px] rounded-lg",src:n("generation:lora.help")}),title:n("common:ranking.lora.label"),titleSlot:e.jsx(Mc,{isMember:Ms(d),maxAllowedLoras:u}),className:"flex flex-col gap-2",children:[s&&e.jsx(Q,{type:Z.Warning,children:n("generation:lora.incompatible-lora-used-hint")}),d?.membership===void 0&&m?e.jsx(ue,{}):e.jsxs(Rn,{defaultValue:{selectedModelVersions:{},maxAllowedLoras:u,searchKeyword:"",openDetail:!1,marketOrder:os.trending,bookmarkListOrder:os.newest,tab:"market"},children:[e.jsx(Dc,{open:a,onClose:()=>{i(!1)}}),e.jsx(_c,{}),e.jsx(Tc,{}),e.jsx(Fc,{}),e.jsx(Pc,{openDialog:()=>i(!0)})]},l)]})}function Mc(t){const{t:s}=k(["artwork","generation"]),{values:n}=M(),a=Object.keys(n.lora??{}).length;return e.jsxs("p",{className:w("ml-auto text-xs flex items-center gap-1"),children:[e.jsxs("span",{className:w(t.isMember?"text-theme-primary font-semibold":"text-neutral-400 font-medium"),children:[t.isMember?s("generation:lora.max-allowed"):s("generation:lora.free"),": ",a,"/",t.maxAllowedLoras]}),!t.isMember&&e.jsx(V,{className:"flex items-center gap-1 hover:underline py-0.5 px-1 focus:outline-1 focus:outline-purple-400",variant:"ghost",onPress:()=>{Ze({defaultMode:"plans",trackingLocation:"genpage-sidebar-lora-more"})},endIcon:e.jsx(_s,{className:"size-4"}),children:e.jsxs("span",{className:"text-theme-primary font-semibold",children:[s("generation:lora.max"),": ",tl]})})]})}function _c(){const[,t]=c.useContext(U),{values:{lora:s,modelId:n}}=M(),a=W(n),i=xc({lora:s});c.useEffect(()=>{t(tt(r=>{r.selectedModelVersions=i}))},[i]);const o=c.useCallback(()=>{t(r=>({...r,taskModelType:a?.modelType,marketFilters:{...Ja(ee.AnyLora,a?.modelType)}}))},[a?.modelType]);return c.useEffect(()=>{o()},[a?.id]),null}function Tc(){const[{selectedModelVersions:t}]=c.useContext(U),s=Object.entries(t);return e.jsx(e.Fragment,{children:s.map(([n,a])=>e.jsx(Lc,{modelId:n,...a},n))})}function Pc(t){const{t:s}=k(["generation"]);return e.jsx(V,{variant:"filled",color:"grayish-sidebar",className:"w-full capitalize",onPress:()=>{t.openDialog()},children:s("generation:lora.show-more-lora")})}function Lc(t){const{versionId:s,weight:n,modelId:a,mediaId:i,triggerWords:o}=t,[{selectedModelVersions:r,taskModelType:l}]=c.useContext(U),{setValues:d}=M(),m=W(s),{data:u}=Gs(a),h=qa(m),g=!Ya(l,h),v=$s(i),f=c.useCallback(b=>{Lt(b?.id,b),d(y=>{const C=b.id,_={...y.lora};if(!C)return y;_[C]=te;let j=y.prompts;if(j){const N=Object.entries(r).find(([S])=>S===a)?.[1].triggerWords;j=gt({prompts:j,triggerWords:N})}return b.extra.triggerWords&&(j=[j,b.extra.triggerWords].join(",")),t.versionId&&delete _[t.versionId],{...y,lora:_,prompts:j}})},[t.versionId,d,r]),x=c.useCallback(()=>{if(!s)return;const b=o;d(y=>{if(!y.lora)return y;const C={...y.lora};delete C[s];let _=y.prompts;return _=gt({prompts:_,triggerWords:b}),{...y,prompts:_,lora:C}})},[s,o,d]),p=c.useCallback(b=>{s&&d(y=>{if(!y.lora)return y;const C={...y.lora};return C[s]=b,{...y,lora:C}})},[s]);return e.jsxs("div",{className:"relative flex gap-3 bg-background-light p-2 rounded-xl",children:[e.jsxs("div",{className:"self-center relative",children:[e.jsx("img",{className:"w-[60px] h-[60px] rounded-xl object-cover",src:v,loading:"lazy",decoding:"async"}),g&&e.jsx("div",{className:"absolute inset-0 bg-black/50 rounded-xl",children:e.jsx(Xa,{className:"w-5 h-5 absolute inset-0 m-auto text-amber-500"})})]}),e.jsxs("div",{className:"flex flex-col gap-0.5 min-w-0 flex-1",children:[e.jsx(Dn,{to:`/model/${a}`,target:"_blank",className:"font-bold text-sm break-words",children:u?.title||"(Untitled)"}),l&&s&&e.jsx(Cc,{modelId:a,baseModelType:l,versionId:s,onVersionChange:b=>{f(b)}}),e.jsx(Rc,{weight:n,onChange:p,className:"flex items-center"})]}),e.jsx(H,{onClick:x,className:"rounded-full bg-primary text-hover shadow-sm absolute top-0 right-0 p-1 translate-x-2 -translate-y-2",children:e.jsx(ae,{className:"size-3"})})]})}function Ec(t){const s=et("mlg"),{t:n}=k(["generation","action"]),[a,i]=c.useContext(U),o=a.tab,r=Object.keys(a.selectedModelVersions).length,l=c.useCallback(u=>{i(h=>({...h,tab:u}))},[]),d=c.useCallback(u=>{E("lora_switch_click",{value:u}),l(u)},[o]),m=c.useMemo(()=>[{id:"market",label:n("generation:lora.type.market"),content:e.jsx(Vc,{})},{id:"bookmark",label:n("generation:lora.type.bookmark"),content:e.jsx(Oc,{setTabVal:l})}],[]);return e.jsx(ti,{children:e.jsx(si,{onClose:t.onClose,title:n("generation:lora.list.title"),showModalSheet:s,tabVal:o,tabs:m,onTabChange:d,tabsSuffix:e.jsx(Ac,{}),searchInput:e.jsx(Bc,{tabVal:o}),preview:e.jsx(wc,{className:w("w-full h-[calc(var(--list-height)-68px)] mlg:h-[calc(var(--list-height)+56px)]","mlg:w-72 mlg:border-l mlg:border-background-light"),outsideContextState:t.outsideContextState,setOutsideContext:t.setOutsideContext,onClose:t.onClose},Object.keys(a.selectedModelVersions).join()),openDetail:a.openDetail,onOpenDetailChange:u=>i(h=>({...h,openDetail:u})),action:e.jsxs(e.Fragment,{children:[e.jsx(Zr,{from:"panel-lora"}),e.jsx(O,{color:"primary",href:"/market",target:"_blank",size:"large",startIcon:e.jsx(ni,{}),onClick:()=>{E("browse_mkt_click",{location:"more-model"})},children:n("generation:model.list.market")})]}),detailActionArea:e.jsxs("div",{className:"mlg:hidden absolute bottom-0 left-0 right-0 flex flex-col gap-1 px-4 pt-2 pb-4 bg-background",children:[e.jsxs("div",{className:"text-center text-sm",children:[n("generation:lora.list.currently-selected")," ",e.jsxs("span",{className:w(r>=a.maxAllowedLoras?"text-amber-600":r>=Ut?"text-theme-primary":"text-primary-light"),children:[r,"/",a.maxAllowedLoras]})]}),e.jsx(O,{fullWidth:!0,variant:"contained",onClick:()=>{i(u=>({...u,openDetail:!0}))},children:n("generation:lora.list.open-preview")})]})})})}function Ac(){const{t}=k(["common"]),s=ai(t),n=ii(t),[a,i]=c.useContext(U),o=a.tab,r=c.useMemo(()=>hr(()=>e.jsx(oi,{value:a.marketFilters,onChange:l=>{i(tt(d=>{d.marketFilters=l}))},disabled:{type:!0,modelTypes:!0,baseModelTypes:!0},className:"h-10",hideDisabled:!0})),[a.marketFilters]);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ri,{choices:o==="market"?s:n,onChange:l=>{E("order_click",{value:l,scene:"market"}),i(o==="market"?d=>({...d,marketOrder:l}):d=>({...d,bookmarkListOrder:l}))},value:o==="market"?a.marketOrder:a.bookmarkListOrder,alwaysCollapse:!0}),o==="market"&&e.jsx(r,{})]})}function Dc(t){const[s,n]=c.useContext(U),a=et("mlg");return e.jsx(Qa,{open:t.open,onClose:t.onClose,className:a?"h-[calc(100vh-64px)]":"max-w-[1000px] max-h-[min(calc(100vh-64px),800px)] w-[calc(100vw-64px)]",dismissable:!0,isMobile:a,children:e.jsx(Rn,{defaultValue:s,children:e.jsx(Ec,{onClose:t.onClose,outsideContextState:s,setOutsideContext:n})})})}function Rc(t){const{t:s}=k(["generation"]);c.useEffect(()=>{t.weight==null&&t.onChange?.(te)},[]);const n=(t.weight??0)<0||(t.weight??0)>1;return e.jsxs("div",{className:t.className,children:[e.jsxs("label",{className:"text-xs font-medium text-slate-400 inline-flex gap-0.5 mr-0.5",children:[s("generation:lora.weight"),e.jsx(Xe,{variant:"normal",TooltipProps:{placement:"start"},children:e.jsx("p",{children:s("generation:lora.weight-range.help")})})]}),e.jsxs("div",{className:w("inline-flex gap-2 grow",n&&"text-amber-600"),children:[e.jsx(Se,{color:n?"error":void 0,value:t.weight??te,onChange:(a,i)=>{typeof i=="number"&&t.onChange?.(i)},min:-2,max:2,step:.1,valueLabelDisplay:"auto",size:"small"}),e.jsx(xe,{type:"number",color:n?"error":void 0,className:"w-[4em] text-xs",value:t.weight??te,onChange:a=>{const i=Number(a.target.value);t.onChange?.(pe(i,-2,2))},inputProps:{min:-2,max:2,step:.1}})]})]})}function Fc(){const[{taskModelType:t}]=c.useContext(U),{data:s,isValidating:n}=Za(t?{first:6,modelTypes:[ee.AnyLora],loraBaseModelTypes:[t]}:void 0),a=c.useMemo(()=>ne(s),[s]),{data:i,isValidating:o}=ei(a.length<1&&t?{first:6,types:[ee.AnyLora],loraBaseModelTypes:[t],feed:"trending"}:void 0,{revalidateIfStale:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1}),r=ne(i),d=(a.length>0?a:r).map(m=>e.jsx(gc,{title:m.title,media:m.media,modelId:m.id,modelType:m.type,width:64,height:64,blurCover:!1},m.id));return e.jsx("div",{className:"grid grid-cols-3 gap-2 items-start justify-items-center",children:d})}function Oc(t){const{t:s}=k(["generation"]),[{searchKeyword:n,taskModelType:a,bookmarkListOrder:i}]=c.useContext(U),{data:o}=Y(),r=36,l=vi(i),d=c.useCallback((j,N)=>{if(!o?.id||!a)return;const S=l?N?.pageInfo.endCursor:N?.pageInfo.startCursor,T=Js({before:l?void 0:S,after:l?S:void 0,pageSize:r,isPosSeq:l});return{modelTypes:[ee.AnyLora],loraBaseModelTypes:[a],keyword:n||void 0,...T}},[o?.id,a,l,n]),{data:m,isValidating:u,isLoading:h,setSize:g,mutate:v}=li(d),f=c.useMemo(()=>m?Fn(m.flatMap(N=>{const S=ne(N);return l?S:S.reverse()}),"id"):[],[m,l]),x=c.useMemo(()=>m?.at(-1)?.pageInfo,[m]),p=c.useMemo(()=>m?.at(-1)?.totalCount,[m]),b=c.useMemo(()=>l?x?.hasNextPage:x?.hasPreviousPage,[x,l]),y=c.useCallback(()=>{!u&&b&&g(j=>j+1)},[b,u]),C=c.useCallback(()=>h?e.jsx(ue,{className:"!my-1"}):null,[h]),_=ci({size:"small",actionButtonName:s("generation:model.manage-bookmarks.label"),deleteItem:async j=>{await Ks.markGenerationModel({modelId:j,target:!1,type:wn.Bookmark}),di(j)},beforeDelete:j=>{E("delete_bookmark_click",{type:"lora",number:j.length})},afterDelete:v,dialogTitle:s("generation:model.manage-bookmarks.confirm-title"),dialogContent:s("generation:model.manage-bookmarks.confirm-content"),onActionButtonClick:()=>{E("manage_bookmark_click",{type:"lora"})}});return f.length===0?h?e.jsx("div",{className:"w-full min-h-[360px] h-[var(--list-height)]",children:e.jsx(qs,{fullHeight:!0})}):e.jsx(ft,{scene:"lora",actionType:"search",onGotoClick:()=>t.setTabVal("market"),className:"h-[var(--list-height)]"}):e.jsxs(_n,{className:"relative flex-nowrap",style:{height:"var(--list-height)"},children:[e.jsx("div",{className:w("z-20 sticky top-0 left-0 right-0 px-1 py-3","mlg:absolute mlg:top-auto mlg:bottom-0"),children:_.editItemsAction}),e.jsx(Ys,{className:"-mt-2 mlg:mt-0 mlg:mb-14 w-full min-h-[140px]",totalCount:p,data:f,endReached:y,itemContent:(j,N)=>{const{title:S,media:T,id:P,type:L,refCount:R,isPrivate:$}=N;return _.editing?e.jsx(hc,{title:S,media:T,modelId:P,blurCover:!1,showRefCount:!$,refCount:R,selected:_.selectedItems.includes(P),onToggle:()=>_.toggleSelected(P)},P):e.jsx(Un,{title:S,media:T,modelId:P,blurCover:!1,showRefCount:!$,refCount:R},P)},overscan:200,components:{Footer:C,List:Xs}})]})}function Vc(){const[{searchKeyword:t,taskModelType:s,marketOrder:n,marketFilters:a}]=c.useContext(U),i=c.useRef("");i.current=mi(a);const o=36,[r]=ui(),{posSeq:l,feed:d}=hi({order:n,keyword:t}),m=c.useCallback((_,j)=>{if(!s)return;const N=l?j?.pageInfo.endCursor:j?.pageInfo.startCursor,S=Js({before:l?void 0:N,after:l?N:void 0,pageSize:o,isPosSeq:l}),T=a&&gi(a),{type:P,loraBaseModelTypes:L}=T??{};return{...S,types:Array.isArray(P)?P:[ee.AnyLora],loraBaseModelIds:/^\d+$/.test(a?.baseModelId??"")?[a.baseModelId]:void 0,loraBaseModelTypes:Array.isArray(L)&&L.length>0?L:void 0,category:a?.category||void 0,timeRange:a?.time?fi(a.time):void 0,feed:d,orderBy:xi(n),keyword:t||void 0}},[s,d,l,a,n,t]),{data:u,isValidating:h,isLoading:g,setSize:v}=pi(m,{revalidateFirstPage:!1}),f=c.useMemo(()=>u?Fn(u.flatMap(j=>{const N=ne(j);return l?N:N.reverse()}),"id"):[],[u,l]),x=c.useMemo(()=>u?.at(-1)?.pageInfo,[u]),p=c.useMemo(()=>u?.at(-1)?.totalCount,[u]),b=c.useMemo(()=>l?x?.hasNextPage:x?.hasPreviousPage,[x,l]),y=c.useCallback(()=>{!h&&b&&v(_=>_+1)},[b,h]),C=c.useCallback(()=>g?e.jsx(ue,{className:"!my-1"}):e.jsx(ft,{actionType:"go",scene:"lora",className:"pb-20"}),[g]);return f.length===0?g?e.jsx("div",{className:"w-full min-h-[360px] h-[var(--list-height)]",children:e.jsx(qs,{fullHeight:!0})}):e.jsx(ft,{scene:"lora",showDescription:!0,actionType:"go",className:"h-[var(--list-height)]"}):e.jsx(_n,{style:{height:"var(--list-height)"},children:e.jsx(Ys,{className:"w-full min-h-[140px]",totalCount:p,data:f,endReached:y,itemContent:(_,j)=>{const{title:N,media:S,id:T,type:P,refCount:L}=j;return e.jsx(Un,{title:N,media:S,modelId:T,blurCover:bi(j)&&r,refCount:L,showRefCount:!0},T)},overscan:200,components:{Footer:C,List:Xs}})})}function Bc({tabVal:t,...s}){const{t:n}=k(["generation"]),[{searchKeyword:a},i]=c.useContext(U),o=r=>{r=r.trim(),r&&E("panel_model_search",{fromPath:"lora",location:t,value:r}),i(l=>({...l,searchKeyword:r}))};return e.jsx(ji,{...s,tabVal:t,onInputChange:o,className:w("flex-auto",s.className),onClear:()=>{i(r=>({...r,searchKeyword:""}))},searchKeyword:a,placeholder:n("generation:lora.list.search-placeholder")})}const zc=Nt({base:w("relative inline-flex items-center justify-center px-3 py-1.5 text-sm font-medium transition duration-75 ease-out focus:z-10 focus:outline-none","border border-gray-300 dark:border-zinc-700","bg-white dark:bg-zinc-800","text-gray-700 dark:text-neutral-300","hover:bg-gray-50 dark:hover:bg-zinc-700","data-[pressed]:bg-gray-100 dark:data-[pressed]:bg-zinc-600","data-[selected]:bg-violet-100 dark:data-[selected]:bg-violet-900/50 data-[selected]:border-violet-300 dark:data-[selected]:border-violet-700 data-[selected]:text-violet-700 dark:data-[selected]:text-violet-300","data-[selected]:hover:bg-violet-200 dark:data-[selected]:hover:bg-violet-800/50","data-[selected]:data-[pressed]:bg-violet-200 dark:data-[selected]:data-[pressed]:bg-violet-800/50","data-[focus-visible]:ring-2 data-[focus-visible]:ring-violet-500 data-[focus-visible]:ring-offset-1 dark:data-[focus-visible]:ring-offset-zinc-900","data-[disabled]:opacity-50 data-[disabled]:cursor-not-allowed","not(:first-child):-ml-px","first:rounded-l-md last:rounded-r-md")});function Gn({className:t,children:s,...n}){return e.jsx(jn,{...n,className:w("inline-flex rounded-md shadow-sm",t),children:s})}function $e({className:t,children:s,...n}){return e.jsx(pt,{...n,className:gr(t,(a,i)=>zc({...i,className:a})),children:s})}function Wc(t){const{t:s}=k(["common","artwork"]);return e.jsxs(Gn,{selectionMode:"single",className:w("w-full",t.className),selectedKeys:Ht([t.value??1]),onSelectionChange:n=>{const a=n.values().next().value;a&&t.onChange?.(a)},children:[e.jsx($e,{className:"w-full",id:4,isDisabled:t.enforceSingle,children:s("artwork:generation.multiple-images")}),e.jsx($e,{className:"w-full",id:1,children:s("artwork:generation.single-images")})]})}const $c=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M1 21h22L12 2L1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"})}),Uc=()=>{const{values:t,handleChange:s}=M(),n=zs(t),a=c.useMemo(()=>{const{upscale:o=1,width:r,height:l}=t;return n?!1:o>1&&Math.max(r||0,l||0)*o>1024},[t.upscale,t.width,t.height,n]),i=c.useMemo(()=>{if(a)return!0;const{enlarge:o=1,upscale:r=1,t2i2v:l={enabled:!1}}=t;return!!(o>1||r>1&&n||l.enabled)},[n,t.enlarge,t.upscale,t.t2i2v?.enabled,a]);return c.useEffect(()=>{i&&s("batchSize")(1)},[i]),e.jsx(X,{title:e.jsx(I,{i18nKey:"generation:numbers-of-image.label"}),help:a?e.jsx(I,{i18nKey:"generation:numbers-of-image.disabled-by-size"}):void 0,helpIconProps:{iconComp:$c,iconClassName:"text-amber-500",variant:"normal"},children:e.jsx(Wc,{className:"flex",enforceSingle:i,value:t.batchSize,onChange:o=>{Number.isNaN(o)||(E("number_image_switch",{target:o}),s("batchSize")(o))}})})},Hc=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"m12 8l-6 6l1.41 1.41L12 10.83l4.59 4.58L18 14z"})}),Gc=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.59 8.59L12 13.17L7.41 8.59L6 10l6 6l6-6z"})}),Kc=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"m21.5 9.5l-1.41 1.42L17 7.83v5.67a6.5 6.5 0 0 1-6.5 6.5H4v-2h6.5c2.5 0 4.5-2 4.5-4.5V7.83l-3.09 3.08L10.5 9.5L16 4l5.5 5.5Z"})}),Oe=1,Ve=12,Jc=1;function qc(t){return Pt(W(t)?.modelType)}function Yc(){const{values:t,handleChange:s}=M(),{clipSkip:n,modelId:a}=t,i=W(a)?.modelType,o=!Pt(i),r=c.useRef(o);c.useEffect(()=>{i&&(o?s("clipSkip")(rs):r.current&&s("clipSkip")(ls),r.current=o)},[i,o]),c.useEffect(()=>{(n==null||n<Oe||n>Ve)&&s("clipSkip")(rs)},[n]);const l=e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx(Se,{disabled:o,value:n||ls,onChange:(d,m)=>{s("clipSkip")(m)},min:Oe,max:Ve,step:Jc,valueLabelDisplay:"auto"}),e.jsx(xe,{type:"number",className:"w-[60px]",disabled:o,value:n,onChange:d=>{const m=+d.target.value,u=Math.round(pe(m,Oe,Ve)*10)/10;s("clipSkip")(u)},inputProps:{min:Oe,max:Ve}})]});return e.jsx("div",{className:"flex flex-col gap-4",children:l})}function Xc(){const{values:t,handleChange:s}=M(),{vaeModelId:n="",modelId:a}=t,{t:i}=k(["generation","action"]),o=W(a)?.modelType,{data:r,isLoading:l}=yi(o),d=Qs(o),m=c.useMemo(()=>ne(r).filter(h=>!!h.latestAvailableVersion).sort((h,g)=>(g.extra.weightOffset??0)-(h.extra.weightOffset??0)),[r?.edges?.length]),u=e.jsxs(Pr,{size:"small",value:n,disabled:l||m.length<1||!d,onChange:h=>{s("vaeModelId")(h.target.value)},displayEmpty:!0,children:[e.jsx(bt,{value:"",children:e.jsx("em",{className:"opacity-50",children:i("generation:vae-model.select-placeholder")})}),m.map(h=>e.jsx(bt,{value:h.latestAvailableVersion.id,children:h.title},h.id))]});return e.jsxs("div",{className:"flex flex-col",children:[!d&&e.jsx(Q,{type:Z.Warning,className:"my-2",children:i("generation:vae-model.incompatible-model-used-hint")}),u]})}const re=t=>{const s=t.help?e.jsx(Xe,{TooltipProps:{placement:"start",UNSTABLE_portalContainer:document.getElementById(Ti)},variant:"normal",children:e.jsx("p",{className:"text-sm w-80 whitespace-pre-wrap",children:t.help})}):null;return e.jsxs("section",{children:[e.jsx("header",{children:e.jsxs("h3",{className:"flex items-center gap-2",children:[t.title," ",s]})}),e.jsx("div",{className:"mt-2",children:t.children})]})};function Qc(){const{values:t,handleChange:s}=M(),{t:n}=k(["generation"]);return e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:negative-prompts.label"}),children:e.jsx(Wt,{fullWidth:!0,multiline:!0,minRows:4,maxRows:4,placeholder:n("generation:negative-prompts.placeholder"),value:t.negativePrompts??"",onChange:s("negativePrompts"),onBlur:()=>{E("neg_input_blur")},slotProps:{inputLabel:{shrink:!0}}})})}function Zc(){const{values:t,handleChange:s}=M(),n=W(t.modelId),a=t.lightning,{t:i}=k(["generation"]);return e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:sampling-steps.label"}),help:i("generation:sampling-steps.help"),children:e.jsx(ki,{lightningMode:a,disabled:a,value:t.samplingSteps,handleChange:s,minSamplingSteps:n?.extra?.restrictions?.samplingSteps?.min,maxSamplingSteps:n?.extra?.restrictions?.samplingSteps?.max})})}function ed(){const{values:t,handleChange:s}=M(),n=W(t.modelId),a=n?.modelType,{t:i}=k(["generation"]);return e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:sampling-method.label"}),help:i("generation:sampling-method.help"),children:e.jsx(wi,{value:t.samplingMethod,handleChange:s,modelType:a,hideLabel:!0,allowedSamplingMethods:n?.extra?.restrictions?.samplingMethods?.allowed})})}function td(){const{values:t,handleChange:s}=M(),n=W(t.modelId),a=t.lightning,{state:i}=c.useContext(oe),{t:o}=k(["generation"]);return e.jsx(e.Fragment,{children:i.mode===z.Generate&&e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:cfg-scale.label"}),help:o("generation:cfg-scale.help"),children:e.jsx(Ci,{lightningMode:a,disabled:a,value:t.cfgScale,handleChange:s,minCfgScale:n?.extra?.restrictions?.cfgScale?.min,maxCfgScale:n?.extra?.restrictions?.cfgScale?.max})})})}function sd(){const{values:t,handleChange:s,setValues:n}=M(),a=W(t.modelId),{state:i}=c.useContext(oe),{t:o}=k(["generation"]),r=Ni(a?.extra);return c.useEffect(()=>{r||n(tt(l=>{delete l.inferenceConfig?.modelSampling?.inputs?.shift}))},[r]),r&&i.mode===z.Generate&&r?e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:shift-value.label"}),help:o("generation:shift-value.help"),children:e.jsx(Ii,{value:t.inferenceConfig?.modelSampling?.inputs?.shift??a?.extra?.defaults?.shift,handleChange:s,minShiftValue:a?.extra?.restrictions?.shift?.min,maxShiftValue:a?.extra?.restrictions?.shift?.max,step:a?.extra?.restrictions?.shift?.step})}):null}function nd(){const{values:t,handleChange:s,setValues:n}=M(),a=W(t.modelId),{state:i}=c.useContext(oe),{t:o}=k(["generation"]),r=a?.extra??{},l=Si(r),d=t.inferenceConfig?.rescaleCFG!=null,m=r.defaults?.rescaleCfg?.enabledValue;return c.useEffect(()=>{l||n(tt(u=>{delete u.inferenceConfig?.rescaleCFG}))},[l]),l&&i.mode===z.Generate&&l?e.jsx(re,{title:e.jsx(Mi,{className:"flex items-center",isSelected:d,labelPlacement:"start",size:"small",onChange:u=>{u?s("inferenceConfig.rescaleCFG")(m):s("inferenceConfig.rescaleCFG")(null)},children:e.jsx(I,{i18nKey:"generation:rescale-cfg.label"})}),help:o("generation:rescale-cfg.help"),children:d&&e.jsx(_i,{value:t.inferenceConfig?.rescaleCFG,handleChange:s,minRescaleCfgValue:r?.restrictions?.rescaleCfg?.min,maxRescaleCfgValue:r?.restrictions?.rescaleCfg?.max,step:r?.restrictions?.rescaleCfg?.step})}):null}function ad(t){const{t:s}=k(["generation","action"]),{handleChange:n}=M();return t.seed?e.jsxs("div",{className:"flex  items-center gap-0",children:[e.jsxs("p",{className:"opacity-40 text-xs pl-3",children:[s("generation:seed.task-seed.label"),e.jsxs("span",{className:"text-xs",children:[": ",t.seed]})]}),e.jsx(H,{onClick:()=>{n("seed")(t.seed)},children:e.jsx(Kc,{className:"size-4 opacity-80"})})]}):null}function id(){const{t}=k(["generation","action"]),[s]=c.useContext(he),n=s[0]?.taskId,{data:a}=He(n??se,{context:{refetchOnFocus:!1}}),i=a?.outputs?.detailParameters?.seed,{values:o,handleChange:r}=M(),l=i!=null&&i===o.seed;return e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:seed.label"}),children:e.jsxs("div",{className:"flex flex-col gap-1",children:[l&&e.jsx(Q,{type:Z.Warning,className:"mb-2",children:t("generation:seed.task-seed.warning")}),e.jsx(Wt,{type:"number",size:"small",className:"max-w-[500px]",placeholder:t("generation:seed.placeholder"),value:o.seed??"",onChange:r("seed"),slotProps:{inputLabel:{shrink:!0}}}),e.jsx(ad,{seed:i})]})})}function od(){const{t}=k(["generation"]),{values:s}=M();return qc(s.modelId)?e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:clip-skip.label"}),help:t("generation:clip-skip.help"),children:e.jsx(Yc,{})}):null}function rd(){const{t}=k(["generation"]),{values:s}=M(),n=s.vaeModelId!=null,a=Qs(W(s.modelId)?.modelType);return!n&&!a?null:e.jsx(re,{title:e.jsx(I,{i18nKey:"generation:vae-model.label"}),help:t("generation:vae-model.help"),children:e.jsx(Xc,{})})}const ld=[Qc,Zc,ed,td,sd,nd,id,od,rd],cd=jr(),dd=br("generator::advanced-expanded",!1);function md(){const[t,s]=kn(dd,{store:cd}),n=t?e.jsx("div",{className:"flex flex-col gap-6 mt-4",children:ld.map((a,i)=>e.jsx(a,{},i))}):null;return e.jsx(X,{title:e.jsx(I,{i18nKey:"generation:advanced.label"}),titleSlot:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"size-5 ml-auto flex items-center",children:t?e.jsx(Hc,{}):e.jsx(Gc,{})}),e.jsx("button",{onClick:()=>s(a=>!a),className:"absolute -inset-4"})]}),children:n})}const ud=function(){return e.jsx(X,{className:"flex flex-col gap-2",children:e.jsx(Pi,{})})},hd=Li.debug("pixai:OPEditor");class at extends F.fabric.Circle{constructor(s,n,a,i,o,r=4){super({left:s-r,top:n-r,radius:r,fill:a,stroke:a,strokeWidth:1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1}),this.name=i,this.confidence=o,this.constRadius=r,this.keepConstant={radius:r,scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,flipX:!1,flipY:!1},this.on("removed",this.disconnectAll.bind(this))}static ids=0;id=at.ids++;rc=0;keepConstant;connections=[];incRef(){this.rc++}dispose(s=!1){--this.rc>0&&!s||(this.disconnectAll(),this.canvas?.remove(this))}serialize(){if(!this.get("visible"))return[0,0,0];const s=this.getAbsPoint();return[Math.round(s.x+this.constRadius),Math.round(s.y+this.constRadius),this.confidence]}setRawCoords({x:s,y:n}){s!=null&&this.set("left",s-this.constRadius),n!=null&&this.set("top",n-this.constRadius),this.setCoords(),this.canvas?.requestRenderAll()}connect(s,n){if(!this.canvas)throw new Error("Keypoint is not added to canvas");if(this.connections.some(([i])=>i===s))return!1;const a=new gd(this,s,n);return this.canvas.add(a),this.canvas.sendToBack(a),this.connections.push([s,a]),s.connections.push([this,a]),!0}disconnect(s){const n=this.connections.find(([a])=>a===s);return n?(this.canvas?.remove(n[1]),this.connections=this.connections.filter(([a])=>a!==s),s.connections=s.connections.filter(([a])=>a!==this),!0):!1}disconnectAll(){for(const[s]of this.connections)s.disconnect(this);this.connections=[]}takeConnections(s){const n=[];for(const[a,i]of this.connections)s(a)&&(this.disconnect(a),n.push([a,i]));return n}mergeConnections(s){if(s!==this)for(const[n,a]of s.takeConnections(()=>!0))n===this||this.connections.some(([i])=>i===n)||this.connect(n,a.color)}resolveRotation(s){const n=F.fabric.util.degreesToRadians(s);return[this.constRadius*(1-Math.cos(n)+Math.sin(n)),this.constRadius*(1-Math.sin(n)-Math.cos(n))]}_set(s,n){if(n=this.keepConstant?.[s]??n,this.angle!=0&&queueMicrotask(()=>{const a=this.getPointByOrigin("left","top"),[i,o]=this.resolveRotation(this.angle||0);super._set("angle",0),super._set("left",a.x-i),super._set("top",a.y-o),this.setCoords()}),s==="visible")if(n)for(const[a,i]of this.connections)a.get("visible")&&i.set("visible",!0);else for(const[,a]of this.connections)a.set("visible",!1);return super._set(s,n)}getAbsAngle(){let s=this.angle||0,n=this.group;for(;n;)s+=n.angle||0,n=n.group;return s}getAbsPoint(s=!0){const n=this.getPointByOrigin("left","top");if(s){const[a,i]=this.resolveRotation(-this.getAbsAngle());n.x+=a,n.y+=i}return this.group?F.fabric.util.transformPoint(n,this.group.calcTransformMatrix()):n}refreshConnections(){const s=this.getAbsPoint();for(const[n,a]of this.connections){const i=n.getAbsPoint();let o,r;if(a.group){const l=F.fabric.util.invertTransform(a.group.calcTransformMatrix());o=F.fabric.util.transformPoint(s,l),r=F.fabric.util.transformPoint(i,l)}else o=s,r=i;a.set({x1:o.x+this.constRadius-1.5,y1:o.y+this.constRadius-1.5,x2:r.x+n.constRadius-1.5,y2:r.y+n.constRadius-1.5}),a.setCoords()}}setCoords(s){const n=super.setCoords(s);return this.refreshConnections(),n}}class gd extends F.fabric.Line{constructor(s,n,a){const i=s.getAbsPoint(),o=n.getAbsPoint();super([i.x+s.constRadius-1.5,i.y+s.constRadius-1.5,o.x+n.constRadius-1.5,o.y+n.constRadius-1.5],{stroke:a,strokeWidth:3,opacity:.6,visible:s.get("visible")&&n.get("visible"),selectable:!1,originX:"left",originY:"top"}),this.keypoint1=s,this.keypoint2=n,this.color=a}}class K{constructor(s,n){this.keypoints=s,this.canvas=n;for(const a of s)a.incRef()}static keypointRadius=4;static groupLockScope;static groupLockTrack(s){!this.groupLockScope||this.groupLockScope.map.has(s)||this.groupLockScope.map.set(s,[!!s._group,s._locked])}static groupLockUntrack(s){if(!this.groupLockScope)return;let n=this.groupLockScope;for(;n;)n.map.delete(s),n=n.parent}static groupLockScoped(s){const n=this.groupLockScope;this.groupLockScope={parent:n,map:new Map};try{return s()}finally{for(const[a,[i,o]]of this.groupLockScope.map)i?a.group(!1):a.ungroup(!1),o?a.lock(!1):a.unlock(!1);this.groupLockScope=n}}visible=!0;_group;_locked=!1;dispose(){this.ungroup(!1),K.groupLockUntrack(this);for(const s of this.keypoints)s.dispose();this.keypoints=[]}serialize(){return this.keypoints.flatMap(s=>s.serialize())}group(s=!0){if(this._group)return;s&&K.groupLockTrack(this),this.canvas.discardActiveObject();const n=new F.fabric.Group(this.keypoints,{canvas:this.canvas,visible:this.visible});this._group=n,this.canvas.setActiveObject(n)}ungroup(s=!0){if(this._group){if(this._locked)return this.unlock(s);s&&K.groupLockUntrack(this),this.canvas.discardActiveObject(),this._group.destroy(),this._group=void 0}}lock(s=!0){this._locked||(s&&K.groupLockTrack(this),this.group(),this._group.set({selectable:!1,evented:!1,hasControls:!1,hasBorders:!1}),this._locked=!0)}unlock(s=!0){this._locked&&(s&&K.groupLockUntrack(this),this._group.set({selectable:!0,evented:!0,hasControls:!0,hasBorders:!0}),this._locked=!1)}setVisibility(s){this.visible=s,this._group&&this._group.set("visible",s);for(const n of this.keypoints)n.set("visible",s)}moveBy(s,n,a=!0){this.group(a),this._group.set({left:this._group.left+s,top:this._group.top+n}),this._group.setCoords()}rotate(s,n=this.keypoints[0],a=!0){this.ungroup(a);const i=new F.fabric.Point(n.left,n.top);for(const o of this.keypoints){const r=new F.fabric.Point(o.left,o.top),l=F.fabric.util.rotatePoint(r,i,s);o.set({left:l.x,top:l.y}),o.setCoords()}}scale(s,n=!0){this.group(n),this._group.scale(s),this._group.setCoords()}}function ce(t,s,n){if(s.length!==3*t.keypoints.length)throw new Error("Invalid data length");const a=[];for(let i=0;i<s.length;i+=3){const[o,r,l]=s.slice(i,i+3),d=new at(o,r,t.keypointColors[i/3],t.keypoints[i/3],l,t.keypointRadius);(o===-1||r===-1||l<=1e-6)&&d.set("visible",!1),a.push(d)}n.add(...a);for(const[i,[o,r]]of t.connections.entries())a[o].connect(a[r],t.connectionColors[i]);return new t(a,n)}class Ce extends K{static keypoints=["nose","neck","right_shoulder","right_elbow","right_wrist","left_shoulder","left_elbow","left_wrist","right_hip","right_knee","right_ankle","left_hip","left_knee","left_ankle","right_eye","left_eye","right_ear","left_ear"];static connections=[[0,1],[1,2],[2,3],[3,4],[1,5],[5,6],[6,7],[1,8],[8,9],[9,10],[1,11],[11,12],[12,13],[0,14],[14,16],[0,15],[15,17]];static keypointColors=["#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ff00","#00ff55","#00ffaa","#00ffff","#00aaff","#0055ff","#0000ff","#5500ff","#aa00ff","#ff00ff","#ff00aa","#ff0055"];static connectionColors=this.keypointColors;static defaultJson=[[241,77],[241,120],[191,118],[177,183],[163,252],[298,118],[317,182],[332,245],[225,241],[213,359],[215,454],[270,240],[282,360],[286,456],[232,59],[253,60],[225,70],[260,72]].flatMap(s=>[s[0],s[1],1]);static default(s){return ce(Ce,this.defaultJson,s)}getKeypointByName(s){return this.keypoints[Ce.keypoints.indexOf(s)]}}class J extends K{static keypointRadius=2;static keypoints=["wrist",...["thumb","index","middle","ring","pinky"].flatMap(s=>Array.from({length:4},(n,a)=>s+"_"+(a+1)))];static connections=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20]];static keypointColors=new Array(this.keypoints.length).fill("#0000ff");static connectionColors=this.connections.map((s,n)=>zr({h:n/this.connections.length*360,s:100,v:100,a:1}));static defaultJsonLeft=[[72,139],[50,127],[26,110],[15,90],[0,75],[47,68],[45,41],[43,23],[42,7],[67,63],[65,41],[66,22],[65,0],[82,68],[85,46],[85,28],[85,9],[98,76],[103,60],[107,47],[111,32]].flatMap(s=>[s[0],s[1],1]);static defaultJsonRight=[[37,140],[59,132],[83,117],[100,99],[118,88],[69,70],[72,51],[76,34],[80,17],[48,67],[49,45],[51,21],[54,0],[30,71],[30,45],[31,26],[35,7],[11,79],[8,61],[4,48],[0,34]].flatMap(s=>[s[0],s[1],1]);static default(s,n){return ce(J,n==="left"?this.defaultJsonLeft:this.defaultJsonRight,s)}getKeypointByName(s){return this.keypoints[J.keypoints.indexOf(s)]}meanConnectionLength(){return J.connections.reduce((s,[n,a])=>{const i=this.keypoints[n],o=this.keypoints[a];return s+Math.hypot(i.left-o.left,i.top-o.top)},0)/J.connections.length||0}}class ke extends K{static keypoints=[...[["face_outline",17],["left_eyebrow",5],["right_eyebrow",5],["nose_bridge",4],["nose_bottom",5],["left_eye_outline",6],["right_eye_outline",6],["mouth_outer_bound",12],["mouth_inner_bound",8]].flatMap(([s,n])=>Array.from({length:n},(a,i)=>s+"_"+(i+1))),"left_eyeball","right_eyeball"];static connections=[];static keypointColors=new Array(this.keypoints.length).fill("#ffffff");static connectionColors=[];static default(s){return new this([],s)}getKeypointByName(s){return this.keypoints[ke.keypoints.indexOf(s)]}}const fd=Zs({pose_keypoints_2d:Re(Me(ve()),Fe(Ce.keypoints.length*3)),hand_left_keypoints_2d:ot(rt(Re(Me(ve()),Fe(J.keypoints.length*3)))),hand_right_keypoints_2d:ot(rt(Re(Me(ve()),Fe(J.keypoints.length*3)))),face_keypoints_2d:ot(rt(Re(Me(ve()),Fe(ke.keypoints.length*3))))}),Qt=Zs({canvas_width:ve(),canvas_height:ve(),people:Ei(Me(fd))}),xd={canvas_width:512,canvas_height:512,people:[{pose_keypoints_2d:Ce.defaultJson}]};class Ue{constructor(s,n,a,i,o,r){this.name=s,this.canvas=n,this.body=a,this.leftHand=i,this.rightHand=o,this.face=r;const l=(d,m)=>(d.incRef(),d.mergeConnections(m),m.dispose(),d);i&&(i.keypoints[0]=l(a.getKeypointByName("left_wrist"),i.keypoints[0])),o&&(o.keypoints[0]=l(a.getKeypointByName("right_wrist"),o.keypoints[0])),r&&(r.keypoints[68]=l(a.getKeypointByName("left_eye"),r.keypoints[68]),r.keypoints[69]=l(a.getKeypointByName("right_eye"),r.keypoints[69]))}static ids=0;id=Ue.ids++;visible=!0;dispose(){this.body.dispose(),this.leftHand?.dispose(),this.rightHand?.dispose(),this.face?.dispose()}serialize(){return{pose_keypoints_2d:this.body.serialize(),hand_left_keypoints_2d:this.leftHand?.serialize(),hand_right_keypoints_2d:this.rightHand?.serialize(),face_keypoints_2d:this.face?.serialize()}}static deserialize(s,n,a){const i=ce(Ce,n.pose_keypoints_2d,a),o=n.hand_left_keypoints_2d?ce(J,n.hand_left_keypoints_2d,a):void 0,r=n.hand_right_keypoints_2d?ce(J,n.hand_right_keypoints_2d,a):void 0,l=n.face_keypoints_2d?ce(ke,n.face_keypoints_2d,a):void 0;return new Ue(s,a,i,o,r,l)}keypoints(){return[this.body,this.leftHand,this.rightHand,this.face].filter(n=>!!n).flatMap(n=>n.keypoints)}isKeypointsInvisible(){return this.keypoints().every(s=>!s.visible)}attachHand(s,n){K.groupLockScoped(()=>{const i=this.body.getKeypointByName(`${n}_wrist`),o=this.body.getKeypointByName(`${n}_elbow`),r=s.getKeypointByName("middle_1"),l=s.getKeypointByName("wrist");this.body.ungroup(),s.ungroup();const d=Math.atan2(r.top-l.top,r.left-l.left),u=Math.atan2(i.top-o.top,i.left-o.left)-d;s.rotate(u,l),s.ungroup();const h=Math.hypot(i.left-o.left,i.top-o.top),g=s.meanConnectionLength()*4,v=h*.7/g;s.scale(v),s.ungroup();const f=i.left-l.left,x=i.top-l.top;s.moveBy(f,x);for(const[p,b]of l.takeConnections(y=>s.keypoints.includes(y)))p.connect(i,b.color);i.incRef(),l.dispose()});const a=this[`${n}Hand`];return a&&a.dispose(),this[`${n}Hand`]=s,this.canvas.requestRenderAll(),s}attachDefaultHand(s){const n=J.default(this.canvas,s);return this.attachHand(n,s)}importHand(s,n){const a=n.people?.[0];if(!a)return;const i=s==="left"?a.hand_left_keypoints_2d:a.hand_right_keypoints_2d;if(!i)return;const o=ce(J,i,this.canvas);return this.attachHand(o,s)}attachFace(s){K.groupLockScoped(()=>{const a=this.body.getKeypointByName("left_eye"),i=this.body.getKeypointByName("right_eye"),o=s.getKeypointByName("left_eyeball"),r=s.getKeypointByName("right_eyeball");this.body.ungroup(),s.ungroup();const l=Math.atan2(o.top-r.top,o.left-r.left),m=Math.atan2(a.top-i.top,a.left-i.left)-l;s.rotate(m,a),s.ungroup();const u=Math.hypot(a.left-i.left,a.top-i.top),h=Math.hypot(o.left-r.left,o.top-r.top),g=u/h;s.scale(g),s.ungroup();const v=a.left-o.left,f=a.top-o.top;s.moveBy(v,f);for(const[x,p]of o.takeConnections(b=>s.keypoints.includes(b)))x.connect(a,p.color);a.incRef(),o.dispose();for(const[x,p]of r.takeConnections(b=>s.keypoints.includes(b)))x.connect(i,p.color);i.incRef(),r.dispose()});const n=this.face;return n&&n.dispose(),this.face=s,this.canvas.requestRenderAll(),s}attachDefaultFace(){const s=ke.default(this.canvas);return this.attachFace(s)}importFace(s){const n=s.people?.[0].face_keypoints_2d;if(!n)return;const a=ce(ke,n,this.canvas);return this.attachFace(a)}}class Kn extends Wr($r){constructor(s,n){super(),this.canvasEl=s,this.containerEl=n}width=0;height=0;people=[];init(s){const n=new F.fabric.Canvas(this.canvasEl);n.preserveObjectStacking=!0,this._canvas=n,s.width&&s.height&&this.setSize(s.width,s.height),n.backgroundColor="#000";const a=i=>{const o=i.target;if(!o)return;const r=new Set([o]);for(const l of r)l instanceof at?l.refreshConnections():(l instanceof F.fabric.Group||l instanceof F.fabric.ActiveSelection)&&l.forEachObject(d=>r.add(d))};n.on("object:moving",a),n.on("object:scaling",a),n.on("object:rotating",a),n.on("object:modified",i=>{hd("object:modified %o",i),this.recordHistory()})}dispose(){this._canvas&&(this._canvas.dispose(),this._canvas=void 0)}setSize(s,n){const a=this.containerEl.getBoundingClientRect(),i=a.width/s,o=a.height/n,r=Math.min(i,o),l=r;this.canvas.setDimensions({width:s*r,height:n*r}),this.canvas.setViewportTransform([l,0,0,l,0,0]),this.width=s,this.height=n}serialize(){return{canvas_width:this.width,canvas_height:this.height,people:this.people.map(s=>s.serialize())}}deserialize(s,n=!0){return this.canvas.discardActiveObject(),this.restoreOnError(()=>{this.setSize(s.canvas_width,s.canvas_height);for(const a of this.people)a.dispose();this.people=[],s.people&&(this.people=s.people.map((a,i)=>Ue.deserialize(`Person ${i+1}`,a,this.canvas)))},{save:n})}_saveState(){return this.serialize()}async _restoreState(s){this.deserialize(s,!1),this.afterRestoreState()}async toImageFile(){const s=this.canvas.backgroundImage;this.canvas.backgroundImage=void 0,this.canvas.backgroundColor="#000";const n=this.canvas.toCanvasElement(1/this.canvas.getZoom());s&&await new Promise(i=>this.canvas.setBackgroundImage(s,i)),this.canvas.renderAll();const a=await en(n,"image/png");return a&&fe.fromFile(a)}}async function Zt(t){const s=document.createElement("canvas"),n=document.createElement("div");n.appendChild(s),n.style.position="absolute",n.style.visibility="hidden",n.style.width=t.canvas_width+"px",n.style.height=t.canvas_height+"px",document.body.appendChild(n);const a=new Kn(s,n);a.init({width:t.canvas_width,height:t.canvas_height}),await a.deserialize(t);const i=await a.toImageFile();return a.dispose(),n.remove(),i}const pd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M18 13v7H4V6h5.02c.05-.71.22-1.38.48-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5l-2-2zm-1.5 5h-11l2.75-3.53l1.96 2.36l2.75-3.54zm2.8-9.11c.44-.7.7-1.51.7-2.39C20 4.01 17.99 2 15.5 2S11 4.01 11 6.5s2.01 4.5 4.49 4.5c.88 0 1.7-.26 2.39-.7L21 13.42L22.42 12L19.3 8.89zM15.5 9a2.5 2.5 0 0 1 0-5a2.5 2.5 0 0 1 0 5z"})}),bd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9H13z"})}),jd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6c0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93c0-4.42-3.58-8-8-8zm-6 8c0-1.65.67-3.15 1.76-4.24L6.34 7.34A8.014 8.014 0 0 0 4 13c0 4.08 3.05 7.44 7 7.93v-2.02c-2.83-.48-5-2.94-5-5.91z"})}),vd=t=>e.jsxs("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:[e.jsx("path",{fill:"currentColor",d:"M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"}),e.jsx("path",{fill:"currentColor",d:"M9.03 11.03a3.495 3.495 0 0 0 0 4.95a3.48 3.48 0 0 0 4.13.59l1.88 1.88l1.41-1.41l-1.88-1.88c.71-1.33.53-3.01-.59-4.13a3.495 3.495 0 0 0-4.95 0zm3.53 3.53c-.59.59-1.54.59-2.12 0a1.49 1.49 0 0 1 0-2.12a1.49 1.49 0 0 1 2.12 0c.59.59.59 1.53 0 2.12z"})]});function es(t){return{id:$t(),weight:1,thresholdA:.5,...t}}const[le,yd]=Ye({methods:[],controls:[]});function ts({left:t,right:s}){return e.jsxs("div",{className:"flex flex-col mlg:flex-row w-full h-full overflow-y-scroll mlg:overflow-auto",children:[e.jsx("div",{className:"flex flex-col gap-4 py-5 w-full mlg:w-80 mlg:h-full mlg:overflow-y-scroll mlg:px-2",children:t}),e.jsx("div",{className:"flex-1 flex flex-col mlg:pl-6 pt-5 pb-3 mlg:h-full gap-2",children:s})]})}function ps(t){return Ai.post("/annotate",t)}function ut({children:t,control:s,skipAnnotate:n,selectType:a,...i}){const[o,r]=c.useState(!1),l=c.useRef(null),{t:d}=k(["generation"]),[{methods:m},u]=c.useContext(le),{data:h}=Y(),g=m.find(x=>x.method===s.type),[v,f]=ie(async x=>{try{const p=C=>u(_=>({..._,controls:[..._.controls.map(j=>j.id===s.id?{...j,...C}:j)]})),b=x.mediaId?(await Di({id:x.mediaId})).data.media:void 0;let y=x.file?fe.fromFile(x.file):b?fe.fromMedia(b):void 0;if(!y)throw new Error("Source media does not exist");if(n){p({hint:y});return}if(g.annotateFormats.includes("openpose_json")){const C=await D.promise(y.toMedia({onCompressed(j){y=j}}),{pending:`${d("generation:submit.notice.uploading-image")}`});if(!C)throw new Error("media does not exist");const _=await D.promise(ps({format:"openpose_json",method:g.method,mediaId:C.id,resolution:512}),{pending:`${d("generation:control-net.notice.annotating-image")}`});if(_.data.data){const j=Ri(Qt,_.data.data);if(j.success){const N=await Zt(j.output);p({source:y,hint:N,openposeJson:j.output})}else throw new Error(d("generation:control-net.error.annotate-openpose-invalid-json"))}}else if(g.annotateFormats.includes("hint_image")){const C=await D.promise(y.toMedia({onCompressed(N){y=N}}),{pending:`${d("generation:submit.notice.uploading-image")}`});if(!C)throw new Error("media does not exist");const j=(await D.promise(ps({format:"hint_image",method:g.method,mediaId:C.id,resolution:512}),{pending:`${d("generation:control-net.notice.annotating-image")}`})).data.data.media;j&&p({source:y,hint:fe.fromMedia(j)})}else p({hint:y})}catch(p){if(E("add_control_failed",{error:p.message}),Vr.isAxiosError(p)&&p.response?.status===422&&p.response?.data?.is_black)return D.error(d("generation:control-net.error.image-is-black"));D.error(d("generation:control-net.error.generic",{err:p.message}))}},[s,g,n]);return e.jsxs(e.Fragment,{children:[e.jsx(V,{...i,variant:"outlined",busy:v,onPress:x=>{!h&&g.annotateFormats.length?me(null,{fromPath:"gen-cnet-annotate"}):a==="file-input"?l.current.click():r(!0)},children:t}),e.jsx("input",{ref:l,type:"file",accept:"image/*",hidden:!0,onChange:async x=>{try{const[p]=x.target.files||[];if(!p)return;await f({file:p})}finally{x.target.value=""}}}),e.jsx(Fi,{open:o,onClose:()=>r(!1),onSubmit:x=>f({mediaId:x})})]})}const bs={};function Jn(t){const s=c.useRef(bs);return s.current===bs&&(s.current=t()),s}const kd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M20 11H7.83l5.59-5.59L12 4l-8 8l8 8l1.41-1.41L7.83 13H20v-2z"})}),wd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5s5 2.24 5 5s-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3z"})}),Cd=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M12 7c2.76 0 5 2.24 5 5c0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75c-1.73-4.39-6-7.5-11-7.5c-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28l.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5c1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22L21 20.73L3.27 3L2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65c0 1.66 1.34 3 3 3c.22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53c-2.76 0-5-2.24-5-5c0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15l.02-.16c0-1.66-1.34-3-3-3l-.17.01z"})}),Nd=["dwpose","openpose_full","openpose"];function Id({control:t,onOpenposeEditorClose:s}){const{t:n}=k(["generation"]),[,a]=c.useContext(le),i=t.openposeJson,o=c.useCallback((T,P)=>{a(L=>({...L,controls:L.controls.map(R=>R.id===t.id?{...R,hint:P,openposeJson:T}:R)}))},[t]),r=c.useRef(null),l=c.useRef(null),d=Jn(()=>new WeakSet),m=c.useRef(0);d.current.has(i)||(d.current=new WeakSet,d.current.add(i),m.current++);const[u,h]=c.useState(),g=c.useRef();g.current=u;const[v,f]=c.useState(null),[x,p]=c.useState(!1),[b,y]=c.useState(!1),C=c.useRef(),[_,j]=c.useState(0);c.useEffect(()=>{const T=r.current;if(!T)return;const P=l.current;if(!P)return;const L=new Kn(T,P);return h(L),L.init({width:i.canvas_width,height:i.canvas_height}),L.on("stateChange",async()=>{p(L.canUndo()),y(L.canRedo()),C.current=L.people,j($=>$+1);const R=L.serialize();d.current.add(R),o(R,await L.toImageFile())}),L.canvas.on("selection:created",()=>f(L?.canvas.getActiveObject())),L.canvas.on("selection:updated",()=>f(L?.canvas.getActiveObject())),L.canvas.on("selection:cleared",()=>f(null)),f(L?.canvas.getActiveObject()),L.deserialize(i),()=>{h(void 0),g.current=void 0,L?.dispose()}},[m.current]);const[N,S]=c.useState(!1);return e.jsx(ts,{left:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(O,{className:"px-4 rounded-full",variant:"outlined",size:"small",startIcon:e.jsx(kd,{className:"size-3"}),onClick:s,children:n("generation:control-net.openpose.close")}),e.jsxs("div",{className:"flex",children:[e.jsx(H,{size:"small",disabled:!x,onClick:()=>{u?.undo()},children:e.jsx(En,{})}),e.jsx(H,{size:"small",disabled:!b,onClick:()=>{u?.redo()},children:e.jsx(An,{})})]})]}),e.jsxs("div",{className:"flex flex-col gap-4 py-4",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx("div",{children:e.jsx(Sn,{className:"m-0 gap-4",labelPlacement:"start",label:"Live Preview",control:e.jsx(Lr,{size:"small",checked:N,onChange:T=>S(T.target.checked)})})})}),u&&C.current?.map(T=>e.jsx(Sd,{person:T,editor:u,editorTrigger:_},T.id))]})]}),right:e.jsxs("div",{className:"relative w-full h-full rounded-lg border border-gray-300",children:[e.jsx("div",{className:"focus:outline-none relative flex w-full h-full justify-center items-center",ref:l,tabIndex:1e3,children:e.jsx("canvas",{ref:r})}),u&&N&&e.jsx(Td,{hint:t.hint,editor:u})]})})}function Sd({person:t,editor:s,editorTrigger:n}){const{t:a}=k(["generation"]);return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{children:t.name}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(js,{title:e.jsx("h4",{children:a("generation:control-net.openpose.part.body")}),children:e.jsx(vs,{keypoints:t.body.keypoints,editor:s,editorTrigger:n})}),[["hand-left",e.jsx("h4",{children:a("generation:control-net.openpose.part.left-hand")}),t.leftHand,()=>t.attachDefaultHand("left"),i=>t.importHand("left",i),()=>{t.leftHand.dispose(),t.leftHand=void 0}],["hand-right",e.jsx("h4",{children:a("generation:control-net.openpose.part.right-hand")}),t.rightHand,()=>t.attachDefaultHand("right"),i=>t.importHand("right",i),()=>{t.rightHand.dispose(),t.rightHand=void 0}],["face",e.jsx("h4",{children:a("generation:control-net.openpose.part.face")}),t.face,!1,i=>t.importFace(i),()=>{t.face.dispose(),t.face=void 0}]].map(([i,o,r,l,d,m])=>e.jsx(js,{title:o,children:r?e.jsxs(e.Fragment,{children:[e.jsx(O,{variant:"outlined",onClick:()=>{m(),s.recordHistory()},children:a("action:delete.label")}),e.jsx(vs,{keypoints:r.keypoints,editor:s,editorTrigger:n})]}):e.jsxs("div",{className:"flex gap-2",children:[l&&e.jsx(O,{variant:"outlined",onClick:()=>{l(),s.recordHistory()},children:a("generation:control-net.openpose.part-default")}),e.jsx(O,{variant:"outlined",component:"label",htmlFor:"openpose-json-import-"+i+"-"+t.id,children:a("generation:control-net.openpose.part-import")}),e.jsx("input",{id:"openpose-json-import-"+i+"-"+t.id,type:"file",accept:".json",hidden:!0,onChange:async u=>{try{const[h]=u.target.files||[];if(!h)return;const g=JSON.parse(await h.text()),v=tn(Qt,g);d(v),s.recordHistory()}catch(h){console.log(h),D.error("Invalid OpenPose JSON file")}finally{u.target.value=""}}})]})}))]})]})}function js({title:t,children:s}){const[n,a]=c.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex px-1 gap-1",children:[e.jsx(H,{size:"small",onClick:()=>a(i=>!i),className:"-m-1 p-1",children:e.jsx(Oi,{className:w("transition-transform",!n&&"-rotate-90")})}),t]}),e.jsx(Er,{in:n,timeout:"auto",unmountOnExit:!0,children:s})]})}function vs({keypoints:t,editor:s}){return e.jsx("div",{className:"flex flex-col gap-1",children:t.map(n=>{const[a,i,o]=n.serialize();return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h5",{children:n.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{size:"small",onClick:()=>{n.set("visible",!n.visible),s.recordHistory()},children:n.visible?e.jsx(wd,{}):e.jsx(Cd,{})}),e.jsx(xe,{className:"w-[5ch] px-1",value:a,onChange:r=>{n.setRawCoords({x:+r.target.value}),s.recordHistory()},onBlur:r=>{n.setRawCoords({x:pe(+r.target.value,1,s.width)}),s.recordHistory()}}),e.jsx(xe,{className:"w-[5ch] px-1",value:i,onChange:r=>{n.setRawCoords({y:+r.target.value}),s.recordHistory()},onBlur:r=>{n.setRawCoords({y:pe(+r.target.value,1,s.height)}),s.recordHistory()}})]})]},n.id)})})}const Md="worst quality, low quality, jpeg artifacts, blurry, monochrome, extra digits, bad anatomy",_d="masterpiece, best quality, 1girl";function Td({hint:t,editor:s}){k(["generation"]);const{values:n}=M(),{data:a}=Y(),i=c.useRef();i.current=s,cs(()=>{i.current?._canvas&&(i.current.canvas.backgroundImage=void 0,i.current.canvas.renderAll()),i.current=void 0});const o=n.prompts||_d,r=n.negativePrompts||Md,l=Number(n.seed),d=c.useRef(null),[m,u]=c.useState("idle");return Vi(async()=>{if(!o||!t){u("idle");return}try{const h=await t.toCompressed({maxWidthOrHeight:512,divisibleBy:64}),g=await h.toFile(),{width:v,height:f}=await h.getDimensions();d.current&&d.current?.abort();const x=new AbortController;d.current=x,u("rendering"),E("lcm_pose_to_image_start",{prompts:o,negativePrompts:r,seed:l,width:v,height:f},{destinations:["getway"]});const{data:p}=await Ur({prompts:o,image:g,negativePrompts:r,seed:l||Hr(),width:v,height:f,numOutputs:1,userId:a?.id},{signal:x.signal});i.current&&i.current.canvas.setBackgroundImage("data:image/webp;base64,"+p.data[0].b64_image,()=>i.current?.canvas.renderAll(),{scaleX:i.current.width/v,scaleY:i.current.height/f})}catch(h){if(h.name==="CanceledError")return;D.error("Something went wrong: "+h);return}finally{u("idle"),d.current=null}},2e3,[o,r,t,l,a?.id]),c.useEffect(()=>{!o||!t||u("debouncing")},[o,r,t,l]),cs(()=>{d.current&&d.current?.abort()}),e.jsx(Gr,{status:m})}const Pd=[{method:"reference_only",hintType:"reference_only",demo:"https://images-ng.pixai.art/images/orig/d3a07e09-cce2-4d32-8655-50eb0d7a3436",annotateFormats:[]}],Ld=["inpaint"];function Ed(){const[t,s]=c.useState(!1),n=c.useContext(Os),a=c.useCallback(()=>{s(!0)},[]);return c.useEffect(()=>{n.current={...n.current,openControlNet:a}},[a]),e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs(yd,{defaultValue:{methods:[],controls:[]},children:[e.jsx(Ad,{}),e.jsx(Dd,{openDialog:a}),e.jsx($d,{open:t,onClose:()=>s(!1)})]})})}function qn(t){const s=W(t);return!sn(s?.extra)}function Ad(){const{t}=k(["generation"]),{values:{modelId:s,controlNets:n,ipAdapter:a}}=M(),i=W(s),o=i?.modelType,r=Bi(i?.modelType),l=zi(i?.modelType),[,d]=c.useContext(le),{data:{controlnetMethods:m=[]}={}}=nn(),u=m.length>0,h=a?.enabled,g=c.useMemo(()=>{const f=[...m,...Pd],x=p=>h?Gi.includes(p.method):r?Ki.includes(p.method):l?Ji.includes(p.method):!0;return f.filter(x)},[u,r,l,h]);return c.useEffect(()=>{d(f=>({...f,methods:g}))},[g,h]),qn(s)?h&&!Wi(n??[])?e.jsx(Q,{type:Z.Warning,children:t("generation:control-net.incompatible-ipadapter-used-hint")}):n&&!$i(n,o)?e.jsx(Q,{type:Z.Warning,children:t("generation:control-net.incompatible-model-used-hint")}):null:e.jsx(Q,{type:Z.Warning,children:t("generation:control-net.disabled-by-model-hint")})}function Dd(t){const{values:s}=M(),n=c.useMemo(()=>s.controlNets??[],[s.controlNets]);return n.length>0?e.jsx("div",{className:"flex gap-4",children:n.map(a=>e.jsx(Fd,{control:a,openDialog:t.openDialog},a.mediaId))}):e.jsx(Rd,{openDialog:t.openDialog})}function Rd(t){const{values:{modelId:s}}=M(),n=W(s),{t:a}=k(["generation"]);return e.jsx(V,{variant:"filled",color:"grayish-sidebar",className:"w-full",disabled:sn(n?.extra),onPress:()=>{E("add_control_click"),t.openDialog()},children:a("generation:control-net.add-control")})}function Fd(t){const{mediaId:s,type:n,weight:a}=t.control,{t:i}=k(["generation"]),{setValues:o}=M(),{data:r}=Ne(s),l=be(r),d=u=>{u.stopPropagation(),o(h=>({...h,controlNets:h.controlNets?.filter(g=>g.mediaId!==t.control.mediaId)}))},m=Ld.includes(n);return l?e.jsxs("div",{children:[n&&e.jsxs("h2",{className:w("font-semibold text-xs",m?"cursor-not-allowed":"cursor-pointer"),onClick:()=>{m||t.openDialog()},children:[e.jsxs("p",{className:"font-normal text-neutral-500 h-[2lh] leading-none mb-[2px]",children:[i(`generation:control-net.methods.${n}`),":"," "]}),e.jsx("p",{children:(a||0).toFixed(1)})]}),e.jsx("div",{className:"aspect-square rounded-xl border border-neutral-300 mt-1 max-h-[150px]",children:e.jsxs("div",{className:"flex relative size-full",style:{aspectRatio:Tt(r)},children:[e.jsx(Ie,{mediaId:r?.id,imgClassName:"flex object-contain size-full rounded-xl !object-center",originalUrl:l,fileName:`pixai-controlnet-hint_${s}.${Pe({media:r})}`,width:r?.width,height:r?.height}),e.jsx(H,{className:"rounded-full bg-background shadow-sm absolute top-0 right-0 translate-x-3 -translate-y-3",onClick:d,children:e.jsx(ae,{className:"size-[14px]"})})]})})]}):e.jsx(V,{variant:"filled",color:"grayish-sidebar",className:"w-full",onPress:()=>{E("add_control_click"),t.openDialog()},children:i("generation:control-net.add-control")})}function Od(){const{t}=k(["generation"]),[{methods:s},n]=c.useContext(le);return e.jsxs("div",{className:"flex flex-col gap-4 py-5 h-full",children:[e.jsx("h3",{className:"text-lg font-light",children:t("generation:control-net.method")}),(s??[]).length>0?e.jsx("div",{className:"flex-1 min-h-0 grid grid-cols-2 mlg:grid-cols-4 gap-4 overflow-scroll",children:s.map(({method:a,demo:i})=>e.jsxs(Dr,{className:"flex flex-col",value:a,onClick:()=>{n(o=>({...o,controls:[...o.controls,es({type:a})]}))},children:[e.jsx("img",{className:"w-full aspect-[577/290] rounded-lg",src:i,crossOrigin:"anonymous"}),t(`generation:control-net.methods.${a}`)]},a))}):e.jsx(Ws,{description:t("generation:control-net.no-available-cnets-placeholder")})]})}function Vd({control:t}){const[s,n]=c.useState(!1),a=c.useCallback(()=>{n(!0)},[]),i=c.useCallback(()=>{n(!1)},[]);return t.openposeJson&&s?e.jsx(Id,{control:t,onOpenposeEditorClose:i}):t.source||t.hint||t.mediaId?e.jsx(Bd,{control:t,onOpenposeEditorOpen:a}):e.jsx(zd,{control:t})}function Bd({control:t,onOpenposeEditorOpen:s}){const{t:n}=k(["generation"]),[,a]=c.useContext(le),i=c.useCallback(async()=>{try{await an({title:n("generation:control-net.item.reset-confirm.title"),description:n("generation:control-net.item.reset-confirm.desc")})}catch{return}a(d=>({...d,controls:d.controls.map(m=>m.id===t.id?es({id:t.id,type:m.type}):m)}))},[t]),o=c.useCallback(d=>{a(m=>({...m,controls:m.controls.map(u=>u.id===t.id?{...u,weight:d}:u)}))},[t]),r=c.useCallback(d=>{a(m=>({...m,controls:m.controls.map(u=>u.id===t.id?{...u,thresholdA:d}:u)}))},[t]),l=c.useCallback(async()=>{const d=t.openposeJson;if(!d)return;const m=new Blob([JSON.stringify(d)],{type:"application/json"}),u=URL.createObjectURL(m),h=document.createElement("a");h.href=u,h.download=`pixai-openpose-${t.id}-${Date.now()}.json`,h.click(),URL.revokeObjectURL(u)},[t]);return e.jsx(ts,{left:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(O,{className:"px-4 rounded-full",variant:"outlined",size:"small",startIcon:e.jsx(jd,{}),onClick:i,children:n("generation:control-net.item.reset")})}),t.source&&e.jsx(Gd,{source:t.source}),t.openposeJson&&e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"hidden mlg:inline-flex",variant:"outlined",startIcon:e.jsx(on,{className:"size-5"}),onClick:s,children:n("generation:control-net.openpose.open")}),e.jsx(O,{variant:"outlined",startIcon:e.jsx(rn,{className:"size-5"}),onClick:l,children:n("generation:control-net.openpose.export-json")})]}),e.jsx(ys,{className:"w-full",type:"weight",value:t.weight,onChange:o}),t.type==="reference_only"&&e.jsx(ys,{className:"w-full",type:"threshold",value:t.thresholdA,onChange:r})]}),right:e.jsx(Yn,{control:t})})}function zd({control:t}){const{t:s}=k(["action","generation"]),[{methods:n},a]=c.useContext(le),i=n.find(l=>l.method===t.type),o=c.useCallback(()=>{a(l=>({...l,controls:l.controls.filter(d=>d.id!==t.id)}))},[t]),r=c.useCallback(async()=>{const l=JSON.parse(JSON.stringify(xd)),d=await Zt(l);a(m=>({...m,controls:[...m.controls.map(u=>u.id===t.id?{...u,openposeJson:l,hint:d}:u)]}))},[t]);return e.jsx(ts,{left:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"text-lg font-light",children:s("generation:control-net.init.label")}),e.jsx(O,{className:"mlg:hidden px-4 rounded-full",variant:"outlined",size:"small",startIcon:e.jsx(qi,{className:"size-5"}),onClick:o,children:s("action:delete.label")})]}),e.jsxs("div",{className:w(i.annotateFormats.length?"flex":"hidden","flex-col w-full"),children:[e.jsx(ut,{selectType:"file-input",className:"text-theme-primary border-theme-primary",control:t,startIcon:e.jsx(pd,{className:"size-5"}),children:s("generation:control-net.init.annotate.label")}),e.jsx("div",{className:"mt-0.5 text-primary-light text-xs text-center text-balance",children:s("generation:control-net.init.annotate.desc")})]}),e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsx(ut,{selectType:"task-select",className:"text-theme-primary border-theme-primary",control:t,startIcon:e.jsx(Yi,{className:"size-5"}),children:s("generation:enhance-image.image-select.select-from-task")}),e.jsx("div",{className:"mt-0.5 text-primary-light text-xs text-center text-balance",children:s("generation:control-net.init.select-from-task.desc")})]}),e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsx(ut,{selectType:"file-input",className:w(!i.annotateFormats.length&&"text-theme-primary border-theme-primary"),control:t,startIcon:e.jsx(ln,{className:"size-5"}),skipAnnotate:!0,children:s("generation:control-net.init.upload.label")}),e.jsx("div",{className:"mt-0.5 text-primary-light text-xs text-center text-balance",children:s("generation:control-net.init.upload.desc")})]}),Nd.includes(t.type)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"hidden mlg:flex flex-col w-full",children:[e.jsx(O,{variant:"outlined",startIcon:e.jsx(bd,{className:"size-5"}),onClick:r,children:s("generation:control-net.init.openpose-default.label")}),e.jsx("div",{className:"mt-0.5 text-primary-light text-xs text-center text-balance",children:s("generation:control-net.init.openpose-default.desc")})]}),e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsx(Wd,{control:t}),e.jsx("div",{className:"mt-0.5 text-primary-light text-xs text-center text-balance",children:s("generation:control-net.init.openpose-import.desc")})]})]})]}),right:e.jsx(Yn,{className:"hidden mlg:flex",control:t})})}function Wd({control:t}){const{data:s}=Y(),{t:n}=k(["generation"]),[,a]=c.useContext(le),i=c.useRef(null),[o,r]=ie(async l=>{try{const[d]=l.target.files||[];if(!d)return;const m=JSON.parse(await d.text()),u=tn(Qt,m),h=await Zt(u);a(g=>({...g,controls:[...g.controls.map(v=>v.id===t.id?{...v,openposeJson:u,hint:h}:v)]}))}catch(d){console.error(d),D.error(n("generation:control-net.openpose.error.invalid-json"))}finally{l.target.value=""}},[t]);return e.jsxs(e.Fragment,{children:[e.jsx(V,{variant:"outlined",busy:o,icon:e.jsx(vd,{className:"size-5"}),onPress:l=>{s?i.current.click():me()},children:n("generation:control-net.init.openpose-import.label")}),e.jsx("input",{ref:i,type:"file",accept:".json",hidden:!0,onChange:r})]})}function $d(t){return e.jsx(Ui,{open:t.open,onClose:t.onClose,dialogProps:{maxWidth:!1,style:{zIndex:20},PaperProps:{style:{maxWidth:"1000px",maxHeight:"min(calc(100vh - 64px), 800px)"}}},breakpoint:"mlg",children:e.jsx(Ud,{onClose:t.onClose})})}function Ud(t){const{t:s}=k(["action","generation"]),[{controls:n,loading:a},i]=c.useContext(le),{values:{controlNets:o=[]},setValues:r}=M(),[l,d]=c.useState(0),m=c.useCallback((v,f)=>{d(f)},[]);c.useEffect(()=>{i(v=>({...v,controls:o.map(es)}))},[]);const[u,h]=ie(async()=>{try{const v=(await D.promise(Promise.all(n.map(async f=>{const p=(await f.hint?.toMedia({onCompressed:void 0}))?.id??f.mediaId;if(p)return{type:f.type,mediaId:p,weight:f.weight,...f.type==="reference_only"?{thresholdA:f.thresholdA}:{}}})),{pending:`${s("generation:control-net.notice.saving")}`})).filter(f=>!!f);r(f=>({...f,controlNets:v})),E("add_control_success",{number:v.length}),t.onClose()}catch(v){E("add_control_failed",{error:v.message}),D.error(s("generation:control-net.error.generic",{err:v.message}))}},[n,t.onClose]),g=n??[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:w("flex items-center gap-x-2 mlg:gap-x-6","px-1 mlg:pl-4 mlg:pr-2 h-12","border-b border-background-light"),children:[e.jsx("h2",{className:"pl-2 text-lg font-semibold",children:s("generation:control-net.control-net")}),e.jsxs(Ar,{className:"flex-1 min-w-0",variant:"scrollable",scrollButtons:"auto",value:l,onChange:m,children:[g.map(v=>e.jsx(Hd,{control:v},v.id)),e.jsx(Tn,{className:w("min-w-0",g.length>=3&&"hidden"),label:e.jsx(Hi,{className:"size-5"}),disabled:a,sx:{textTransform:"none"}})]}),e.jsx(H,{className:"hidden mlg:inline-flex",color:"primary",onClick:t.onClose,children:e.jsx(ae,{className:"size-6"})})]}),e.jsx(Nn,{className:w("py-0 h-[calc(100%-48px-52.5px-1px)]","mlg:h-[calc(min(100vh-64px,620px)-48px-52.5px)]"),children:l>=g.length?e.jsx(Od,{}):e.jsx(Vd,{control:g[l]},g[l].id)}),e.jsxs(In,{children:[e.jsx(V,{variant:"outlined",className:"capitalize",disabled:a||u,onPress:t.onClose,children:s("action:cancel")}),e.jsx(V,{variant:"filled",busy:a||u,onPress:h,children:s("action:confirm")})]})]})}function Hd({control:t,...s}){const{t:n}=k(["generation"]),[,a]=c.useContext(le),i=c.useCallback(async()=>{try{await an({title:n("generation:control-net.item.reset-confirm.title"),description:n("generation:control-net.item.reset-confirm.desc")})}catch{return}a(o=>({...o,controls:o.controls.filter(r=>r.id!==t.id)}))},[t]);return e.jsx(Tn,{label:e.jsxs("span",{children:[n(`generation:control-net.methods.${t.type}`),e.jsx(H,{component:"div",className:"hidden mlg:inline-flex ml-px -mr-3 -my-2 w-6 h-6",size:"small",onClick:i,children:e.jsx(ae,{className:"size-4"})})]}),sx:{textTransform:"none"},...s})}function Yn({children:t,control:s,placeholder:n="(Empty)",className:a,...i}){const o=Et(s.hint),{data:r}=Ne(s.mediaId??se),l=o??kt(r),{value:d}=cn(async()=>s.hint?.getDimensions(),[s.hint]),m={width:r?.width,height:r?.height},u=d??m;return e.jsxs("div",{className:w("relative w-full h-full rounded-lg border border-gray-300",a),...i,children:[l?e.jsx(Ie,{mediaId:s.hint?.ifHas("media",h=>h.id),imgClassName:"w-full h-full rounded-lg object-contain !object-center",originalUrl:l,fileName:s.hint?.name??`${r?.id??"media"}.${Pe({media:r})}`,width:u?.width,height:u?.height}):e.jsx("div",{className:"grid place-items-center px-4 w-full h-full text-gray-400 text-xs text-center",children:n}),t]})}function ys({className:t,type:s,value:n,onChange:a}){const{t:i}=k(["generation"]),o=c.useId();return e.jsxs(Mn,{className:t,children:[e.jsxs("div",{className:"inline-flex gap-2 items-center",children:[e.jsx("label",{htmlFor:"weight-select-"+o,className:"text-sm text-stone-500",children:i(`generation:control-net.${s}.label`)}),s==="threshold"&&e.jsx(dn,{iconClassname:"text-sm text-stone-500",children:e.jsx("p",{className:"p-4",children:i("generation:control-net.threshold.help-text")})})]}),e.jsxs("div",{className:"inline-flex gap-8",children:[e.jsx(Se,{id:"weight-select-"+o,value:n,onChange:(r,l)=>{typeof l=="number"&&a(l)},min:0,max:1,step:.1,valueLabelDisplay:"auto"}),e.jsx(xe,{type:"number",className:"w-[60px]",value:n,onChange:r=>{const l=Number(r.target.value);a?.(pe(l,0,1))},inputProps:{min:0,max:1,step:.1}})]})]})}function Gd({source:t}){const{t:s}=k(["generation"]),n=Et(t),{value:a}=cn(()=>t.getDimensions(),[t]);return e.jsx("div",{className:"w-full aspect-square rounded-lg border border-gray-300 overflow-hidden",children:n?e.jsx(Ie,{mediaId:t.ifHas("media",i=>i.id),originalUrl:n,fileName:t.name,imgClassName:"w-full h-full object-contain !object-center",width:a?.width,height:a?.height}):e.jsx("div",{className:"grid place-items-center px-4 w-full h-full text-gray-400 text-xs text-center",children:s("generation:control-net.preview-placeholder")})})}const Kd=function(){const{t}=k(["generation"]),{values:s}=M(),n=c.useMemo(()=>(s.controlNets?.length??0)>0,[s.controlNets]),a=qn(s.modelId);return n||a?e.jsx(X,{title:t("generation:control-net.control-net"),help:e.jsx("img",{className:"w-[400px] min-h-[600px] rounded-lg",src:t("generation:control-net.help-image")}),children:e.jsx(Ed,{})}):null},Jd=function(){const{t}=k(["generation"]),[s,n]=Xi(),{values:a}=M();return e.jsx(X,{className:"flex flex-col gap-2",title:t("generation:model.label"),help:e.jsx("p",{className:"text-sm w-80 whitespace-pre-wrap",children:t("generation:model.help")}),helpIconProps:{variant:"normal"},titleSlot:e.jsx(Qi,{mode:s,setMode:n,className:"ml-auto"}),children:e.jsx(Zi,{modelId:a.modelId})})},Be={draw:[e.jsx(on,{className:"size-6"}),t=>{t.setMode("draw")}],erase:[e.jsx(Rr,{children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.77-.78 2.04 0 2.83L5.03 20h7.66l8.72-8.73c.79-.77.79-2.04 0-2.83l-4.85-4.85c-.39-.39-.91-.59-1.42-.59M17 18l-2 2h7v-2"})})}),t=>{t.setMode("erase")}],select:["select",t=>{t.setMode("select")}]},qd=({editorRef:t,baseImage:s,onCancel:n,onDone:a,onLoading:i,saving:o,tools:r,drawingType:l,colorPicker:d=!0,extraTools:m,overrideToolAction:u})=>{const{t:h}=k(["generation","action","common"]),g=c.useRef(null),v=c.useRef(null),f=c.useMemo(()=>r?sl(Be,r):Be,[r]),[x,p]=c.useState(()=>Object.keys(f)[0]),[b,y]=c.useState(),[C,_]=c.useState("#7cafc27f"),[j,N]=c.useState(!1),[S,T]=c.useState(!1),[P,L]=c.useState(20),R=c.useRef(),[$,ge]=ie(async()=>{R.current&&(R.current.dispose(),R.current=void 0,y(void 0));const B=g.current;if(!B)return;const q=v.current;if(!q)return;const G=new Kr(B,q);y(G),R.current=G,await G.init({width:512,height:512,drawingType:l,baseImage:s}),G.setPencilColor(C),G.setBrushSize(P);const it=Object.keys(f)[0];p(it),(u?.[it]||Be[it]?.[1])?.(G),G.on("stateChange",()=>{N(G.canUndo()),T(G.canRedo())})},[C,P,x,l,s]);c.useEffect(()=>{i?.($)},[$]),c.useEffect(()=>(ge(),()=>{R.current&&(R.current.dispose(),R.current=void 0,y(void 0))}),[l,s]),c.useImperativeHandle(t,()=>b,[b]);const ss=e.jsx(dn,{children:e.jsx("div",{className:"p-4 text-sm w-80 whitespace-pre-wrap",children:h("generation:image-edit.paint.help")})});return e.jsxs("div",{className:"",children:[e.jsxs("div",{className:"flex justify-center items-center gap-2 pb-4 flex-wrap-reverse",children:[ss,m,e.jsx(Pn,{size:"small",exclusive:!0,value:x,onChange:(B,q)=>{p(q);const G=u?.[q]||Be[q]?.[1];b&&G?.(b)},children:Object.entries(f).map(([B,[q]])=>e.jsx(Ln,{value:B,children:e.jsx(je,{title:h("generation:image-edit."+B),children:e.jsx("div",{children:q})},B)},B))}),e.jsxs(hs,{variant:"outlined",children:[e.jsx(je,{title:h("generation:image-edit.undo"),children:e.jsx(O,{className:"px-0",disabled:!j,onClick:()=>{b?.undo()},children:e.jsx(En,{className:"size-6"})})}),e.jsx(je,{title:h("generation:image-edit.redo"),children:e.jsx(O,{className:"px-0",disabled:!S,onClick:()=>{b?.redo()},children:e.jsx(An,{className:"size-6"})})}),e.jsx(je,{title:h("generation:image-edit.clear"),children:e.jsx(O,{className:"px-0",onClick:()=>{b?.clearDrawings(),b?.resetHistory()},children:e.jsx(nl,{className:"size-6"})})})]}),e.jsx(hs,{variant:"outlined",children:e.jsx(je,{title:h("generation:image-edit.brush-size"),children:e.jsx("div",{className:"flex items-stretch",children:e.jsx(Jr,{value:P,onChange:B=>{L(B),b?.setBrushSize(B)}})})})}),d&&e.jsx(je,{title:h("generation:image-edit.brush-color"),children:e.jsx(qr,{className:"flex-shrink-0 min-w-0 w-10 h-10",hex:C,onChange:B=>{_(B),b?.setPencilColor(B)}})}),e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsx(O,{disabled:o,variant:"outlined",onClick:()=>{n?.()},startIcon:e.jsx(ae,{}),children:h("action:cancel")}),e.jsx(O,{disabled:o,variant:"outlined",onClick:()=>{a?.()},startIcon:e.jsx(eo,{}),children:h("common:done")})]})]}),e.jsxs("div",{className:"w-full h-[600px] flex justify-center items-center relative",ref:v,children:[e.jsx("canvas",{ref:g,className:"border w-full"}),o&&e.jsx("div",{className:"bg-background absolute inset-0 flex justify-center items-center",children:e.jsx(to,{})})]})]})};function Yd(t){const{t:s}=k(["artwork"]),[,n]=c.useContext(At),{values:a,setValues:i}=M(),[o,r]=c.useState(),l=a.previewImage??a.baseImage,d=Et(l);c.useEffect(()=>{l?.getDimensions().then(r).catch(u=>console.warn(u))},[l]);const m=()=>{n(u=>({...u,isInpaintOn:!1})),i(u=>({...u,upscale:void 0,upscaleDenoisingSteps:void 0,upscaleDenoisingStrength:void 0,width:void 0,height:void 0,inpaintMaskImage:void 0,baseImage:void 0,previewImage:void 0})),t.onCloseClick?.()};return e.jsx("div",{className:w("flex-auto basis-[50%]",d&&"aspect-square flex items-center justify-center max-w-[50%]"),children:d?e.jsxs("div",{className:"flex relative max-h-[400px] mlg:max-w-[168px] mlg:max-h-[168px] size-full",style:{aspectRatio:Tt(o)},children:[e.jsx(Ie,{originalUrl:d,fileName:l.name,imgClassName:"flex object-contain size-full rounded-xl !object-center",width:o?.width,height:o?.height}),e.jsx(H,{onClick:m,className:"rounded-full bg-background shadow-md absolute top-0 right-0 translate-x-3 -translate-y-3",children:e.jsx(ae,{className:"size-[14px]"})})]}):e.jsxs(we,{variant:"grayish-sidebar",className:w("flex gap-1 w-full"),onClick:d?void 0:t.onClick,children:[e.jsx(ln,{className:"size-6"}),s("generation:image-edit.upload-image")]})})}function Xd(){const{data:t}=Y(),{t:s}=k(["artwork","generation"]),[{showEditor:n,isInpaintOn:a,dirty:i},o]=c.useContext(At),r=j=>o(N=>({...N,showEditor:j})),l=j=>o(N=>({...N,isInpaintOn:j})),d=c.useRef(null),m=c.useRef(null),[u,h]=c.useState(!1),{values:g,setValues:v}=M(),[f,x]=c.useState(),[p,b]=c.useState(),y=Bs();c.useEffect(()=>{g.baseImage&&i&&(x(g.baseImage),o(j=>({...j,dirty:!1})))},[i]),c.useEffect(()=>{g.baseImage?(g.baseImage.getDimensions().then(b).catch(j=>{console.warn(j),b(void 0)}),x(g.baseImage)):(x(void 0),b(void 0))},[g.baseImage]);const[C,_]=ie(async()=>{const j=m.current;if(!j)return;const N=await j.getImage();if(j.drawingType==="inpaint"){const S=await j.getInpaintMaskImage().then(T=>T&&en(T,"inpaintMask.png")).then(T=>T&&fe.fromFile(T));v(T=>({...T,inpaintMaskImage:S,baseImage:j.baseFile,previewImage:N,upscale:void 0}));return}v(S=>({...S,inpaintMaskImage:void 0,baseImage:N,previewImage:N,upscale:void 0}))});return c.useEffect(()=>{const j=m.current;j&&j.resetHistory()},[a,n]),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex gap-4 w-full items-center",children:[e.jsx(Yd,{onClick:()=>{if(!t)return me();d.current?.click(),E("base_image_upload_click",{label:"left"})},showEditor:n,onCloseClick:()=>{b(void 0),x(void 0)}}),e.jsx("input",{ref:d,type:"file",accept:"image/*",hidden:!0,onClick:j=>{j.currentTarget.value=""},onChange:async j=>{const[N]=j.target.files||[];if(!N)return;j.target.files=null;const S=fe.fromFile(N),T=await S.getDimensions();v(P=>({...P,upscale:void 0,upscaleDenoisingSteps:void 0,upscaleDenoisingStrength:void 0,baseImage:S,...so(T),inpaintMaskImage:void 0,previewImage:void 0}))}}),e.jsxs("div",{className:w("flex-auto basis-[50%] flex flex-col gap-4 justify-end",p&&"justify-between"),children:[p&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:s("artwork:generation.size")}),e.jsxs("p",{children:[p.width," x ",p.height]})]}),e.jsxs(we,{variant:"grayish-sidebar",disabled:u,className:"flex gap-1",onClick:async()=>{if(E("base_image_paint_click"),!t)return me();r(!0)},children:[e.jsx(no,{className:"size-5 flex-grow-0"}),s("generation:image-edit.paint.label")]})]})]}),e.jsx(Cn,{open:n,onClose:()=>{r(!1),m.current?.clearChanges()},PaperProps:y?{}:{className:"rounded-lg"},maxWidth:!1,keepMounted:!0,fullScreen:y,children:e.jsx("div",{className:w("p-4",y?"w-full":"min-w-[800px]"),children:e.jsx(qd,{editorRef:m,saving:C,onCancel:()=>{r(!1),m.current?.clearChanges()},onDone:async()=>{await _(),r(!1),m.current?.resetHistory()},onLoading:h,drawingType:a?"inpaint":void 0,baseImage:f,tools:["draw","erase"],extraTools:e.jsx(Pn,{size:"small",value:a?["inpaint"]:[],onChange:(j,N)=>{l(N.includes("inpaint"))},children:e.jsx(Ln,{value:"inpaint",children:e.jsxs("span",{className:"px-2 flex items-center",children:[e.jsx(ao,{className:"size-6"}),e.jsx("span",{className:"pl-2 normal-case",children:s("generation:image-operation.inpaint")})]})})})})})})]})}const Qd=function(){const{values:t,handleChange:s}=M();return e.jsxs(X,{help:e.jsx("p",{className:"text-sm w-80 whitespace-pre-wrap",children:e.jsx(I,{i18nKey:"generation:reference-image.help"})}),helpIconProps:{variant:"normal"},title:e.jsx(I,{i18nKey:"generation:reference-image.label"}),children:[e.jsx(Xd,{}),We(t)==="i2i"&&e.jsx(Zd,{values:t,handleChange:s})]})},Zd=({values:t,handleChange:s})=>{const{t:n}=k(["generation"]),{strength:a}=t;return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-primary-light",children:n("generation:strength.label")}),e.jsxs("div",{className:"flex gap-8",children:[e.jsx(Se,{className:"max-w-[400px]",value:a,onChange:(i,o)=>{s("strength")(o)},min:0,max:1,step:.01,valueLabelDisplay:"auto"}),e.jsx(xe,{type:"number",className:"w-[60px]",value:a,onChange:i=>{const o=+i.target.value;s("strength")(pe(o,0,1))},inputProps:{min:0,max:1,step:.01}})]})]})},em=t=>{document.startViewTransition?document.startViewTransition(t):t()},tm=t=>(c.useEffect(()=>{const s=n=>{const a=`${n.clientX/window.innerWidth*100}%`,i=`${n.clientY/window.innerHeight*100}%`;document.documentElement.style.setProperty("--view-transition-radial-wipe-last-position-x",a),document.documentElement.style.setProperty("--view-transition-radial-wipe-last-position-y",i)};return t.current?.addEventListener("pointerdown",s),()=>{t.current?.removeEventListener("pointerdown",s)}},[t]),c.useCallback(s=>{em(()=>{requestAnimationFrame(()=>{s()})})},[])),ks="w-full md:w-auto px-4 py-1.5 select-none cursor-pointer selected:cursor-default disabled:cursor-not-allowed disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-1.5 active:brightness-75 selected:active:brightness-100 outline-none bg-white hover:bg-neutral-100 dark:bg-neutral-700 dark:hover:bg-neutral-600 border-2 border-solid";function Xn(t){const{channel:s,setChannel:n,type:a="standalone"}=t,i=c.useRef(null),o=tm(i),r=c.useCallback(d=>{o(()=>{n(d)})},[]),{me:l}=Ge();return e.jsxs(jn,{ref:i,selectionMode:"single",disallowEmptySelection:!0,selectedKeys:[s],onSelectionChange:d=>{if(!l?.id)return me({oauthRedirectUrl:t.oauthRedirectUrl},{fromPath:t.signEventFromPath});const m=Array.from(d)[0];m!==s&&(a==="standalone"?r(m):n(m))},className:"flex",children:[e.jsxs(pt,{id:"normal",className:w(ks,"selected:bg-purple-600 dark:selected:bg-purple-600 selected:text-white selected:border-purple-700 dark:selected:border-purple-700","rounded-l-md",a==="inline"?"flex-1 border-neutral-800 selected:border-purple-700":"border-transparent"),children:[e.jsx(io,{className:"inline-block size-4 opacity-90"}),e.jsx(I,{i18nKey:"generation:image-to-video.channels.normal"})]}),e.jsxs(pt,{id:"private",className:w(ks,"selected:bg-neutral-900 dark:selected:bg-neutral-900 selected:text-white selected:border-neutral-800 dark:selected:border-neutral-800","rounded-r-md",a==="inline"?"flex-1 border-purple-700 selected:border-neutral-800":"border-transparent"),children:[e.jsx(oo,{className:"inline-block size-4 opacity-90"}),e.jsx(I,{i18nKey:"generation:image-to-video.channels.private"})]})]})}const sm=function(){const{values:t,handleChange:s}=M(),n=t.t2i2v?.i2vPro?.duration??"5",a=t.t2i2v?.channel;return e.jsxs(X,{help:e.jsx("p",{className:"text-sm w-80 whitespace-pre-wrap",children:e.jsx(I,{i18nKey:"generation:t2i2v.help"})}),helpIconProps:{variant:"normal"},title:e.jsx(I,{i18nKey:"generation:t2i2v.label"}),children:[e.jsx(Xn,{channel:a??"normal",setChannel:s("t2i2v.channel"),oauthRedirectUrl:mn(window.location.origin,"pixai"),signEventFromPath:"t2i2v-pro-private-channel",type:"inline"}),e.jsx(Q,{className:"my-2",type:Z.Warning,children:a==="private"?e.jsx(I,{i18nKey:"generation:t2i2v.professional-mode-warning"}):e.jsx(I,{i18nKey:"generation:t2i2v.incompatible-with-nsfw"})}),e.jsx(xt,{className:"mt-1",children:e.jsx(I,{i18nKey:"generation:image-to-video.parameters.duration.label"})}),e.jsxs(Gn,{selectionMode:"single",className:"w-full",selectedKeys:Ht([n]),onSelectionChange:i=>{const o=i.values().next().value;o&&s("t2i2v.i2vPro.duration")(o)},children:[e.jsx($e,{className:"w-full",id:"5",children:"5s"}),e.jsx($e,{className:"w-full",id:"10",children:"10s"})]})]})},nm=[{condition:({task:t})=>We(t)==="t2i2v",element:sm},{condition:({experiments:t})=>t.worldAndCharacter,element:ud},{condition:({task:t})=>!im(t),element:Qd},{condition:({task:t})=>We(t)==="t2i",element:Ol},{element:Jd},{element:Sc},{condition:({task:t})=>We(t)==="t2i",element:ro},{element:Uc},{element:Kd},{element:Ql},{element:md}],am=nm.map((t,s)=>({...t,id:s}));function We(t){return t.t2i2v?.enabled?"t2i2v":t.baseImage!=null?"i2i":"t2i"}function im(t){return t.ipAdapter?.enabled??!1}const om=function({className:t,style:s}){const{values:n}=M(),a=!!lo(),i={task:n,experiments:{worldAndCharacter:a}};return e.jsxs("div",{className:w("flex flex-col divide-y divide-neutral-300 dark:divide-neutral-700",t),style:s,children:[am.map(o=>{if(o.condition?.(i)??!0)return e.jsx(o.element,{},o.id)}),e.jsx(rm,{className:"flex-none bg-[rgb(var(--bg-color))] border-t border-neutral-300 dark:border-neutral-700 mt-auto sticky bottom-0"})]})};function rm(t){const{data:s}=Y(),n={footerButton:"flex-1 p-5 flex justify-center items-center gap-1 hover:bg-black/10 dark:hover:bg-black/20 transition",footerButtonIcon:"w-5 h-5"};return e.jsxs("div",{className:w("flex",t.className),style:t.style,children:[s&&e.jsx(co,{className:n.footerButton,iconProps:{className:n.footerButtonIcon}}),e.jsx(Tl,{classes:{button:n.footerButton,icon:n.footerButtonIcon}})]})}const ws={workflowLink:"ml-px px-2 py-1 text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/30 rounded-r"};function lm(t){const{data:s}=mo(t.task?.parameters.workflowId);return e.jsxs("p",{className:w("px-2 msm:px-4 pb-2 text-sm text-center",t.className),style:t.style,children:[e.jsx("span",{className:"px-2 py-1 bg-zinc-200 dark:bg-zinc-700 rounded-l last:rounded-r",children:e.jsx(I,{i18nKey:"generation:workflow.workflow-task-hint.message"})}),st(t.task).returnType().with({parameters:{inputs:{}}},()=>Object.keys(t.task.parameters.inputs??{}).length>0,()=>s?.artworkId&&e.jsx(ds,{href:uo(s.artworkId),className:ws.workflowLink,children:e.jsx(I,{i18nKey:"generation:workflow.workflow-task-hint.button-label"})})).with({parameters:{workflowId:A.select(A.string)}},n=>e.jsx(ds,{href:ho(n,!0),className:ws.workflowLink,children:e.jsx(I,{i18nKey:"generation:workflow.workflow-task-hint.button-label",context:"editor"})})).otherwise(()=>null)]})}const cm=c.lazy(()=>al(()=>import("./index-Bs1mJZf-.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]),import.meta.url));function dm(){return e.jsxs("div",{className:"isolate relative flex flex-col w-full min-h-[80svh] flex-1 @container",children:[e.jsx("div",{className:"px-4 py-1",children:e.jsx(_t,{alwaysShowFillTab:!0})}),e.jsx("div",{className:"flex-1 w-full",children:e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"grid place-items-center h-full",children:e.jsx(ue,{})}),children:e.jsx(cm,{})})})]})}function mm(){return e.jsx(go,{children:e.jsx(dm,{})})}const um=t=>{const s=Jn(fo);return e.jsx(Dt.Provider,{value:s,children:t.children})},hm=t=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t,children:e.jsx("path",{fill:"currentColor",d:"M16.05 12.05L21 17l-4.95 4.95l-1.414-1.415L17.172 18H4v-2h13.172l-2.536-2.535zm-8.1-10l1.414 1.414l-2.536 2.535H20v2H6.828l2.536 2.536L7.95 11.95L3 7z"})});function gm(t){const{task:s,trackingArgs:n}=t,a=!As(s),i=Es(s)>0,o=un(s),r=s?.artworkIds?.[0],d=(o?hn(s):void 0)??s?.media?.id,m=xo(d,"orig"),{me:u}=Ge(),[h,g]=St(async()=>{s&&(E("image_dl",{scene:n.scene,authorId:s?.userId,isMyMedia:u?u.id===s?.userId:void 0,artworkId:s?.artworkIds?.[0],mediaId:d}),po({type:"download",action:"confirm",taskId:s.id,taskParams:s.parameters,otherParams:{scene:n.scene,mediaId:d}}),m?await Ds(m,`${wt({task:s})}.${Pe({task:s})}`,{skipConversion:!0}):D.error("Cannot download image"))},[s,d,m,u]);return e.jsxs("div",{className:"flex w-1/2 items-center gap-2 justify-between",children:[i&&r?e.jsx("div",{className:"flex items-center gap-2 ml-auto",children:e.jsx(bo,{artworkId:r,trackingArgs:n})}):e.jsxs(e.Fragment,{children:[a?e.jsx("span",{}):e.jsx(jo,{task:s,scene:"i2vPro",icon:e.jsx(Ct,{className:"size-5"}),className:"shrink-0"}),e.jsx(V,{busy:h.loading,variant:"outlined",onPress:g,children:e.jsx(rn,{className:"size-5"})})]}),u?.isAdmin&&s&&e.jsx(V,{variant:"outlined",color:"admin",onPress:()=>gn(s),children:e.jsx(vo,{className:"size-5"})})]})}function fm(){const{lastResultTaskId:t}=yo(),{data:s}=He(t??se),n=hn(s),a=s?.outputs.detailParameters,i=a?.width&&a.height?{width:a.width,height:a.height}:void 0,{beingAdmin:o}=Ge();return e.jsxs("div",{className:"px-20 mlg:px-4 max-h-[calc(100vh-140px)] flex flex-col w-full justify-center bg-background dark:border-neutral-700",children:[!t&&e.jsx("p",{className:"text-center w-full py-8 text-2xl text-neutral-400 my-auto",children:e.jsx(I,{i18nKey:"generation:enhance-image.result.display-placeholder"})}),t&&!s&&e.jsx(ue,{}),(s?.status==="waiting"||s?.status==="running"||s?.status==="failed")&&e.jsx(e.Fragment,{children:e.jsxs(Ss,{className:w("rounded-lg max-mlg:h-[calc(100dvh-554px)] mlg:my-8",!i&&"w-full h-full"),id:s?.id,status:s.status,contentStyleProps:{className:w("rounded-lg",!i&&"py-8"),style:i?{aspectRatio:(i.width??1)/(i.height??1)}:void 0},children:[s.outputs?.task_status_msg,o&&e.jsx(V,{variant:"filled",color:"admin",onPress:()=>{gn(s)},children:"Inspect"})]})}),e.jsx("div",{id:"i2v-task-result-scroll-into-view"}),n&&e.jsxs("div",{className:"w-full flex flex-col items-center mlg:justify-between mlg:h-full gap-2 py-4",children:[e.jsx(gm,{task:s,trackingArgs:{scene:"generator-animation"}}),e.jsx(ko,{mediaId:n,autoPlay:!0,controls:!0,className:"flex-none w-fit h-fit max-h-full max-w-full rounded-lg"}),e.jsx("div",{className:"hidden mlg:block h-8"})]})]})}const xm=c.memo(Mt),Qn=()=>{const t=To(),s=Po(),[n]=Lo();return!!t?.panelConfig.tailFrame&&!!t.supportsTailFrame&&!s&&!t?.panelConfig.modesWhenTailFrameNotAvailable?.includes(n.mode)};function vt(t,s=!1){const n=de(t),a=de(_e.i2vProTailFrame),i=Rt(),[,o]=c.useContext(he);return c.useCallback(l=>{if(Eo(l.task)){const d=l.task.parameters.i2vPro.mediaId;d&&(n([d]),i(u=>({...u,lastResultTaskId:l.task?.id,lastResultTask:l.task})));const m=l.task.parameters.i2vPro.tailMediaId;a(Ht([m]))}else if(l.media){const d=l.media;n(m=>s&&m.length>0?(a([d.id]),m):[d.id]),i(m=>({...m,lastResultTaskId:l.task?.id,lastResultTask:l.task}))}l.task&&o(Je(l.task)??[])},[s])}function pm(){const t=Rt(),s=yt();c.useEffect(()=>{s.length===0&&t(()=>({}))},[s]);const n=Qn(),a=vt(void 0,n);return e.jsx(xm,{className:"flex-1",onSelectItem:a,enableBatchMediaSelect:!0})}const Cs="border-dashed border-2 border-gray-200 dark:border-gray-600 rounded-3xl h-full";function bm(){const[{mediaId:t,task:s,initialValues:n},a]=Le(),i=Rt(),o=de();return c.useEffect(()=>{t&&o([t]);const r=fn(s),l=xn(n);r?(o([r.parameters.i2vPro.mediaId]),i(d=>({...d,lastResultTaskId:r.id,lastResultTask:r}))):i(d=>({...d,lastResultTaskId:void 0,lastResultTask:void 0})),l&&i(d=>({...d,initialValue:l})),a(d=>({...d,mediaId:null,task:null,initialValues:null}))},[t,s,n,a,o,i]),null}function jm(){const t=c.useMemo(Ts,[]);return e.jsx(wo,{children:e.jsx(Co,{children:e.jsx(Ps.Provider,{value:t,children:e.jsx(vm,{})})})})}function vm(){const[t,s]=c.useContext(No),n=vt(),a=vt(_e.i2vProTailFrame),i=Qn(),o=de(_e.i2vProTailFrame);c.useEffect(()=>{i||o([])},[i,o]);const r=de(),l=de(_e.i2vProTailFrame),d=c.useCallback(()=>{r(m=>{let u=[];return l(h=>(u=h,[...m])),[...u]})},[r,l]);return ym(),e.jsxs(e.Fragment,{children:[e.jsx(bm,{}),e.jsxs(Ee,{id:z.ImageToVideo,className:w("contents",t==="private"&&"dark text-neutral-200"),children:[e.jsx("div",{className:"hidden mlg:flex flex-col mlg:overflow-hidden",style:{gridArea:"left"},children:e.jsx(pm,{})}),e.jsxs("main",{className:"relative flex flex-col min-h-0 mlg:[grid-area:main/2/main/-1] max-mlg:row-end-[-1]",children:[e.jsx(Ke,{className:w("m-3 mlg:hidden","[&>div]:flex [&>div]:flex-col [&>div]:items-center [&>div>p]:text-center","[&>div>a]:mx-auto [&>div>a]:py-1")}),e.jsxs("div",{className:w("px-4 py-1 flex flex-col md:flex-row gap-2 md:justify-between md:items-center",t==="private"&&"bg-neutral-950"),children:[e.jsx(_t,{className:"flex-wrap"}),e.jsx(Xn,{channel:t,setChannel:s,oauthRedirectUrl:mn(window.location.origin,"generator/image/animation"),signEventFromPath:"i2v-pro-private-channel"})]}),e.jsxs("div",{className:"grid grid-rows-[auto_1fr_auto] mlg:grid-rows-none mlg:grid-cols-[2fr_1fr] flex-1 min-h-0 relative",children:[e.jsxs("div",{className:"flex flex-col mlg:grid mlg:grid-cols-2 border-x border-t bg-background dark:border-neutral-700 relative max-h-full mlg:overflow-y-auto",children:[e.jsxs("div",{className:w("grid grid-flow-col gap-2 m-4 mlg:m-6 text-center max-mlg:items-end max-h-[80vh] overflow-hidden",i&&"max-mlg:grid-cols-[1fr_auto_1fr] mlg:grid-rows-[1fr_auto_1fr]"),children:[e.jsxs("div",{className:"flex flex-col gap-2 min-h-0 h-full",children:[e.jsx(jt,{className:Cs,onImageSelect:n,trackingScene:"image-to-video"}),i&&e.jsx("h3",{className:"text-sm mlg:text-base font-semibold max-mlg:truncate",children:e.jsx(I,{i18nKey:"generation:image-to-video.frames.start"})})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(V,{variant:"outlined",className:"w-fit rounded-3xl mlg:mx-auto max-mlg:pr-0",icon:e.jsx(hm,{className:"mlg:rotate-90"}),labelClassName:"hidden mlg:block",onPress:d,children:e.jsx(I,{i18nKey:"generation:image-to-video.action.exchange-frames"})}),e.jsxs("div",{className:"flex flex-col mlg:flex-col-reverse gap-2 min-h-0 h-full",children:[e.jsx(jt,{className:Cs,onImageSelect:a,group:_e.i2vProTailFrame,trackingScene:"image-to-video"}),e.jsx("h3",{className:"text-sm mlg:text-base font-semibold max-mlg:truncate",children:e.jsx(I,{i18nKey:"generation:image-to-video.frames.end"})})]})]})]}),e.jsx(Gt,{className:"hidden mlg:block absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 size-8 text-gray-300 dark:text-gray-700 mlg:rotate-0 rotate-90"}),e.jsx(fm,{})]}),e.jsx(Io,{className:"bg-background mlg:border-l mlg:border-t p-4 pb-0 max-mlg:sticky max-mlg:bottom-0 dark:border-neutral-700 mlg:overflow-y-auto max-mlg:max-h-[min(50vh,calc(100vh-336px))] max-mlg:border-t"})]})]})]})]})}function ym(){const{models:t,defaultModel:s}=So(),[n,a]=Mo({key:"generator::image-to-video-demo-shown",defaultValue:!1,getInitialValueInEffect:!1}),i=c.useMemo(()=>t.find(o=>o.isNew)?.demoVideoId??t.find(o=>o.model===s)?.demoVideoId,[t,s]);c.useEffect(()=>{!n&&i&&(a(!0),_o(i))},[n,i])}function km(t){const{state:s,dispatch:n}=c.useContext(oe);return c.useEffect(()=>{t.type&&s.type!==t.type&&n({type:"set-type",value:t.type})},[t.type,s.type]),e.jsx(Ao,{scene:"image",headerSlot:e.jsxs(e.Fragment,{children:[e.jsx(fr,{value:pn.Image}),e.jsx("span",{className:"ml-auto"})]}),children:e.jsx(wm,{})})}function wm(){const{state:t}=c.useContext(oe);return e.jsxs(Ot,{selectedKey:t.mode,className:"contents",children:[e.jsxs(Vt,{className:"hidden",children:[e.jsx(Te,{id:z.Generate}),e.jsx(Te,{id:z.Fill})]}),(t.mode===z.Fill||t.mode===z.Generate)&&e.jsx(Cm,{}),t.mode===z.EnhanceImage&&e.jsx(_m,{}),t.mode===z.ImageToVideo&&e.jsx(Tm,{})]})}function Cm(){const t=e.jsx("div",{className:"hidden mlg:flex flex-col mlg:overflow-hidden",style:{gridArea:"left"},children:e.jsx(Nm,{className:"flex-1"})});return e.jsx(Do,{children:e.jsx(Ft,{children:e.jsx(Ro,{children:e.jsx(Fo,{children:e.jsxs(Oo,{children:[e.jsx(Em,{}),e.jsxs(um,{children:[e.jsx(bn,{children:e.jsx(Im,{children:t})}),e.jsx(Sm,{children:t})]})]})})})})})}const Nm=c.memo(function(s){return e.jsx(Mt,{...s,enableClickToImportTask:!0})});function Im(t){return e.jsxs(Ee,{id:z.Generate,className:"contents",children:[t.children,e.jsxs("main",{className:"relative flex flex-col grow",style:{gridArea:"main",gridColumnStart:2,gridColumnEnd:-2},children:[e.jsx(Ke,{className:w("m-3 mlg:hidden","[&>div]:flex [&>div]:flex-col [&>div]:items-center [&>div>p]:text-center","[&>div>a]:mx-auto [&>div>a]:py-1")}),e.jsx(Vo,{className:"mlg:hidden"}),e.jsx(Bo,{className:"flex-none bg-background"}),e.jsx(Pm,{}),e.jsx(Zn,{})]}),e.jsxs("div",{className:"relative flex flex-col mlg:border-l border-neutral-300 dark:border-neutral-700 mlg:overflow-hidden",style:{gridArea:"right"},children:[e.jsx(Rm,{}),e.jsx(Mm,{})]})]})}function Sm(t){return e.jsxs(Ee,{id:z.Fill,className:"contents",children:[t.children,e.jsxs("main",{className:"relative flex flex-col grow",style:{gridArea:"main",gridColumnStart:2,gridColumnEnd:-1},children:[e.jsx(Ke,{className:w("m-3 mlg:hidden","[&>div]:flex [&>div]:flex-col [&>div]:items-center [&>div>p]:text-center","[&>div>a]:mx-auto [&>div>a]:py-1")}),e.jsx(mm,{}),e.jsx(Am,{}),e.jsx(Zn,{})]})]})}function Zn(){const{t}=k(["generation"]),{dispatch:s}=c.useContext(oe),n=c.useContext(Dt),a=["image/png","image/jpeg"],[i,o]=c.useState(!1);ye("dragenter",d=>{d.dataTransfer&&[...d.dataTransfer.items].some(m=>a.includes(m.type))&&o(!0)}),ye("dragleave",d=>d.relatedTarget||o(!1)),ye("drop",()=>o(!1));const r=c.useCallback(d=>d.preventDefault(),[]),l=c.useCallback(d=>{if(d.dataTransfer){d.preventDefault();for(const m of d.dataTransfer.files)if(a.includes(m.type)){n.current.setBaseImageFromFile(m,{cate:"drop"}),s({type:"set-mode",value:z.Fill});break}}},[]);return e.jsx(Ns,{children:i&&e.jsx(Is.div,{className:"z-50 absolute inset-0 p-2",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onDragEnter:r,onDragOver:r,onDragLeave:r,onDrop:l,children:e.jsx("div",{className:"grid place-items-center size-full p-4 text-4xl bg-white/80 dark:bg-black/80 rounded-3xl",children:t("generation:drop.fill-editor")})},"fill-drop-overlay")})}function Mm(){const{t}=k(["generation"]),{dispatch:s}=c.useContext(oe),[,n]=c.useContext(At),{setValues:a}=M(),i=["image/png","image/jpeg"],[o,r]=c.useState(!1);ye("dragenter",m=>{m.dataTransfer&&[...m.dataTransfer.items].some(u=>i.includes(u.type))&&r(!0)}),ye("dragleave",m=>m.relatedTarget||r(!1)),ye("drop",()=>r(!1));const l=c.useCallback(m=>m.preventDefault(),[]),d=c.useCallback(m=>{if(m.dataTransfer){m.preventDefault();for(const u of m.dataTransfer.files)if(i.includes(u.type)){a(h=>({...h,baseImage:fe.fromFile(u),inpaintMaskImage:void 0,previewImage:void 0})),n(h=>({...h,dirty:!0})),s({type:"set-mode",value:z.Generate});break}}},[]);return e.jsx(Ns,{children:o&&e.jsx(Is.div,{className:"z-50 absolute inset-0 p-2",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onDragEnter:l,onDragOver:l,onDragLeave:l,onDrop:d,children:e.jsx("div",{className:"grid place-items-center size-full p-4 text-4xl bg-white/80 dark:bg-black/80 rounded-3xl",children:t("generation:drop.base-image")})},"base-image-drop-overlay")})}function _m(){return e.jsx(Ft,{children:e.jsx(yl,{})})}function Tm(){return e.jsx(Ft,{children:e.jsx(bn,{children:e.jsx(jm,{})})})}const Pm=()=>{const[t]=c.useContext(he),{data:s}=He(t[0]?.taskId??se);return e.jsx(zo,{children:e.jsx(Wo,{children:e.jsx($o,{className:"flex-1",toolbar:s&&e.jsx(Lm,{task:s}),action:s&&e.jsx(Ml,{className:"pb-2",task:s})})})})};function Lm(t){return st(t.task).with({status:A.union("waiting","running")},()=>null).with(A.when(un),s=>e.jsx(Nl,{task:s,className:"px-2 msm:px-4 pb-2"})).with(A.when(Uo),s=>e.jsx(lm,{task:s})).otherwise(()=>null)}function Em(){const[,t]=c.useContext(he),[,s]=c.useContext(qe),[,n]=c.useContext(Rs),{setValues:a,setInitialValues:i}=M(),{data:{samplingMethods:o}={},isLoading:r}=nn(),l=c.useRef(!1),[{task:d,artwork:m,character:u,importType:h,showOnStage:g,initialValues:v},f]=Le();c.useEffect(()=>{d&&(l.current=!1)},[d]);const x=fn(d),p=Ho(m),b=Go(u),y=xn(v),{data:C,loading:_}=Ne(Ko(x)??se),j=Object.keys(y?.lora??{})[0],N=y?.modelId,{data:S,isLoading:T}=ms(j),{data:P,isLoading:L}=ms(N),{modelList:R,isLoading:$}=Jo();return c.useEffect(()=>{if(_||T||L||r||$)return;if(l.current){n(!0);return}const ge=C??p?.media,B=qo({artwork:p,task:x,character:b,allowedSamplingMethods:o,baseImageMedia:ge,extraInitialValues:y,loraVersion:S,modelVersion:P,presetModelList:R,options:{isUseAsReference:h==="use_as_reference"}});a(B),i(B),s(p?.id??x?.id),l.current=!0,n(!0),g&&x?.id&&t(Je(x)??[]),f(q=>({...q,task:null,artwork:null,character:null,importType:null,showOnStage:null,initialValues:null}))},[r,_,T,L,$,d]),null}function Am(){const[{media:t},s]=Le(),{data:n}=Ne(Number.isInteger(Number(t))?t:se),[,a]=c.useContext(he),{dispatch:i}=c.useContext(oe),o=c.useContext(Dt),r=c.useRef(!1),l=async d=>{o.current.setBaseImageFromMedia(d,{cate:"qs"}),i({type:"set-mode",value:z.Fill}),a([]),s(m=>({...m,media:null}))};return c.useEffect(()=>{r.current||(n?.id&&l(n),r.current=!0)},[n?.id]),null}function Dm(){const{state:t}=c.useContext(oe);return e.jsxs(e.Fragment,{children:[e.jsx(Yo,{showPriorityCheckbox:!0,className:w("flex-none max-mlg:order-2 max-mlg:sticky top-[44px] bottom-0 bg-[rgb(var(--bg-color))] p-4 z-10 mlg:hidden space-y-2",t.mode!==z.Generate&&"hidden"),id:"workbench-generate-button-intersector"}),e.jsx(om,{className:"flex-1 max-mlg:order-1 mlg:overflow-auto"})]})}const Rm=c.memo(Dm);function fu(){const t=Yr("/generator/:type"),s=Xr(),{t:n}=k(["common"]);Xo({trackingProps:{location:"generator"}});const{data:a,loading:i}=Y(),o=c.useCallback(()=>{lt("generate_source"),lt("generate_id"),lt("generate_task_id")},[]);c.useRef(!0),c.useEffect(()=>(us("generate_id",Qo()),us("generate_task_id",1),window.addEventListener("close",o),()=>{o(),window.removeEventListener("close",o)}),[]);const[{showSignUpModal:r,signupModalRedirect:l},d]=Le(),m=Qr(),u=c.useRef(Zo(m.tab));c.useEffect(()=>{d(g=>({...g,challenge:null,tag:null,mode:null}))},[]);const h=nr(async()=>{me({oauthRedirectUrl:l})});return c.useEffect(()=>{Number(r)&&(i||a||(d(g=>({...g,showSignUpModal:null,signupModalRedirect:null})),h()))},[a?.id,i,r]),e.jsxs(er,{children:[e.jsx(tr,{title:n("common:meta.title.submit-gen"),description:n("common:meta.description.submit-gen")}),e.jsx(sr,{defaultValue:{navigate:s,mode:u.current,type:pn.Image},children:e.jsx(km,{type:t?.params.type})})]})}export{fu as Component};
