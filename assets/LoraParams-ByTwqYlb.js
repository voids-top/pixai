import{hp as ct,e as d,ai as ie,hv as Ce,hs as je,i1 as mt,hw as pe,bi as ut,j as t,H as se,fZ as ve,t as H,P as Y,aP as V,J as de,a8 as $e,u as O,bw as G,B as ne,K as _,le as Ne,g7 as W,gb as X,lf as ce,h as U,C as B,bA as E,fj as te,aB as ft,aG as gt,a6 as me,bj as Me,bD as xt,Q as re,A as ht,U as ue,i as ee,fC as Le,F as Se,fA as Pe,gs as Ie,gt as Oe,a as bt,f4 as pt,bz as we,ch as wt,gg as yt,ge as kt,bE as Ct,lg as jt,b8 as vt,ap as $t,ga as Nt,g0 as Mt,lh as Lt,c4 as St,hg as Pt,e5 as It,bT as Ot,f as Tt,f_ as At,f$ as _t,L as Te,b6 as Ae,li as ye,bd as Dt,be as Ft,g1 as Bt,g2 as Et,g3 as Vt,bB as Rt,g4 as Wt}from"./index-BTMYyhc6.js";import{D as zt,E as Ht,J as Gt,K as Ut,N as Kt,O as Xt,P as Yt,Q as Qt,R as qt,T as Zt,U as Jt,L as ea}from"./index-COYvdw4o.js";import{a as _e}from"./index-Cpf8OWOQ.js";import{g as De}from"./cursorPagingUtils-YTUXhLAt.js";import{av as ta,aw as aa,ax as oa,ay as sa,az as na,aA as ra,af as la,aB as ia,aC as da,aD as ca,aE as ma,aF as ua,d as fa,O as ga,F as xa,aG as le,aH as Fe,f as ha,aI as ba}from"./ArtworkListPage-9LI_MBMs.js";import{N as pa}from"./TrainLoraEvent-ByLNm43A.js";import{i as Be,C as wa,a as ya}from"./ControlSection-BIQjDNv8.js";import{B as ka,C as Ca}from"./BaseCursorPaging-CwwekXMf.js";import{E as ja}from"./Empty-CnG_cY_l.js";import{G as ke,g as va}from"./ModelAssetForm-CSHNk3Nd.js";import{L as A,D as R,d as Ee,N as fe,a as Ve,M as $a}from"./LoraSelectContext-C0mob3fK.js";import{c as Na}from"./contextState-BhHzyxk5.js";import{i as Ma}from"./baseline-cancel-RNUwgBax.js";import{X as La}from"./GeneratorStage-DJGZB2wF.js";import{S as Re}from"./Slider-0j-9tQ0Y.js";import{u as We}from"./uniqBy-DWZdfvgJ.js";(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[s]="e01c0c56-c4fd-418d-a927-b506ed30a349",e._sentryDebugIdIdentifier="sentry-dbid-e01c0c56-c4fd-418d-a927-b506ed30a349")}catch{}})();{var J=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};J._sentryModuleMetadata=J._sentryModuleMetadata||{},J._sentryModuleMetadata[new Error().stack]=Object.assign({},J._sentryModuleMetadata[new Error().stack],{"_sentryBundlerPluginAppKey:pixai-web-app-key":!0})}const ze="Popper",[He,To]=ct(ze),[Sa,Ge]=He(ze),Pa=e=>{const{__scopePopper:s,children:a}=e,[o,l]=d.useState(null);return d.createElement(Sa,{scope:s,anchor:o,onAnchorChange:l},a)},Ia="PopperAnchor",Oa=d.forwardRef((e,s)=>{const{__scopePopper:a,virtualRef:o,...l}=e,n=Ge(Ia,a),i=d.useRef(null),c=Ce(s,i);return d.useEffect(()=>{n.onAnchorChange((o==null?void 0:o.current)||i.current)}),o?null:d.createElement(je.div,ie({},l,{ref:c}))}),Ue="PopperContent",[Ta,Aa]=He(Ue),_a=d.forwardRef((e,s)=>{var a,o,l,n,i,c,r,x;const{__scopePopper:w,side:u="bottom",sideOffset:h=0,align:v="center",alignOffset:f=0,arrowPadding:y=0,collisionBoundary:p=[],collisionPadding:N=0,sticky:P="partial",hideWhenDetached:C=!1,avoidCollisions:b=!0,onPlaced:$,...m}=e,S=Ge(Ue,w),[j,I]=d.useState(null),M=Ce(s,oe=>I(oe)),[L,k]=d.useState(null),T=Ht(L),D=(a=T==null?void 0:T.width)!==null&&a!==void 0?a:0,g=(o=T==null?void 0:T.height)!==null&&o!==void 0?o:0,F=u+(v!=="center"?"-"+v:""),K=typeof N=="number"?N:{top:0,right:0,bottom:0,left:0,...N},xe=Array.isArray(p)?p:[p],Qe=xe.length>0,ae={padding:K,boundary:xe.filter(Ea),altBoundary:Qe},{refs:qe,floatingStyles:he,placement:Ze,isPositioned:Q,middlewareData:z}=Gt({strategy:"fixed",placement:F,whileElementsMounted:Ut,elements:{reference:S.anchor},middleware:[Kt({mainAxis:h+g,alignmentAxis:f}),b&&Xt({mainAxis:!0,crossAxis:!1,limiter:P==="partial"?Yt():void 0,...ae}),b&&Qt({...ae}),qt({...ae,apply:({elements:oe,rects:nt,availableWidth:rt,availableHeight:lt})=>{const{width:it,height:dt}=nt.reference,Z=oe.floating.style;Z.setProperty("--radix-popper-available-width",`${rt}px`),Z.setProperty("--radix-popper-available-height",`${lt}px`),Z.setProperty("--radix-popper-anchor-width",`${it}px`),Z.setProperty("--radix-popper-anchor-height",`${dt}px`)}}),L&&Zt({element:L,padding:y}),Va({arrowWidth:D,arrowHeight:g}),C&&Jt({strategy:"referenceHidden"})]}),[be,Je]=Ke(Ze),q=mt($);pe(()=>{Q&&(q==null||q())},[Q,q]);const et=(l=z.arrow)===null||l===void 0?void 0:l.x,tt=(n=z.arrow)===null||n===void 0?void 0:n.y,at=((i=z.arrow)===null||i===void 0?void 0:i.centerOffset)!==0,[ot,st]=d.useState();return pe(()=>{j&&st(window.getComputedStyle(j).zIndex)},[j]),d.createElement("div",{ref:qe.setFloating,"data-radix-popper-content-wrapper":"",style:{...he,transform:Q?he.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:ot,"--radix-popper-transform-origin":[(c=z.transformOrigin)===null||c===void 0?void 0:c.x,(r=z.transformOrigin)===null||r===void 0?void 0:r.y].join(" ")},dir:e.dir},d.createElement(Ta,{scope:w,placedSide:be,onArrowChange:k,arrowX:et,arrowY:tt,shouldHideArrow:at},d.createElement(je.div,ie({"data-side":be,"data-align":Je},m,{ref:M,style:{...m.style,animation:Q?void 0:"none",opacity:(x=z.hide)!==null&&x!==void 0&&x.referenceHidden?0:void 0}}))))}),Da="PopperArrow",Fa={top:"bottom",right:"left",bottom:"top",left:"right"},Ba=d.forwardRef(function(s,a){const{__scopePopper:o,...l}=s,n=Aa(Da,o),i=Fa[n.placedSide];return d.createElement("span",{ref:n.onArrowChange,style:{position:"absolute",left:n.arrowX,top:n.arrowY,[i]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[n.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[n.placedSide],visibility:n.shouldHideArrow?"hidden":void 0}},d.createElement(zt,ie({},l,{ref:a,style:{...l.style,display:"block"}})))});function Ea(e){return e!==null}const Va=e=>({name:"transformOrigin",options:e,fn(s){var a,o,l,n,i;const{placement:c,rects:r,middlewareData:x}=s,u=((a=x.arrow)===null||a===void 0?void 0:a.centerOffset)!==0,h=u?0:e.arrowWidth,v=u?0:e.arrowHeight,[f,y]=Ke(c),p={start:"0%",center:"50%",end:"100%"}[y],N=((o=(l=x.arrow)===null||l===void 0?void 0:l.x)!==null&&o!==void 0?o:0)+h/2,P=((n=(i=x.arrow)===null||i===void 0?void 0:i.y)!==null&&n!==void 0?n:0)+v/2;let C="",b="";return f==="bottom"?(C=u?p:`${N}px`,b=`${-v}px`):f==="top"?(C=u?p:`${N}px`,b=`${r.floating.height+v}px`):f==="right"?(C=`${-v}px`,b=u?p:`${P}px`):f==="left"&&(C=`${r.floating.width+v}px`,b=u?p:`${P}px`),{data:{x:C,y:b}}}});function Ke(e){const[s,a="center"]=e.split("-");return[s,a]}const Ao=Pa,_o=Oa,Do=_a,Fo=Ba;function Ra(e){const{id:s,modelType:a,trainingTaskStatus:o}=e;return new Promise((l,n)=>{const i=ut({children:t.jsx(za,{modelId:s,onClose:async()=>{var c;await((c=i.current)==null?void 0:c.close()),n(se)},onVersionSelect:async c=>{var r;await((r=i.current)==null?void 0:r.close()),l(c)},modelProps:{modelType:a,trainingTaskStatus:o}}),onClose:()=>{n(se)}})})}const Wa=e=>t.jsx(Ca,{...e,onClickNext:()=>{},onClickPrev:()=>{},className:"mb-0 mt-4"});function za(e){const{modelProps:s}=e,a=d.useRef(!1),o=9,[{before:l,after:n},i]=d.useState({}),c=t.jsxs(t.Fragment,{children:[t.jsx(ka,{useSWR:ve,extraArgs:{modelId:e.modelId},getConnection:r=>r,pageSize:o,renderItem:r=>t.jsx(Ga,{modelProps:{version:r,modelType:s.modelType,trainingTaskStatus:s.trainingTaskStatus},onClick:()=>{if(r.status!==ke.available)return H.info("Selected version is not available yet");e.onVersionSelect(r)}},r.id),renderContainer:({children:r})=>t.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(160px,1fr))] gap-4 max-w-6xl",children:r}),empty:t.jsx(Ha,{}),before:l,after:n,onCursorChange:i,loading:t.jsx(Y,{}),onDataChange:r=>{if(a.current)return;r&&(a.current=!0);const x=V(r);x.length===1&&(x[0].status!==ke.available&&(H.info("All versions are not available yet"),e.onClose()),e.onVersionSelect(x[0]))},PagingButton:Wa}),t.jsx(de,{onClick:e.onClose,className:"absolute top-0 right-0",children:t.jsx($e,{})})]});return t.jsx("div",{className:"p-8",children:c})}function Ha(){const{t:e}=O(["market"]);return t.jsx("div",{className:"p-8",children:t.jsx(ja,{description:e("market:model.versions-empty")})})}function Ga(e){const{t:s}=O(["market"]),{version:a,modelType:o,trainingTaskStatus:l}=e.modelProps,n=G(a.media),i=va(s,{type:o,version:a,trainingTaskStatus:l},{hideIfAvailable:!0});return t.jsxs(ne,{className:"flex flex-col",onClick:e.onClick,children:[t.jsxs("div",{className:"w-40 h-40 relative",children:[t.jsx("img",{src:n,className:"w-full h-full object-cover rounded-t-md"}),i&&t.jsx("span",{className:_("absolute text-xs p-1 rounded-md top-0 left-0 ml-2 mt-2 text-white",i==null?void 0:i.className),children:i==null?void 0:i.label})]}),t.jsx("p",{className:"w-full font-mono font-bold p-1 rounded-xl text-sm truncate",title:a.name,children:a.name}),t.jsx("p",{className:"text-xs",children:new Date(a.updatedAt).toLocaleString()})]})}function ge(e){const{width:s,height:a}=e,o=d.useCallback(l=>{var n,i;l.button!==0||l.ctrlKey||l.metaKey||l.shiftKey||(l.preventDefault(),(n=e.onLabelClick)==null||n.call(e),(i=l.currentTarget.parentElement)==null||i.click())},[e.onLabelClick]);return t.jsx(ft,{disabled:e.disabled,title:e.title,className:"group/label relative m-0 isolate",sx:{margin:0,padding:0},control:t.jsx(gt,{className:_("z-10 absolute top-2 right-2 p-0 rounded text-primary","bg-background translate-x-1/2 -translate-y-1/2"),checked:e.selected,onChange:l=>e.onChange(l.target.checked)}),label:t.jsxs("a",{className:"flex flex-col items-center",tabIndex:-1,href:`https://pixai.art/model/${e.modelId}`,target:"_blank",onClick:o,children:[t.jsxs("div",{className:_("relative rounded-xl m-[3px] overflow-hidden","ring-2 ring-offset-1 ring-transparent ring-offset-background-light","group-[&:has(:focus-visible)]/label:ring-purple-600","dark:group-[&:has(:focus-visible)]/label:ring-purple-400"),style:{width:s-6,height:a-6},children:[t.jsx("img",{className:"rounded-xl w-full h-full object-cover",src:e.previewUrl,loading:"lazy",decoding:"async"}),e.blurCover&&t.jsx(ta,{className:"rounded-xl"}),ce(e.modelType)&&t.jsx("span",{className:"absolute top-0 left-0 px-3 leading-4 text-xs text-white rounded-tl-xl rounded-br-xl bg-purple-700 shadow",children:"XL"}),e.incompatible&&t.jsx(Be,{className:"absolute inset-0 box-content w-5 h-5 p-0.5 m-auto rounded-md text-amber-500 bg-black/70"}),e.showRefCount&&e.refCount!=null&&t.jsx(aa,{refCount:e.refCount})]}),t.jsx("p",{className:"pt-1 h-[44px] leading-5 text-xs font-semibold line-clamp-2 break-all hyphens-auto",style:{width:s},children:e.title})]})})}function Ua(e){const s=me("sm"),{preview:a,media:o,height:l=s?80:120,width:n=s?80:120}=e,i=a??G(o);return!e.versionId&&!e.modelId?t.jsx("div",{style:{height:l,width:n},children:"Model Deleted"}):t.jsx(ge,{selected:e.selected,modelId:e.modelId,modelType:e.modelType,title:e.title,previewUrl:i,width:n,height:l,blurCover:e.blurCover,showRefCount:e.showRefCount,refCount:e.refCount,onChange:e.onToggle})}function Xe(e){const[s,a]=Ne(),[{selectedModelVersions:o,maxAllowedLoras:l,taskModelType:n},i]=d.useContext(A),c=!X(n)!=!ce(e.modelType),r=me("sm"),{title:x,preview:w,media:u,height:h=r?80:120,width:v=r?80:120,modelType:f}=e,y=w??G(u),p=d.useMemo(()=>{const m=e.modelId??e.versionId;return m?Object.keys(o).includes(m):!1},[e.versionId,e.modelId,o]),N=d.useMemo(()=>Object.keys(o).length>=l,[o,l]),P=d.useMemo(()=>N&&!p,[N,p]),[C,b]=U(async m=>{const S=e.versionId,j=e.modelId;if(!j)return H.error("model id not exists");Ee({modelId:j,versionId:S},m,i)},[e.modelId,e.versionId]),$=d.useCallback(()=>{N&&s&&(te({trackingLocation:"chosen-exccessive-lora-dialog"}),a())},[N,s]);return!e.versionId&&!e.modelId?t.jsx("div",{style:{height:h,width:v},children:"Model Deleted"}):t.jsx(ge,{disabled:P,selected:p,modelId:e.modelId,modelType:e.modelType,title:e.title,previewUrl:y,incompatible:c,width:v,height:h,blurCover:e.blurCover,showRefCount:e.showRefCount,refCount:e.refCount,onChange:b,onLabelClick:$})}function Ka(e){const[s,a]=Ne(),{values:o,setValues:l}=W(),[{selectedModelVersions:n,maxAllowedLoras:i,taskModelType:c},r]=d.useContext(A),x=!X(c)!=!ce(e.modelType),{title:w,preview:u,media:h,height:v,width:f}=e,y=u??G(h),p=d.useMemo(()=>{const m=e.modelId;return m?Object.keys(n).includes(m):!1},[e.modelId,n]),N=d.useMemo(()=>{const m=o.lora??{};return Object.keys(m).length>=i},[o.lora,i]),P=d.useMemo(()=>N&&!p,[N,p]),[C,b]=U(async m=>{B("outer_lora_click",{loraId:e.modelId});let S="";const j=e.modelId;let I="";if(!j)return H.error("model id not exists");if(j&&m){const M=await Ra({id:j,modelType:E.Lora});S=M.id,I=M.extra.triggerWords??""}l(M=>{var T,D;const L={...M.lora};if(m){if(!S)return M;L[S]=R}else if(S)delete L[S];else{const g=(T=Object.entries(n).find(([F])=>F===j))==null?void 0:T[1].versionId;if(!g)return M;delete L[g]}let k=M.prompts;if(m&&I)k=[k,I].join(",");else if(k&&!m){const g=(D=Object.entries(n).find(([F])=>F===j))==null?void 0:D[1].triggerWords;g&&(k=k==null?void 0:k.replaceAll(g,"").trim(),k.at(-1)===","&&(k=k.slice(0,-1)))}return{...M,lora:L,prompts:k}}),Ee({modelId:j,triggerWords:I,versionId:S},m,r)},[e.modelId,n]),$=d.useCallback(()=>{N&&s&&(te({trackingLocation:"chosen-exccessive-lora-sidebar"}),a())},[N,s]);return e.modelId?t.jsx(t.Fragment,{children:t.jsx(ge,{selected:p,disabled:P,modelId:e.modelId,modelType:e.modelType,title:e.title,previewUrl:y,incompatible:x,width:f,height:v,blurCover:e.blurCover,onChange:m=>b(m),onLabelClick:$})}):t.jsx("div",{style:{height:v,width:f},children:"Model Deleted"})}function Xa({lora:e,mutate:s}){const{t:a}=O(["market","generation"]),o=e.bookmarked,[l,n]=U(async()=>{try{const i=!o;B(i?"bookmark_click":"delete_bookmark_click",{scene:"lora-select-preview",modelId:e.id}),await ee.markGenerationModel({modelId:e.id,target:i,type:Le.Bookmark}),s==null||s(),H.info(a(i?"market:model.notice.bookmark-success":"market:model.notice.unbookmark-success"))}catch(i){if(i===se)return;H.error(`Failed to bookmark. ${i==null?void 0:i.message}`)}},[o,e.id]);return t.jsx(ue,{variant:"ghost",size:"small",className:"my-1 py-1",busy:l,icon:o?t.jsx(na,{className:"text-purple-600 size-4"}):t.jsx(ra,{className:"size-4"}),onPress:n,children:a(o?"generation:model.preview.bookmarked":"market:model.action.bookmark")})}function Ya({modelId:e,weight:s,onChange:a,...o}){const{t:l}=O(["generation"]),n=d.useMemo(()=>`weight-slider-${e}`,[e]);d.useEffect(()=>{s==null&&(a==null||a(R))},[]);const i=(s??0)<0||(s??0)>1;return t.jsxs(Se,{...o,children:[t.jsxs("label",{htmlFor:n,className:"flex gap-1 text-sm",children:[l("generation:lora.weight"),t.jsx(Pe,{variant:"normal",TooltipProps:{placement:"top"},children:t.jsx("p",{className:"max-w-[36ch]",children:l("generation:lora.weight-range.help")})})]}),t.jsxs("div",{className:_("flex gap-2",i&&"text-amber-600"),children:[t.jsx(Re,{id:n,color:i?"error":void 0,size:"small",valueLabelDisplay:"auto",value:s??R,min:-2,max:2,step:.1,onChange:(c,r)=>{typeof r=="number"&&(a==null||a(r))}}),t.jsx(Ie,{type:"number",className:"w-[4em] text-sm",color:i?"error":void 0,size:"small",value:s??R,inputProps:{min:-2,max:2,step:.1},onChange:c=>{const r=Number(c.target.value);a==null||a(Oe(r,-2,2))}})]})]})}const[Ye,Qa]=Na({});function qa({modelId:e,formLora:s,onChange:a,onRemove:o}){const{t:l}=O(["generation"]),[,n]=d.useContext(Ye),{versionId:i}=s,{data:c,isValidating:r,mutate:x}=xt(e),{data:w,isValidating:u}=ve({modelId:e,first:40}),h=V(w),v=d.useCallback(y=>{a({...s,versionId:y.target.value})},[a,s]),f=d.useMemo(()=>h==null?void 0:h.find(y=>y.id===i),[h,i]);return d.useEffect(()=>{n(y=>{var p;return{...y,[e]:{validating:r||u,triggerWords:(p=f==null?void 0:f.extra)==null?void 0:p.triggerWords}}})},[f,r,u,e,n]),d.useEffect(()=>()=>{n(y=>{const p={...y};return delete p[e],p})},[e,n]),!c||!w?t.jsx("li",{className:"grid place-items-center p-4 h-40",children:t.jsx(Y,{inline:!0})}):t.jsxs("li",{className:"flex flex-col gap-2 p-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"shrink-0 relative",children:[c.media?t.jsx("img",{loading:"lazy",decoding:"async",className:"inline-block align-bottom w-20 h-20 rounded object-cover",src:G(c.media)}):null,t.jsx(de,{className:"absolute top-1 left-1 p-0 text-black bg-white/70 -translate-x-1/2 -translate-y-1/2",size:"small",onClick:o,children:t.jsx(Ma,{})})]}),t.jsxs("div",{className:"h-20 min-w-0",children:[t.jsx(Xa,{lora:c,mutate:x}),t.jsx(re,{to:`https://pixai.art/model/${c.id}`,target:"_blank",children:t.jsx("h4",{className:"line-clamp-2 font-medium break-all",children:c.title})})]})]}),h.length&&i?t.jsxs(t.Fragment,{children:[h.length>1?t.jsx(oa,{versionId:i,versions:h,onChange:v}):null,t.jsx(Ya,{modelId:e,weight:s.weight,onChange:y=>{a==null||a({...s,weight:y})}})]}):t.jsx(ht,{severity:"warning",className:"px-4 py-0",icon:t.jsx(sa,{}),children:l("generation:model.preview.no-version")})]})}function Za({outsideContextState:e,setOutsideContext:s,onClose:a}){const{t:o}=O(["generation"]),{setValues:l}=W(),[n]=d.useContext(A),[i]=d.useContext(Ye),c=Object.entries(n.selectedModelVersions),[r,x]=U(async()=>{const u=c.map(([f,y])=>{var p;return[f,{...y,triggerWords:(p=i[f])==null?void 0:p.triggerWords}]}),h=Object.values(e.selectedModelVersions).map(f=>f.triggerWords).filter(f=>!!(f!=null&&f.length)),v=u.map(([,{triggerWords:f}])=>f).filter(f=>!!(f!=null&&f.length));return l(f=>({...f,lora:Object.fromEntries(u.map(([,{versionId:y,weight:p}])=>[y,p])),prompts:La({prompts:f.prompts,wordsToDelete:h,wordsToAppend:v})})),s(f=>({...f,selectedModelVersions:Object.fromEntries(u)})),B("lora_selected",{loraId:c.map(([f])=>f).join(":"),location:e.tab}),a()},[c,i,e,l,a]),w=Object.values(i).some(u=>u.validating)||r;return t.jsx(ue,{busy:w,disabled:c.some(([,u])=>!u.versionId),variant:"filled",onPress:x,className:"w-full",children:o("generation:lora.preview.confirm")})}function Ja(){const[e]=d.useContext(A),s=Object.entries(e.selectedModelVersions);return t.jsxs("div",{className:_(s.length>=e.maxAllowedLoras?"text-amber-600":s.length>=fe?"text-theme-primary":"text-primary-light"),children:["(",s.length,"/",e.maxAllowedLoras,")"]})}function eo({outsideContextState:e,setOutsideContext:s,onClose:a,...o}){const{t:l}=O(["generation"]),[n,i]=d.useContext(A),c=Object.entries(n.selectedModelVersions),{data:{membership:r}={}}=Me();return t.jsx(Qa,{defaultValue:{},children:t.jsxs("div",{...o,className:_("flex flex-col gap-2",o.className),children:[t.jsxs("div",{className:"flex-1 flex flex-col gap-2 pt-3 px-4 overflow-x-visible overflow-y-auto",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-baseline",children:[t.jsx("h3",{className:"flex-1 text-xl font-medium",children:l("generation:lora.preview.title")}),t.jsx(Ja,{})]}),!r&&t.jsx("button",{className:"text-sm text-theme-primary",onClick:()=>{te({trackingLocation:"lora-use-more"})},children:l("generation:lora.list.use-more")})]}),c.length?t.jsx("ul",{className:"flex flex-col -mx-4 divide-y divide-background-light border-b border-t border-background-light",children:c.map(([x,w])=>t.jsx(qa,{modelId:x,formLora:w,onChange:u=>{i(h=>({...h,selectedModelVersions:{...h.selectedModelVersions,[x]:u}}))},onRemove:()=>{i(u=>{const h={...u.selectedModelVersions};return delete h[x],{...u,selectedModelVersions:h}})}},x))}):t.jsx("div",{className:"grid place-items-center h-32",children:t.jsx("p",{className:"text-gray-500",children:l("generation:lora.preview.no-selection")})})]}),t.jsx("div",{className:"p-4",children:t.jsx(Za,{outsideContextState:e,setOutsideContext:s,onClose:a})})]})})}const to=[E.Lora,E.UserLora],ao=e=>Lt(e==null?void 0:e.extra)?null:St(e==null?void 0:e.modelType).when(X,()=>[E.SdxlLora,E.UserSdxlLora]).when(Pt,()=>[E.Lora,E.UserLora]).otherwise(()=>null);function Bo(){var u;const{validation:e}=W(),s=Array.isArray(e.lora),{t:a}=O(["common","generation"]),[o,l]=d.useState(!1),[{open:n},i]=bt(),[c]=d.useContext(ea),{data:r,isValidating:x}=Me(),w=((u=r==null?void 0:r.membership)==null?void 0:u.privilege.lora)??fe;return d.useEffect(()=>{n==="lora"&&setTimeout(()=>{l(!0),i(h=>({...h,open:null}))},1e3)},[n]),t.jsxs(la,{help:t.jsx("img",{className:"w-[400px] min-h-[600px] rounded-lg",src:a("generation:lora.help")}),title:a("common:ranking.lora.label"),titleSlot:t.jsx(oo,{isMember:pt(r),maxAllowedLoras:w}),className:"flex flex-col gap-2",children:[s&&t.jsx(wa,{type:ya.Warning,children:a("generation:lora.incompatible-lora-used-hint")}),(r==null?void 0:r.membership)===void 0&&x?t.jsx(Y,{}):t.jsxs(Ve,{defaultValue:{selectedModelVersions:{},maxAllowedLoras:w,searchKeyword:"",openDetail:!1,allowedLoraTypes:to,marketOrder:we.trending,bookmarkListOrder:we.newest,tab:"market"},children:[t.jsx(mo,{open:o,onClose:()=>{l(!1)}}),t.jsx(no,{}),t.jsx(fo,{}),t.jsx(so,{}),t.jsx(ro,{openDialog:()=>l(!0)})]},c)]})}function oo(e){const{t:s}=O(["artwork","generation"]),{values:a}=W(),o=Object.keys(a.lora??{}).length;return t.jsxs("p",{className:_("ml-auto text-xs flex items-center gap-1"),children:[t.jsxs("span",{className:_(e.isMember?"text-theme-primary font-semibold":"text-neutral-400 font-medium"),children:[e.isMember?s("generation:lora.max-allowed"):s("generation:lora.free"),": ",o,"/",e.maxAllowedLoras]}),!e.isMember&&t.jsx(ue,{className:"flex items-center gap-1 hover:underline py-0.5 px-1 focus:outline-1 focus:outline-purple-400",variant:"ghost",onPress:()=>{te({defaultMode:"plans",trackingLocation:"genpage-sidebar-lora-more"})},endIcon:t.jsx(wt,{className:"size-4"}),children:t.jsxs("span",{className:"text-theme-primary font-semibold",children:[s("generation:lora.max"),": ",$a]})})]})}function so(){const[,e]=d.useContext(A),{values:{modelId:s}}=W(),a=yt(s),o=ao(a),l=d.useCallback(()=>{e(n=>({...n,allowedLoraTypes:o,taskModelType:a==null?void 0:a.modelType}))},[o]);return d.useEffect(()=>{l()},[a==null?void 0:a.id]),null}function no(){const{values:{lora:e={}}}=W(),s=Object.entries(e??{});return t.jsx(t.Fragment,{children:s.map(([a,o])=>t.jsx(lo,{value:[a,o]},a))})}function ro(e){const{t:s}=O(["generation"]);return t.jsx(kt,{variant:"grayish-sidebar",className:"w-full capitalize",onClick:()=>{e.openDialog()},children:s("generation:lora.show-more-lora")})}function lo(e){var y,p,N;const{t:s}=O(["generation"]),[a,o]=e.value??[],[{selectedModelVersions:l,taskModelType:n},i]=d.useContext(A),{setValues:c}=W(),{data:r,isValidating:x}=Ct(a),w=!jt(n,(y=r==null?void 0:r.model)==null?void 0:y.type),u=G(r==null?void 0:r.media),h=r==null?void 0:r.model;d.useEffect(()=>{const P=r==null?void 0:r.model;P&&i(C=>C.selectedModelVersions[P.id]?C:{...C,selectedModelVersions:{...C.selectedModelVersions,[P.id]:{versionId:a,weight:o,triggerWords:r.extra.triggerWords}}})},[(p=r==null?void 0:r.model)==null?void 0:p.id,a]);const v=d.useCallback(()=>{var C;const P=(C=r==null?void 0:r.extra)==null?void 0:C.triggerWords;c(b=>{if(!b.lora)return b;const $={...b.lora};delete $[a];let m=b.prompts;return m&&P&&(m=m==null?void 0:m.replaceAll(P,"").trim(),m.at(-1)===","&&(m=m.slice(0,-1))),{...b,prompts:m,lora:$}}),i(b=>{const $={...b.selectedModelVersions};return delete $[a],h!=null&&h.id&&delete $[h.id],{...b,selectedModelVersions:$}})},[l,h==null?void 0:h.id,a]),f=d.useCallback(P=>{c(C=>{if(!C.lora)return C;const b={...C.lora};return b[a]=P,{...C,lora:b}})},[a]);return t.jsxs("div",{className:"relative flex gap-3 bg-background-light p-2 rounded-xl",children:[t.jsxs("div",{className:"self-center relative",children:[t.jsx("img",{className:"w-[60px] h-[60px] rounded-xl object-cover",src:u,loading:"lazy",decoding:"async"}),w&&t.jsx("div",{className:"absolute inset-0 bg-black/50 rounded-xl",children:t.jsx(Be,{className:"w-5 h-5 absolute inset-0 m-auto text-amber-500"})})]}),t.jsx("div",{className:"flex flex-col min-w-0 flex-1",children:r?t.jsxs(t.Fragment,{children:[t.jsx(re,{to:`https://pixai.art/model/${r.modelId}`,target:"_blank",className:"font-bold text-sm",children:(N=r.model)==null?void 0:N.title}),t.jsx(re,{to:`https://pixai.art/model/${r.modelId}/${r.id}`,target:"_blank",className:"font-semibold font-mono text-xs text-primary-light",children:r==null?void 0:r.name}),t.jsx(uo,{weight:o,onChange:f,className:"w-full min-w-0"})]}):x?t.jsx(vt,{size:"62px"}):t.jsx("span",{className:"w-full italic",children:s("generation:model.unavailable",{modelName:e.value[0]})})}),t.jsx(de,{onClick:v,className:"rounded-full bg-primary text-hover shadow-sm absolute top-0 right-0 p-1 translate-x-2 -translate-y-2",children:t.jsx($e,{className:"size-3"})})]})}function io(e){const s=me("lg"),{t:a}=O(["generation","action"]),[o,l]=d.useContext(A),n=o.tab,i=Object.keys(o.selectedModelVersions).length,c=d.useCallback(w=>{l(u=>({...u,tab:w}))},[]),r=d.useCallback(w=>{B("lora_switch_click",{value:w}),c(w)},[n]),x=d.useMemo(()=>[{id:"market",label:a("generation:lora.type.market"),content:t.jsx(xo,{})},{id:"bookmark",label:a("generation:lora.type.bookmark"),content:t.jsx(go,{setTabVal:c})}],[]);return t.jsx(ia,{children:t.jsx(da,{onClose:e.onClose,title:a("generation:lora.list.title"),showModalSheet:s,tabVal:n,tabs:x,onTabChange:r,tabsSuffix:t.jsx(co,{}),searchInput:t.jsx(ho,{tabVal:n}),preview:t.jsx(eo,{className:_("w-full h-[calc(var(--list-height)-68px)] mlg:h-[calc(var(--list-height)+56px)]","mlg:w-72 mlg:border-l mlg:border-background-light"),outsideContextState:e.outsideContextState,setOutsideContext:e.setOutsideContext,onClose:e.onClose},Object.keys(o.selectedModelVersions).join()),openDetail:o.openDetail,onOpenDetailChange:w=>l(u=>({...u,openDetail:w})),action:t.jsxs(t.Fragment,{children:[t.jsx(pa,{from:"panel-lora"}),t.jsx(ne,{color:"primary",href:"/market",target:"_blank",size:"large",startIcon:t.jsx(ca,{}),onClick:()=>{B("browse_mkt_click",{location:"more-model"})},children:a("generation:model.list.market")})]}),detailActionArea:t.jsxs("div",{className:"mlg:hidden absolute bottom-0 left-0 right-0 flex flex-col gap-1 px-4 pt-2 pb-4 bg-background",children:[t.jsxs("div",{className:"text-center text-sm",children:[a("generation:lora.list.currently-selected")," ",t.jsxs("span",{className:_(i>=o.maxAllowedLoras?"text-amber-600":i>=fe?"text-theme-primary":"text-primary-light"),children:[i,"/",o.maxAllowedLoras]})]}),t.jsx(ne,{fullWidth:!0,variant:"contained",onClick:()=>{l(w=>({...w,openDetail:!0}))},children:a("generation:lora.list.open-preview")})]})})})}function co(){const{t:e}=O(["common"]),s=ma(e),a=ua(e),[o,l]=d.useContext(A),n=o.tab,i=d.useMemo(()=>It(()=>{var c;return t.jsx(fa,{value:{...o.marketFilters,type:"lora",base:/^\d+$/.test(((c=o.marketFilters)==null?void 0:c.base)??"")?o.marketFilters.base:X(o.taskModelType)?"sdxl":"sdv1"},onChange:r=>{l(Ot(x=>{x.marketFilters=r}))},disabled:{type:!0,base:X(o.taskModelType)?["","sdv1"]:!0},className:"h-10",hideDisabled:!0})}),[o.marketFilters,o.taskModelType]);return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ga,{choices:n==="market"?s:a,onChange:c=>{B("order_click",{value:c,scene:"market"}),l(n==="market"?r=>({...r,marketOrder:c}):r=>({...r,bookmarkListOrder:c}))},value:n==="market"?o.marketOrder:o.bookmarkListOrder,alwaysCollapse:!0}),n==="market"&&t.jsx(i,{})]})}function mo(e){const[s,a]=d.useContext(A);return t.jsx($t,{open:e.open,onClose:e.onClose,dialogProps:{maxWidth:!1,PaperProps:{style:{maxWidth:"1000px",maxHeight:"min(calc(100vh - 64px), 800px)"}}},breakpoint:"lg",children:t.jsx(Ve,{defaultValue:s,children:t.jsx(io,{onClose:e.onClose,outsideContextState:s,setOutsideContext:a})})})}function uo(e){const{t:s}=O(["generation"]);d.useEffect(()=>{var o;e.weight==null&&((o=e.onChange)==null||o.call(e,R))},[]);const a=(e.weight??0)<0||(e.weight??0)>1;return t.jsxs(Se,{className:e.className,children:[t.jsxs("label",{htmlFor:"weight-select",className:"text-xs font-medium text-slate-400 inline-flex gap-1",children:[s("generation:lora.weight"),t.jsx(Pe,{variant:"normal",TooltipProps:{placement:"start"},children:t.jsx("p",{children:s("generation:lora.weight-range.help")})})]}),t.jsxs("div",{className:_("inline-flex gap-2 w-full",a&&"text-amber-600"),children:[t.jsx(Re,{id:"weight-select",color:a?"error":void 0,value:e.weight??R,onChange:(o,l)=>{var n;typeof l=="number"&&((n=e.onChange)==null||n.call(e,l))},min:-2,max:2,step:.1,valueLabelDisplay:"auto",size:"small"}),t.jsx(Ie,{type:"number",color:a?"error":void 0,className:"w-[4em] text-xs",value:e.weight??R,onChange:o=>{var n;const l=Number(o.target.value);(n=e.onChange)==null||n.call(e,Oe(l,-2,2))},inputProps:{min:-2,max:2,step:.1}})]})]})}function fo(){const[{allowedLoraTypes:e}]=d.useContext(A),{data:s,isValidating:a}=Nt(e?{first:6,modelTypes:e}:void 0),o=d.useMemo(()=>V(s),[s]),{data:l,isValidating:n}=Mt(o.length<1&&e?{first:6,types:e,feed:"trending",isNsfw:!1}:void 0,{revalidateIfStale:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1}),i=V(l),r=(o.length>0?o:i).map(x=>t.jsx(Ka,{title:x.title,media:x.media,modelId:x.id,modelType:x.type,width:64,height:64,blurCover:!1},x.id));return t.jsx("div",{className:"grid grid-cols-3 gap-2 items-start justify-items-center",children:r})}function go(e){const{t:s}=O(["generation"]),[{searchKeyword:a,allowedLoraTypes:o,bookmarkListOrder:l}]=d.useContext(A),{data:n}=Tt(),[i,c]=d.useState(!0),[r,x]=d.useState([]),[w,u]=d.useState(),h=d.useRef(),v=36,[f,y]=U(async(b=v,$,m)=>{var S,j,I,M,L;if(n!=null&&n.id)try{const k=At(m),T=De({before:k?void 0:h.current,after:k?h.current:void 0,pageSize:b,isPosSeq:k}),D=o?await ee.listMyBookmarkedGenerationModels({modelTypes:o,keyword:$||void 0,...T}):void 0,g=(S=D==null?void 0:D.me)==null?void 0:S.bookmarkedGenerationModels,F=k?V(g):V(g).reverse();x(K=>We([...K,...F],"id")),u(g==null?void 0:g.totalCount),c(k?!!((j=g==null?void 0:g.pageInfo)!=null&&j.hasNextPage):!!((I=g==null?void 0:g.pageInfo)!=null&&I.hasPreviousPage)),h.current=k?(M=g==null?void 0:g.pageInfo)==null?void 0:M.endCursor:(L=g==null?void 0:g.pageInfo)==null?void 0:L.startCursor}catch(k){console.error("bookmarked model list",k)}},[n==null?void 0:n.id,o]),p=d.useCallback((b,$)=>{x([]),u(void 0),c(!0),h.current=void 0,y(void 0,b,$)},[y]);d.useEffect(()=>{p(a,l)},[n==null?void 0:n.id,a,l]);const N=d.useCallback(()=>{i&&y(void 0,a,l)},[i,a,l]),P=d.useCallback(()=>f?t.jsx(Y,{className:"!my-1"}):null,[f]),C=xa({size:"small",actionButtonName:s("generation:model.manage-bookmarks.label"),deleteItem:async b=>{await ee.markGenerationModel({modelId:b,target:!1,type:Le.Bookmark}),_t(b)},beforeDelete:b=>{B("delete_bookmark_click",{type:"lora",number:b.length})},afterDelete:p,dialogTitle:s("generation:model.manage-bookmarks.confirm-title"),dialogContent:s("generation:model.manage-bookmarks.confirm-content"),onActionButtonClick:()=>{B("manage_bookmark_click",{type:"lora"})}});return r.length===0?f?t.jsx("div",{className:"w-full min-h-[360px] h-[var(--list-height)]",children:t.jsx(Te,{fullHeight:!0})}):t.jsx(le,{scene:"lora",actionType:"search",onGotoClick:()=>e.setTabVal("market"),className:"h-[var(--list-height)]"}):t.jsxs(Ae,{className:"relative flex-nowrap",style:{height:"var(--list-height)"},children:[t.jsx("div",{className:_("z-20 sticky top-0 left-0 right-0 px-1 py-3","mlg:absolute mlg:top-auto mlg:bottom-0"),children:C.editItemsAction}),t.jsx(_e,{className:"-mt-2 mlg:mt-0 mlg:mb-14 w-full min-h-[140px]",totalCount:w,data:r,endReached:N,itemContent:(b,$)=>{const{title:m,media:S,id:j,type:I,refCount:M,isPrivate:L,latestAvailableVersion:k}=$;return C.editing?t.jsx(Ua,{title:m,media:S,modelType:I,modelId:j,versionId:k==null?void 0:k.id,blurCover:!1,showRefCount:!L,refCount:M,selected:C.selectedItems.includes(j),onToggle:()=>C.toggleSelected(j)},j):t.jsx(Xe,{title:m,media:S,modelType:I,modelId:j,versionId:k==null?void 0:k.id,blurCover:!1,showRefCount:!L,refCount:M},j)},overscan:200,components:{Footer:P,List:Fe}})]})}function xo(){const[{searchKeyword:e,allowedLoraTypes:s,marketOrder:a,marketFilters:o}]=d.useContext(A),l=d.useRef("");l.current=ye(o);const[n,i]=d.useState(!0),[c,r]=d.useState([]),[x,w]=d.useState(),u=d.useRef(),h=36,[v]=Dt(),[f]=Ft(),[y,p]=U(async(C=h,b,$,m)=>{var S,j,I,M;try{const L=Bt($),k=De({before:L?void 0:u.current,after:L?u.current:void 0,pageSize:C,isPosSeq:L}),T=m&&ha(m),D=s?await ee.listGenerationModels({...k,...!m||Array.isArray(T)?{types:T||s}:{type:T||E.AnyLora},baseModelId:/^\d+$/.test((m==null?void 0:m.base)??"")?m.base:void 0,category:m==null?void 0:m.category,feed:Et($),orderBy:Vt($),timeRange:m!=null&&m.time?Rt(m.time):void 0,keyword:b||void 0,isNsfw:v?void 0:!1}):void 0;if(ye(m)!==l.current)return;const g=D==null?void 0:D.generationModels,F=L?V(g):V(g).reverse();r(K=>We([...K,...F],"id")),w(g==null?void 0:g.totalCount),i(L?!!((S=g==null?void 0:g.pageInfo)!=null&&S.hasNextPage):!!((j=g==null?void 0:g.pageInfo)!=null&&j.hasPreviousPage)),u.current=L?(I=g==null?void 0:g.pageInfo)==null?void 0:I.endCursor:(M=g==null?void 0:g.pageInfo)==null?void 0:M.startCursor}catch(L){console.error("bookmarked model list",L)}},[v,s]);d.useEffect(()=>{r([]),w(void 0),i(!0),u.current=void 0,p(h,e,a,o)},[e,a,o]);const N=d.useCallback(()=>{n&&p(void 0,e,a,o)},[e,a,o,n]),P=d.useCallback(()=>y?t.jsx(Y,{className:"!my-1"}):t.jsx(le,{actionType:"go",scene:"lora",className:"pb-20"}),[y]);return c.length===0?y?t.jsx("div",{className:"w-full min-h-[360px] h-[var(--list-height)]",children:t.jsx(Te,{fullHeight:!0})}):t.jsx(le,{scene:"lora",showDescription:!0,actionType:"go",className:"h-[var(--list-height)]"}):t.jsx(Ae,{style:{height:"var(--list-height)"},children:t.jsx(_e,{className:"w-full min-h-[140px]",totalCount:x,data:c,endReached:N,itemContent:(C,b)=>{const{title:$,media:m,id:S,type:j,refCount:I,latestAvailableVersion:M}=b;return t.jsx(Xe,{title:$,media:m,modelType:j,modelId:S,versionId:M==null?void 0:M.id,blurCover:Wt(b)&&f,refCount:I,showRefCount:!0},S)},overscan:200,components:{Footer:P,List:Fe}})})}function ho({tabVal:e,...s}){const{t:a}=O(["generation"]),[{searchKeyword:o},l]=d.useContext(A),n=i=>{B("panel_model_search",{fromPath:"lora",location:e,value:i}),l(c=>({...c,searchKeyword:i}))};return t.jsx(ba,{...s,tabVal:e,onInputChange:n,className:_("flex-auto",s.className),onClear:()=>{l(i=>({...i,searchKeyword:""}))},searchKeyword:o,placeholder:a("generation:lora.list.search-placeholder")})}export{To as $,Bo as L,Ao as a,_o as b,Do as c,Fo as d};
//# sourceMappingURL=LoraParams-ByTwqYlb.js.map
