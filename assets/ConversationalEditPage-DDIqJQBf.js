import{j as e}from"./vendor-motion-Bl2lDopP.js";import{r as d,R as Be,s as A}from"./vendor-apollo-B9XqHIAo.js";import{c as xe,d as We,u as $e,a as Ae}from"./vendor-react-router-Bm0RsDwP.js";import{n as ge,B as Ve,A as Ke,C as Oe,S as Ze,Q as Ge,R as qe,$ as fe,K as Ye,e as Qe,L as Je}from"./vendor-react-aria-BW9JtD2p.js";import{b1 as Q,aQ as je,ag as J,kE as S,kF as T,fk as C,kG as Xe,aD as X,kH as be,U as v,gU as es,T as b,p as y,bk as ke,dP as ss,kI as q,k4 as ye,m as P,kJ as M,gV as we,kK as ee,t as W,aV as ve,kL as E,gS as L,kM as Ne,gT as Ie,aj as V,kN as ts,fW as as,fG as oe,cm as ns,kO as ls,kP as is,kQ as se,kR as rs,a as Ce,kS as Y,b0 as te,b8 as F,b9 as B,gW as os,bq as cs,bf as K,kT as ds,dY as O,kU as us,kr as Te,kV as $,kW as ms,kX as ps,kY as hs,kZ as xs,k_ as gs,k$ as fs,l0 as Se,hH as Me,hI as ze,P as U,l1 as js,l2 as bs,aG as ks,fl as ys,aL as Pe,fo as ws,l3 as vs,l4 as ae,l5 as H,l6 as Ns,fj as Is,gu as Cs,gR as Ts,gj as Ss,l7 as Ms,l8 as zs,dB as ce,fu as Ps,eZ as Es,ap as Ee,ha as Ds,l9 as Rs,h4 as Ls,N as Us,Q as _s,aT as Hs,b as Fs,la as Bs,Y as Ws,lb as $s,jz as As,Z as Vs,_ as Ks,$ as Os,a0 as Zs,ee as Gs,lc as qs,ld as Ys,kz as Qs,gw as Js,le as de,L as De,jN as Xs,jd as et,lf as st,lg as tt,lh as at,jJ as nt,li as lt,cS as it}from"./index-JhqgbpkX.js";import{F as rt,g as ot}from"./vendor-lodash-992l3ZN7.js";import{u as D}from"./vendor-i18next-TC5y0B3W.js";import{$ as _,N as I}from"./vendor-firebase-BKQqa5bK.js";import{m as R}from"./proxy-NoNVjFTQ.js";import{u as ct}from"./useCopyToClipboard-BBBtjKLj.js";import{i as dt}from"./outline-download-B1qcKnqG.js";import{i as ut}from"./outline-info-C4eOIxV8.js";import{ab as mt,Q as pt}from"./vendor-mui-DTp04zm4.js";import{C as ht}from"./GenerationModeNavigation-BeGzJJIs.js";import{g as xt}from"./vendor-graphql-DeSYh9DC.js";import"./vendor-amplitude-core-CQMkGYFj.js";import"./vendor-axios-CFwfAwt2.js";import"./vendor-sentry-BZZLy1DV.js";import"./vendor-markdown-1uD3znr6.js";import"./i18n-resources-43uzMSBc.js";import"./vendor-hls-cbDBXQj9.js";import"./vendor-tldraw-CaaMemrL.js";import"./vendor-fabric-Bg02ktlP.js";import"./vendor-radix-ui-DX5JiNHB.js";import"./vendor-photoswipe-UqzIRFho.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"0ec442be81a4ee21bfcf5745e8ef10bc76836958"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new s.Error().stack;a&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[a]="cc9f233a-7047-4561-9d2c-ed78f088d344",s._sentryDebugIdIdentifier="sentry-dbid-cc9f233a-7047-4561-9d2c-ed78f088d344")})()}catch{}(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s._sentryModuleMetadata=s._sentryModuleMetadata||{},s._sentryModuleMetadata[new s.Error().stack]=function(a){for(var t=1;t<arguments.length;t++){var n=arguments[t];if(n!=null)for(var r in n)n.hasOwnProperty(r)&&(a[r]=n[r])}return a}({},s._sentryModuleMetadata[new s.Error().stack],{"_sentryBundlerPluginAppKey:pixai-web-app-key":!0})}catch{}})();const Z=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M14 16.94v-4H5.08l-.03-2.01H14V6.94l5 5Z"})}),G=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M12 10a2 2 0 0 0-2 2a2 2 0 0 0 2 2c1.11 0 2-.89 2-2a2 2 0 0 0-2-2Z"})}),gt=()=>{const{data:s}=Q(),[a]=je({key:"debug::chat-editing-model",defaultValue:"default"}),t=J();return d.useMemo(()=>t.beingAdmin&&a!=="default"?a:s?.chatEditing?.modelId,[t.beingAdmin,a,s?.chatEditing?.modelId])},Re=({submit:s,children:a,isReroll:t=!1,...n})=>{const[r]=S(),[l]=T(),c=d.useMemo(()=>r.isBusy||l.history.some(m=>m.status===C.running||m.status===C.waiting),[r.isBusy,l.history]),i=d.useMemo(()=>t?!1:c,[c,t]),p=d.useMemo(()=>t?c:r.isDisabled,[c,t,r.isDisabled]),u=d.useCallback(async()=>{const m=await Xe({});if(!X(m.data.me)){be("chat-editing");return}s()},[s]);return e.jsx(v,{busy:i,disabled:p,onPress:u,...n,children:a})},ne=({parameters:s,freeEvent:a,SubmitButton:t})=>{const{data:n,isValidating:r}=es(s??{});return e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs(t,{variant:"filled",color:"theme",size:"large",busyLabel:e.jsx("span",{className:"pr-2",children:e.jsx(b,{i18nKey:"generation:submit.generating.label"})}),className:y("w-full transition font-semibold",r&&"opacity-80"),labelClassName:"w-full flex items-center justify-center gap-2",children:[e.jsx("span",{children:e.jsx(b,{i18nKey:a?"generation:submit.free-generation.label":"generation:submit.lets-go.label"})}),e.jsx(ke,{iconClassName:"!size-3",children:e.jsx("span",{className:"flex items-center gap-1",children:e.jsx(ss,{value:n.actualPrice,originalValue:n.originalPrice,loading:r,className:"!text-inherit font-normal",iconClassName:"hidden",valueClassName:"text-xs"})})}),e.jsx("span",{className:"hidden mlg:flex dark:bg-neutral-700/50 bg-neutral-200/50 shadow-md items-center px-1 rounded-md text-white text-xs",children:q()?"⌘+⏎":"Ctrl+⏎"})]})})},Le=d.forwardRef((s,a)=>{const{prompts:t,taskInputParameters:n,beforeSubmit:r,afterSubmit:l,isReroll:c,...i}=s,[p,u]=T(),[,m]=S(),o=d.useCallback(async()=>{const h=t.trim();if(!h)return;const g=await ye();try{if(!n)return;const x=n.chat.mediaId,j=p.history.findIndex(z=>z.outputImageId===x);P("chat_editing_generate",{history:j,type:"chat"}),c&&P("chat_editing_another_try_click",{type:"chat"});const k=rt(n);k.chat.prompts=h,m(z=>{z.isBusy=!0}),u(z=>{z.history.push({id:g,prompt:h,status:C.waiting,referenceImageId:k.chat.mediaId,type:M.Chat})}),r?.();const w=(await we({parameters:k})).data?.createGenerationTask;if(w==null)throw new Error("Task creation failed");const N=ee(w);if(N===void 0)throw new Error("Unexpected task type in History");u(z=>{const re=z.history.findIndex(Fe=>Fe.id===g);re!==-1?z.history[re]=N:z.history.push(N)}),m(z=>{z.selectedItemId=N.id}),l?.()}catch(x){W.error(x.message)}finally{m(x=>{x.isBusy=!1,x.isDisabled=!1}),u(x=>{const j=x.history.findIndex(k=>k.id===g);j!==-1&&x.history.splice(j,1)})}},[l,r,c,t,m,u,n,p.history]);return d.useImperativeHandle(a,()=>({submit:o})),e.jsx(Re,{submit:o,isReroll:c,...i})}),ft=d.forwardRef((s,a)=>{const[t]=T(),[n]=S(),r=gt(),l=d.useMemo(()=>{if(!r)return null;const c=t.history.find(p=>p.id===n.selectedItemId);if(!c)return null;const i=c.outputImageId;return i?{modelId:r,chat:{prompts:"",mediaId:i,modelId:r,workspaceId:t.workspace.id}}:null},[r,t.history,t.workspace,n.selectedItemId]);return e.jsx(ne,{parameters:l,SubmitButton:c=>e.jsx(Le,{ref:a,taskInputParameters:l,...s,...c})})}),jt=({className:s,style:a})=>{const{t}=D(["generation"]),[n,r]=d.useState(""),l=d.useRef(null),c=d.useRef(null),[i]=S(),p=ve("mlg","up");d.useEffect(()=>{i.selectedItemId&&l.current&&p&&l.current.focus()},[i.selectedItemId,p]);const{data:u}=Q(),m=d.useMemo(()=>u?.chatEditing?.promptLimit??500,[u]),o=h=>{(h.key==="Enter"&&h.metaKey&&q()||h.key==="Enter"&&h.ctrlKey&&!q())&&(h.preventDefault(),c.current?.submit())};return e.jsxs("div",{className:s,style:a,children:[e.jsx(kt,{className:"mb-2 md:mb-3"}),e.jsx(bt,{ref:l,value:n,onChange:h=>r(h.target.value),onKeyDown:o,maxLength:m,placeholder:t("generation:chat-editing.panel.tabs.chat.composer.placeholder"),className:"min-h-10 md:min-h-14 text-xs md:text-sm border border-zinc-300 rounded-lg"}),e.jsx("div",{className:"mt-2 md:mt-3",children:e.jsx(ft,{ref:c,prompts:n,beforeSubmit:()=>r("")})})]})},bt=Be.forwardRef(({value:s,className:a,style:t,...n},r)=>e.jsx("div",{className:y("grid grid-rows-1 grid-cols-1",a),style:t,children:e.jsx(ge,{ref:r,value:s,...n,className:"row-start-1 col-start-1 px-2.5 py-2 bg-transparent resize-none overflow-y-scroll box-border"})})),kt=({className:s,style:a})=>{const[,t]=S(),[,n]=E(),{data:r}=L(),{data:l}=Q(),c=Object.entries(r??{}).map(([o,h])=>({id:o,...h})),i=d.useMemo(()=>{const{quickAccessPlugins:o}=l?.chatEditing??{};if(!o||o.length===0)return;const h=c.filter(g=>o.includes(g.id));if(h.length!==0)return h},[l?.chatEditing,c]),p=d.useCallback(()=>{t(o=>{o.panel="enhance-tools"})},[t]),u=d.useCallback(o=>{n(h=>{h.group="image-enhancement",h.id=o,h.extra=Ne(c.find(g=>g.id===o))}),p()},[p,c,n]),m=d.useCallback(()=>{n(o=>{o.group="upscale",o.id="upscale-with-enhance",o.extra={}}),p()},[p,n]);return e.jsx("div",{className:s,style:a,children:i&&e.jsxs("div",{className:y("flex flex-col gap-1","text-sm text-zinc-500"),children:[e.jsx("p",{className:"text-lg md:text-sm",children:e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.chat.quick-access-plugins.label"})}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsx(v,{variant:"ghost",className:"text-lg py-1 md:py-0 md:text-sm",onPress:m,icon:e.jsx(G,{className:"size-5"}),endIcon:e.jsx(Z,{className:"size-5"}),children:e.jsx("span",{className:"underline",children:e.jsx(b,{i18nKey:"generation:upscale.method.upscale"})})})},"upscale"),i.map(o=>e.jsx("li",{children:e.jsx(v,{variant:"ghost",className:"text-lg py-1 md:py-0 md:text-sm",onPress:()=>u(o.id),icon:e.jsx(G,{className:"size-5"}),endIcon:e.jsx(Z,{className:"size-5"}),children:e.jsx("span",{className:"underline",children:e.jsx(b,{i18nKey:o.label})})})},o.id)),e.jsx("li",{children:e.jsx(v,{variant:"ghost",className:"text-lg py-1 md:py-0 md:text-sm",onPress:p,icon:e.jsx(G,{className:"size-5"}),endIcon:e.jsx(Z,{className:"size-5"}),children:e.jsx("span",{className:"underline",children:e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.chat.quick-access-plugins.more"})})})},"more")]})]})})},yt=s=>e.jsx("svg",{viewBox:"0 0 16 16",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M14.046 3.486a.75.75 0 0 1-.032 1.06l-7.93 7.474a.85.85 0 0 1-1.188-.022l-2.68-2.72a.75.75 0 1 1 1.068-1.053l2.234 2.267l7.468-7.038a.75.75 0 0 1 1.06.032"})}),wt=s=>e.jsx("svg",{viewBox:"0 0 20 20",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M8 2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zM7 4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1zM4 6a2 2 0 0 1 1-1.732V14.5A2.5 2.5 0 0 0 7.5 17h6.232A2 2 0 0 1 12 18H7.5A3.5 3.5 0 0 1 4 14.5z"})}),Ue=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",fillRule:"evenodd",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M16.496 2.998a4 4 0 0 1 3.936 3.285l.909 5a4 4 0 0 1-3.936 4.715H15v2.5c0 1.933-1.626 3.124-3.155 3.419c-.964.185-1.729-.442-2.024-1.131l-2.48-5.788H6a3 3 0 0 1-3-3v-6a3 3 0 0 1 3-3h10.496Zm0 2H9v8.59a1 1 0 0 0 .08.394l2.545 5.936c.877-.224 1.375-.828 1.375-1.42v-2.5a2 2 0 0 1 2-2h2.405a2 2 0 0 0 1.968-2.358l-.909-5a2 2 0 0 0-1.968-1.642ZM7 4.998H6a1 1 0 0 0-.993.883L5 5.998v6a1 1 0 0 0 .883.993l.117.007h1v-8Z"})]})}),vt=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M17.65 6.35a7.95 7.95 0 0 0-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 0 0 7.21-4.56c.32-.67-.16-1.44-.9-1.44c-.37 0-.72.2-.88.53a5.994 5.994 0 0 1-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0 1 12 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71l-.64.65z"})}),le=({parameters:s,refImageId:a,track:{type:t},isReroll:n=!1,...r})=>{const{mutate:l}=Ie(),[c,i]=S(),[p,u]=T(),m=d.useCallback(async()=>{const o=await ye(),h=c.selectedItemId;let g=null;try{if(!a)return;const x=p.history.findIndex(k=>k.referenceImageId===a);if(P("chat_editing_generate",{history:x,type:t}),n&&P("chat_editing_another_try_click",{type:t}),u(k=>{k.history.push({id:o,prompt:"",status:C.waiting,referenceImageId:a,type:M.Enhance})}),i(k=>{k.isBusy=!0,k.selectedItemId=o}),g=(await we({parameters:s})).data??null,!g||!g.createGenerationTask)throw new Error("Task creation failed")}catch(x){i(j=>{j.isBusy=!1,j.selectedItemId=h}),u(j=>{const k=j.history.findIndex(f=>f.id===o);k!==-1&&j.history.splice(k,1)}),W.error(x.message),console.error("Error create task:",x);return}try{l();const x=g.createGenerationTask;await V.linkTaskToWorkspace({workspaceId:p.workspace.id,taskId:x.id});const j=ee(x);if(j===void 0)throw new Error("Unexpected task type in History");u(k=>{const f=k.history.findIndex(w=>w.id===o);f!==-1?k.history[f]=j:k.history.push(j)}),i(k=>{k.selectedItemId=x.id})}catch(x){W.error(x.message),console.error("Error linking task to workspace:",x)}finally{i(x=>{x.isBusy=!1})}},[n,l,s,a,i,u,t,c.selectedItemId,p.history,p.workspace]);return e.jsx(Re,{submit:m,isReroll:n,...r})},Nt=({task:s,dimmed:a=!1})=>e.jsx(It,{task:s,variant:"ghost",size:"small",busyLabel:e.jsx(b,{i18nKey:"generation:chat-editing.panel.history.reroll.busy-label"}),icon:e.jsx(R.div,{initial:!1,children:e.jsx(vt,{className:y("size-5 text-neutral-500",a&&"opacity-40")})}),className:y("px-1 py-0.5 text-sm transition-all duration-200 ease-in-out","focus:outline-none focus:ring-0","text-neutral-600",a&&"opacity-40"),children:e.jsx(b,{i18nKey:"generation:chat-editing.panel.history.reroll.label"})}),It=({task:s,...a})=>s.rawTask?.parameters?e.jsx(e.Fragment,{children:_(s.type).with(M.StartPoint,()=>null).with(M.Chat,()=>e.jsx(Le,{...a,taskInputParameters:s.rawTask.parameters,prompts:s.prompt,isReroll:!0})).with(M.Enhance,()=>e.jsx(Ct,{task:s,...a})).with(M.Upscale,()=>null).exhaustive()}):null,Ct=({task:s,...a})=>{const t=d.useMemo(()=>{const n=s.rawTask?.parameters?.workflowName;if(!n)return"unknown-workflow";const r=n.split(":");return r.length>1?r[0]:n},[s.rawTask?.parameters?.workflowName]);return e.jsx(le,{...a,parameters:s.rawTask.parameters,refImageId:s.referenceImageId,track:{type:`enhance-${t}`},isReroll:!0})},Tt=({className:s,style:a})=>{const[t]=T(),[n,r]=S(),[l,c]=d.useState(0),i=d.useRef(null);d.useEffect(()=>{i.current&&t.history.length!==l&&(c(t.history.length),i.current.scrollTo({top:i.current.scrollHeight,behavior:"smooth"}))},[l,t.history]);const p=o=>{const h=o.status===C.cancelled||o.status===C.failed||o.status===C.completed&&o.outputImageId===void 0;r(g=>{g.selectedItemId=o.id,g.isDisabled=h})},u=d.useMemo(()=>{const o=t.history.find(h=>h.id===n.selectedItemId);return o?ts(o,t.history):[]},[n.selectedItemId,t.history]),m=d.useMemo(()=>{const o=u[u.length-1],h=t.history.findIndex(x=>x.id===o);return h===-1?[]:h===history.length-1?[]:t.history.slice(h+1).map(x=>x.id)},[u,t.history]);return e.jsx("div",{ref:i,className:s,style:a,children:e.jsx("ul",{children:t.history.map((o,h)=>e.jsx(St,{number:h,history:o,onSelected:p,onChain:u.includes(o.id),hideTaskChainLine:m.includes(o.id)},o.id))})})},St=({number:s,history:a,onChain:t,hideTaskChainLine:n,onSelected:r})=>{const[l]=S(),c=a.status===C.completed,i=l.selectedItemId===a.id,p=d.useCallback(()=>{P("workspace_image_click"),r(a)},[r,a]);return e.jsxs("li",{className:"relative bg-purple-50 dark:bg-zinc-900",children:[!n&&e.jsx(R.div,{initial:{opacity:0,scaleY:0},animate:{opacity:1,scaleY:1,transition:{ease:"easeOut",duration:.1,delay:.2}},className:"absolute left-4 top-0 bottom-0 w-1 bg-purple-400 dark:bg-zinc-600 z-0",style:{transformOrigin:"top"}}),e.jsxs(R.div,{initial:{translateY:16,opacity:0},animate:{translateY:0,translateX:t?0:32,opacity:1,transition:{ease:"easeOut",duration:.2}},className:y("p-2 md:p-3 space-y-1 relative z-10","border-zinc-200 dark:border-zinc-700 border","flex flex-row gap-1",c&&"cursor-pointer",i?"bg-purple-200 dark:bg-black":"bg-white dark:bg-zinc-800"),onClick:p,children:[e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[e.jsxs("div",{className:"flex mb-1 items-start",children:[e.jsx("span",{className:y("text-zinc-500 text-xs md:text-base flex-shrink-0 w-8 md:w-10 flex items-center",!t&&"opacity-40"),children:s===0?e.jsx(as,{className:"inline size-4 md:size-5"}):`#${s}`}),e.jsx("span",{className:"flex-1 ml-1",children:e.jsx(Pt,{task:a,dimmed:!t})})]}),e.jsx("p",{className:y("flex-1 text-xs md:text-sm break-words line-clamp-3 md:line-clamp-none",!t&&"opacity-40"),children:e.jsx(zt,{task:a})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Nt,{task:a,dimmed:!t}),a.prompt.length>0&&e.jsx(Et,{text:a.prompt,dimmed:!t})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"",children:e.jsx(Dt,{history:a,dimmed:!t})}),e.jsx("span",{className:"size-12 md:size-14 items-center",children:e.jsx(Mt,{history:a,dimmed:!t})})]})]})]})},Mt=({history:s,dimmed:a})=>e.jsx(e.Fragment,{children:_(s.status).with(C.waiting,()=>e.jsx("div",{className:y("size-full grid place-content-center text-zinc-400 border border-zinc-400 border-dashed rounded-md",a&&"opacity-40"),children:e.jsx(oe,{className:"size-4 md:size-5 animate-spin"})})).with(C.running,()=>e.jsx("div",{className:y("size-full grid place-content-center text-zinc-400 border border-zinc-400 border-dashed rounded-md",a&&"opacity-40"),children:e.jsx(oe,{className:"size-4 md:size-5 animate-spin"})})).with(C.completed,()=>e.jsx(ns,{mediaId:s.outputImageId,thumbnail:!0,className:y("size-full object-center object-cover rounded-md",a&&"opacity-40")})).with(C.failed,()=>e.jsx("div",{className:y("size-full grid place-content-center text-zinc-400 border border-zinc-400 border-dashed rounded-md",a&&"opacity-40"),children:e.jsx(ls,{className:"size-5 md:size-6"})})).with(C.cancelled,()=>e.jsx("div",{className:y("size-full grid place-content-center text-zinc-400 border border-zinc-400 border-dashed rounded-md",a&&"opacity-40"),children:e.jsx(Ue,{className:"size-4 md:size-5"})})).exhaustive()}),zt=({task:s})=>{const{data:a}=L(),t=Object.entries(a??{}).map(([r,l])=>({id:r,...l})),{t:n}=D(["generation"]);if(s.type===M.Chat)return e.jsx(e.Fragment,{children:s.prompt});if(s.type===M.Enhance){const r=s.rawTask?.parameters?.inputs,l=s.rawTask?.parameters?.workflowName??"";if(!l)return null;const c=t.find(i=>l.startsWith(i.workflowName));if(!c)return null;if(c.id==="face-detailer"||c.id==="sketch-coloring"){const i=r?.prompt;return i?e.jsx(e.Fragment,{children:i}):null}if(c.id==="emotion"){const i=r?.prompt;if(!i)return null;const u=(c?.args?.prompt?.options??[]).find(m=>m.value===i);return u?e.jsx(b,{i18nKey:u.label}):null}}if(s.type===M.Upscale){const r=s.rawTask?.parameters?.enlarge||s.rawTask?.parameters?.upscale,l=s.rawTask?.parameters?.strength,c=s.rawTask?.parameters?.samplingSteps;if(r)return e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[n("generation:chat-editing.panel.tabs.preset.upscale-params.ratio"),": ×",r]}),l&&e.jsxs("p",{children:[n("generation:chat-editing.panel.tabs.preset.upscale-params.strength"),": ",l]}),c&&e.jsxs("p",{children:[n("generation:chat-editing.panel.tabs.preset.upscale-params.steps"),": ",c]})]})}return null},Pt=({task:s,dimmed:a=!1})=>{const{t}=D(["generation"]),{data:n}=L(),r=Object.entries(n??{}).map(([c,i])=>({id:c,...i})),l=d.useMemo(()=>{if(s.type===M.Enhance){const c=is(s.rawTask?.parameters,r);return c?`generation:enhance-image.parameters.plugin.${c.id}.label`:void 0}return s.type===M.Upscale?`generation:upscale.method.${s.rawTask?.parameters?.enlarge?"enlarge":"upscale"}`:`generation:chat-editing.edit-type.${s.type}`},[r,s]);return l?e.jsx("span",{className:y("text-zinc-500 text-xs md:text-base",a&&"opacity-40"),children:t(l)}):null},Et=({text:s,dimmed:a=!1})=>{const[,t]=ct(),[n,r]=d.useState(!1),l=se(async i=>t(i),async i=>rs(i)),c=d.useCallback(()=>{P("chat_editing_copy_prompt_click"),l(s),r(!0),setTimeout(()=>{r(!1)},900)},[l,s]);return e.jsx(v,{variant:"ghost",size:"small",icon:e.jsx(R.div,{initial:!1,animate:{scale:n?[1,1.2,1]:[1]},transition:{duration:.3},children:n?e.jsx(yt,{className:y("size-5 text-green-500",a&&"opacity-40")}):e.jsx(wt,{className:y("size-5 text-neutral-500",a&&"opacity-40")})}),className:y("py-0.5 px-1 text-sm transition-all duration-200 ease-in-out","focus:outline-none focus:ring-0",n?"text-green-600":"text-neutral-600",a&&"opacity-40"),onPress:c,children:e.jsx(R.div,{initial:!1,animate:{opacity:[1],y:n?[0,-2,0]:[0]},transition:{duration:.3},children:e.jsx(b,{i18nKey:n?"action:copied":"generation:chat-editing.panel.history.copy-prompt.label"})})})},Dt=({history:s,dimmed:a})=>{const t=s.status===C.failed;return s.creditCost?e.jsx(ke,{value:t?0:s.creditCost,originalValue:t?s.creditCost:void 0,className:y("text-xs ml-auto",a?"opacity-40":""),iconClassName:"size-[1em]"}):null},Rt=()=>{const{data:s}=L(),{data:a}=Ie(),[t]=S(),[n]=T(),[r]=E(),{data:l}=Ce(),c=X(l),i=d.useMemo(()=>n.history.find(h=>h.id===t.selectedItemId),[t.selectedItemId,n.history]),p=d.useMemo(()=>s&&r.id?s[r.id]:Object.values(s??{})[0],[s,r.id]),u=d.useMemo(()=>({workflowName:Lt(p),inputs:{image:{type:"media",media_id:i?.outputImageId},...r.extra},model:"pixai-panelplugin"}),[p,i,r.extra]),m=Ut({events:a,plugin:s?.handfix,isMember:c}),o=m!=null&&m.countRemains>0;return e.jsx("div",{className:"mt-2 md:mt-3",children:e.jsx(ne,{parameters:u,freeEvent:o,SubmitButton:h=>e.jsx(le,{parameters:u,refImageId:i?.outputImageId,track:{type:`enhance-${p.workflowName}`},...h})})})},Lt=s=>{if(s)return[s.workflowName,s.workflowVersion].join(":")},Ut=s=>{const{plugin:a,events:t,isMember:n}=s;if(!t)return null;const l=(a?t.filter(c=>c.workflows?.includes(a.workflowName)):[])[0];return l&&l.userType==="member"&&n?l:null},_t="1861558740588989558",Ht=()=>{const[s]=S(),[a]=T(),[t]=E(),n=d.useMemo(()=>a.history.find(l=>l.id===s.selectedItemId),[s.selectedItemId,a.history]),r=d.useMemo(()=>{let l={};switch(t.id){case"enlarge":{const c=t.extra?.enlargeRatio,i=t.extra?.enlargeModel??Y.enlargeModel;l={enlarge:c,enlargeModel:i};break}case"upscale-with-enhance":{const c=t.extra?.upscaleRatio,i=t.extra?.strength,p=t.extra?.samplingSteps??Y.samplingSteps;l={upscale:c,strength:i,samplingSteps:p};break}}return{...l,mediaId:n?.outputImageId,modelId:_t,prompts:n?.rawTask?.parameters.prompts,width:n?.rawTask?.media?.width,height:n?.rawTask?.media?.height,priority:1e3}},[n?.outputImageId,n?.rawTask,t.extra,t.id]);return e.jsx("div",{className:"mt-2 md:mt-3",children:e.jsx(ne,{parameters:r,SubmitButton:l=>e.jsx(le,{parameters:r,refImageId:n?.outputImageId,track:{type:"upscale"},...l})})})},Ft=()=>{const[s]=E();return _(s.group).with("image-enhancement",()=>e.jsx(Rt,{})).with("upscale",()=>e.jsx(Ht,{})).exhaustive()},ue={Text:"text",Radios:"radios"},Bt=s=>{const{data:a}=L(),t=s.pluginName?a?.[s.pluginName]:void 0,n=Object.entries(t?.args??{}).map(([c,i])=>({name:c,...i})),[r,l]=E();return e.jsx("div",{className:"py-4 px-2",children:n.map(c=>_(c).with({hidden:!0},()=>null).with({type:I.optional(ue.Text),value:I.optional(I.string),placeholder:I.optional(I.string)},i=>e.jsxs(Ve,{value:r.extra?.[i.name],onChange:p=>l(u=>{u.extra??={},u.extra[i.name]=p}),className:"flex flex-col",children:[e.jsx(Ke,{className:"mb-2",children:e.jsx("span",{className:"block -my-1",children:e.jsx(b,{i18nKey:i.label,defaults:i.label||i.name})})}),e.jsx(ge,{placeholder:i.placeholder,className:"h-14 min-h-8 px-2.5 py-1.5 bg-transparent rounded-md ring-1 ring-inset ring-black/15 dark:ring-white/15 focus:outline outline-2 -outline-offset-1 outline-black/80 dark:outline-white/80 resize-y"})]},i.name)).with({type:ue.Radios,membershipDialogTitle:I.optional(I.string),membershipDialogContent:I.optional(I.string),options:I.intersection({length:I.number.gt(0)},I.array({value:I.string,label:I.optional(I.string),image:I.optional(I.string),membership:I.optional(I.boolean)}))},i=>e.jsx(Wt,{...i})).otherwise(()=>null))})},Wt=s=>{const[a,t]=d.useState(!1),[n,r]=E(),[l,c]=d.useState(n.extra?.[s.name]),i=d.useMemo(()=>s.options.find(o=>o.value===l),[s.options,l]),{beingMember:p}=J(),u=d.useCallback(()=>{t(!1)},[]),m=d.useCallback(()=>{r(o=>{o.extra??={},o.extra[s.name]=l}),t(!1)},[s.name,l,r]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(b,{i18nKey:s.label,defaults:s.label||s.name}),e.jsx(v,{variant:"outlined",size:"xl",className:"flex-1",onPress:()=>t(!0),children:e.jsxs("div",{className:"flex flex-row items-center justify-between m-4",children:[e.jsx("img",{src:s.options.find(o=>o.value===l)?.image,alt:"",className:"rounded-md w-1/3"}),e.jsxs("span",{className:"flex justify-center items-center gap-2 flex-1 ml-4",children:[e.jsx(b,{i18nKey:i?.label,defaults:i?.label||i?.value}),e.jsx("span",{"aria-hidden":"true",children:"▼"})]})]})})]}),e.jsxs(te,{open:a,children:[e.jsx(F,{heading:e.jsx(b,{i18nKey:s.label,defaults:s.label||s.name})}),e.jsx(B,{children:e.jsx(Oe,{isRequired:!0,orientation:"horizontal",className:"py-4",value:l,onChange:o=>{if(s.options.find(g=>g.value===o)?.membership&&!p){os({dialogTitle:e.jsx(b,{i18nKey:s.membershipDialogTitle,defaults:s.membershipDialogTitle}),dialogBody:e.jsx(b,{i18nKey:s.membershipDialogContent,defaults:s.membershipDialogContent}),trackingLocation:"emotion-plugin"});return}c(o)},children:e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-3",children:s.options.map(o=>e.jsxs(Ze,{value:o.value,className:"relative flex flex-col items-center gap-1.5 rounded-lg group",children:[e.jsx("img",{src:o.image,alt:o.label,className:y("w-full aspect-square object-cover object-center rounded-md shadow-[0_0_0_1px_theme(colors.zinc.200)]","group-data-[selected]:outline outline-2 outline-offset-2 outline-theme-primary")}),o.membership&&e.jsx(cs,{className:"absolute top-0.5 right-0.5 size-5"}),e.jsx("span",{className:"block px-2 rounded-full group-data-[selected]:text-white group-data-[selected]:bg-theme-primary",children:e.jsx(b,{i18nKey:o.label,defaults:o.label||o.value})})]},o.value))})})}),e.jsxs(K,{className:"sticky bottom-0 bg-white dark:bg-zinc-800 justify-end",children:[e.jsx(v,{onPress:u,variant:"ghost",children:e.jsx(b,{i18nKey:"action:cancel"})}),e.jsx(v,{variant:"filled",onPress:m,disabled:l===void 0,children:e.jsx(b,{i18nKey:"action:confirm"})})]})]})]})},$t=s=>e.jsx("div",{className:"py-4 px-2",children:_(s.pluginName).with("enlarge",()=>e.jsx(At,{})).with("upscale-with-enhance",()=>e.jsx(Vt,{})).otherwise(()=>null)}),me=Y.samplingSteps,pe=.3,At=()=>{const{data:s,isValidating:a}=ds(),[t,n]=E(),r=d.useMemo(()=>t.extra?.enlargeRatio,[t.extra?.enlargeRatio]),l=d.useMemo(()=>t.extra?.enlargeModel,[t.extra?.enlargeModel]),c=f=>{n(w=>{const N=w.extra??{};N.enlargeRatio=f,w.extra=N})},i=f=>{n(w=>{const N=w.extra??{};N.enlargeModel=f,w.extra=N})},[p,u]=S(),[m]=T(),o=d.useMemo(()=>m.history.find(f=>f.id===p.selectedItemId),[p.selectedItemId,m.history]),h=O(o?.outputImageId??A),{width:g,height:x}=h.data??{},j=d.useMemo(()=>{const f=ps({width:g,height:x});if(!(f===void 0||f<1.1))return f},[x,g]),{t:k}=D(["generation"]);return d.useEffect(()=>{if(r===void 0&&j){const f=hs({width:g,height:x});f&&c(f)}if(l===void 0&&s){const f=s.base.enlargeModel;f&&i(f)}},[r,l,j,s]),d.useEffect(()=>(u(f=>{f.isDisabled=j===void 0}),()=>{u(f=>{f.isDisabled=!1})}),[j,u,o]),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(us,{className:"mt-4 w-full",value:l,onChange:i,disabled:a}),e.jsx(Te,{variant:"half-filled",value:r,onChange:c,label:k("generation:upscale.upscale-ratio"),labelProps:{className:"text-base text-primary-light"},minValue:1.1,maxValue:j,step:.1,isDisabled:!j}),e.jsxs("p",{children:[g,"×",x," → ",j?$(g??0,r):"NaN","×",j?$(x??0,r):"NaN"]})]})},Vt=()=>{const[s,a]=E(),t=d.useMemo(()=>s.extra?.upscaleRatio,[s.extra?.upscaleRatio]),n=d.useMemo(()=>s.extra?.samplingSteps,[s.extra?.samplingSteps]),r=d.useMemo(()=>s.extra?.strength,[s.extra?.strength]),l=f=>{a(w=>{const N=w.extra??{};N.upscaleRatio=f,w.extra=N})},c=f=>{a(w=>{const N=w.extra??{};N.samplingSteps=f,w.extra=N})},i=f=>{a(w=>{const N=w.extra??{};N.strength=f,w.extra=N})},[p,u]=S(),[m]=T(),o=d.useMemo(()=>m.history.find(f=>f.id===p.selectedItemId),[p.selectedItemId,m.history]),h=O(o?.outputImageId??A),{width:g,height:x}=h.data??{},j=d.useMemo(()=>{const f=xs({width:g,height:x});if(!(f===void 0||f<1.1))return f},[x,g]),{t:k}=D(["generation"]);return d.useEffect(()=>{if(t===void 0&&j){const f=gs({width:g,height:x});f&&l(f)}n===void 0&&c(me),r===void 0&&i(pe)},[t,j,n,r]),d.useEffect(()=>(u(f=>{f.isDisabled=j===void 0}),()=>{u(f=>{f.isDisabled=!1})}),[j,u,o]),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(Te,{variant:"half-filled",value:t,onChange:l,label:k("generation:upscale.upscale-ratio"),labelProps:{className:"text-base text-primary-light"},minValue:1.1,maxValue:j,step:.1,isDisabled:!j}),e.jsxs("p",{children:[g,"×",x," → ",j?$(g??0,t):"NaN","×",j?$(x??0,t):"NaN"]}),e.jsx(ms,{steps:n??me,strength:r??pe,strengthSafeRange:{min:.2,max:.6},handleChange:{steps:c,strength:i}})]})},Kt=()=>{const[s]=E();return _(s.group).with("image-enhancement",()=>e.jsx(Bt,{pluginName:s.id})).with("upscale",()=>e.jsx($t,{pluginName:s.id})).exhaustive()},Ot=[{key:"upscale-with-enhance",name:"generation:upscale.method.upscale",icon:"https://images-ng.pixai.art/images/thumb/488c1009-2f00-4972-b2ae-adce5a5a12ff"}],Zt=()=>{const s=fs(),a=ve("mlg"),[t,n]=E(),{data:r}=L(),l=Object.entries(r??{}).map(([u,m])=>({id:u,...m})),c=d.useCallback((u,m)=>{switch(u){case"image-enhancement":n(o=>{o.group=u,o.id=m,o.extra=Ne(l.find(h=>h.id===m))});break;case"upscale":n(o=>{o.group=u,o.id=m,o.extra={}});break;default:console.warn(`Unknown type: ${u}`)}},[l,n]),i=l.map(u=>({key:u.id,name:u.label,icon:u.image})),p=d.useMemo(()=>{const u=[];return u.push(...Ot.map(m=>({group:"upscale",key:m.key,name:m.name,icon:m.icon}))),u.push(...i.map(m=>({group:"image-enhancement",key:m.key,name:m.name,icon:m.icon}))),u},[i]);return s||a?e.jsx(qt,{onSelect:c,items:p,selected:{group:t.group,key:t.id}}):e.jsx(Gt,{onSelect:c,items:p,selected:{group:t.group,key:t.id}})},Gt=({onSelect:s,items:a,selected:t})=>{const n=d.useCallback(l=>{Se(l!=null);const c=l.split("@");if(c.length!==2)return;const i=c[0],p=c[1];s(i,p)},[s]),r=d.useMemo(()=>a.map(l=>({...l,key:`${l.group}@${l.key}`})),[a]);return e.jsx(Me,{className:"flex flex-col gap-2",onSelectionChange:n,items:r,selectedKey:t?`${t.group}@${t.key}`:void 0,labelSlot:e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.preset.plugin-list-label"}),buttonClassName:"w-full h-16",children:l=>e.jsx(ze,{children:e.jsx(_e,{it:l})},l.key)})},qt=({onSelect:s,items:a,selected:t})=>{const[n,r]=d.useState(!1),l=d.useMemo(()=>{if(!t)return;const i=a.find(p=>p.key===t.key&&p.group===t.group);if(i)return i},[a,t]),c=d.useCallback((i,p)=>{r(!1),s(i,p)},[s]);return e.jsxs(e.Fragment,{children:[e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.preset.plugin-list-label"}),e.jsx(v,{variant:"outlined",className:"w-full h-16 text-xs rounded-md border items-center",size:"small",endIcon:e.jsx("span",{"aria-hidden":"true",children:"▼"}),onPress:()=>r(!0),children:e.jsx("div",{className:"flex [&>span]:flex-none",children:e.jsx(_e,{it:l})})}),e.jsxs(te,{open:n,children:[e.jsx(F,{heading:e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.preset.plugin-list-label"})}),e.jsx(B,{children:e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-3 py-4",children:a.map(i=>e.jsxs(v,{variant:i.icon?"ghost":"outlined",className:y("relative flex flex-col items-center gap-1.5 rounded-lg group h-full",i.icon?"justify-normal":"justify-center"),onPress:()=>c(i.group,i.key),children:[i.icon&&e.jsx("img",{src:i.icon,alt:"",className:y("w-full aspect-square object-cover object-center rounded-md shadow-[0_0_0_1px_theme(colors.zinc.200)]","group-data-[selected]:outline outline-2 outline-offset-2 outline-theme-primary")}),e.jsx("span",{className:"block px-2 rounded-full group-data-[selected]:text-white group-data-[selected]:bg-theme-primary",children:e.jsx(b,{i18nKey:i.name})})]},i.key))})}),e.jsx(K,{className:"sticky bottom-0 bg-white dark:bg-zinc-800 justify-end",children:e.jsx(v,{onPress:()=>r(!1),children:e.jsx(b,{i18nKey:"action:cancel"})})})]})]})},_e=({it:s})=>e.jsx("div",{className:"flex gap-2 items-center text-lg",children:s?e.jsxs(e.Fragment,{children:[s.icon&&e.jsx("img",{src:s.icon,alt:"",className:"w-12 h-12 rounded-md"}),e.jsx(b,{i18nKey:s.name})]}):e.jsx(b,{i18nKey:"generation:chat-editing.panel.tabs.preset.plugin-list-placeholder"})}),Yt=({className:s,style:a})=>e.jsxs("div",{className:s,style:a,children:[e.jsx(Zt,{}),e.jsx(Kt,{}),e.jsx(Ft,{})]}),Qt=()=>{const s=[{idx:1,id:"free-edit",label:"generation:chat-editing.panel.tabs.chat.tab-label",component:e.jsx(jt,{className:"p-2 md:p-3 bg-white/80 dark:bg-zinc-800/80 backdrop-blur"})},{idx:2,id:"enhance-tools",label:"generation:chat-editing.panel.tabs.preset.tab-label",component:e.jsx(Yt,{className:"p-2 md:p-3 bg-white/80 dark:bg-zinc-800/80 backdrop-blur"})}],[a,t]=S(),[n]=T();if(!n.workspace||a.isLoading)return e.jsx(U,{});const r=l=>{const c=l.toString();t(i=>{i.panel=c})};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Tt,{className:"flex-1 overflow-y-auto overflow-x-hidden"}),e.jsxs(Ge,{selectedKey:a.panel,onSelectionChange:r,className:y("flex flex-col"),children:[e.jsx("div",{className:y("border border-t border-zinc-200 dark:border-zinc-700"),children:e.jsx(js,{className:"w-full",children:s.map(l=>e.jsx(bs,{id:l.id,variant:"underlined",className:"flex-1 text-center px-4",children:e.jsx(b,{i18nKey:l.label})},l.idx))})}),s.map(l=>e.jsx(qe,{className:"flex-1 overflow-y-auto overflow-x-hidden min-h-0",id:l.id,children:l.component},l.idx))]})]})},Jt=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",fillRule:"evenodd",d:"m7.04 1.361l.139-.057H21.32l.14.057l1.178 1.179l.057.139V16.82l-.057.14l-1.179 1.178l-.139.057H14V18a2 2 0 0 0-.548-1.375h7.673V2.875H7.375v7.282a5.7 5.7 0 0 0-1.571-.164V2.679l.057-.14L7.04 1.362zm9.531 9.452l-2.809 2.8a2 2 0 0 0-.348-.467l-.419-.42l2.236-2.235l-3.606-3.694l.813-.833l4.133 4.133zM9.62 14.82l1.32-1.32L12 14.56l-1.72 1.72l.22.22V18H12v1.45h-1.5v.1a6 6 0 0 1-.41 1.45L12 22.94L10.94 24l-1.65-1.65A4.3 4.3 0 0 1 6 24a4.31 4.31 0 0 1-3.29-1.65L1.06 24L0 22.94L1.91 21a6 6 0 0 1-.41-1.42v-.08H0V18h1.5v-1.5l.22-.22L0 14.56l1.06-1.06l1.32 1.32a3.73 3.73 0 0 1 7.24 0m-2.029-.661A2.25 2.25 0 0 0 3.75 15.75h4.5a2.25 2.25 0 0 0-.659-1.591m.449 7.38A3.33 3.33 0 0 0 9 19.5v-2.25H3v2.25a3.33 3.33 0 0 0 3 3a3.33 3.33 0 0 0 2.04-.96z",clipRule:"evenodd"})}),Xt=d.memo(({mediaId:s,className:a,style:t,preloader:n})=>{const r=O(s??A),l=ks(r?.data),c=d.useRef(null),[i,p]=d.useState(!0),[u,m]=d.useState(!1),o=d.useCallback(()=>{p(!1),m(!0)},[]);return d.useEffect(()=>{if(!l){p(!0);return}m(!1);const h=c.current||new Image;h.complete&&h.naturalHeight!==0?(p(!1),m(!0)):p(!0)},[l]),e.jsxs(e.Fragment,{children:[i&&e.jsx(U,{className:n?.className,style:n?.style}),e.jsx("img",{ref:c,crossOrigin:"anonymous",className:a,style:t,src:l,hidden:!u,onLoad:o})]})}),ea=[{key:"default",name:"default"},{key:"1882220607086526651",name:"(P) Chat v1.0"},{key:"1899586688204210176",name:"(P) Chat v2.0"},{key:"1917311758307382235",name:"(P) Chat v3.0"},{key:"1868782287766745088",name:"(T) Chat v1.0"},{key:"1899586679917666304",name:"(T) Chat v2.0"},{key:"1917310098177986875",name:"(T) Chat v3.0"}],sa=({children:s,...a})=>{const[t]=S(),[n]=T(),[r]=E(),l=d.useCallback(()=>{ys({ui:t,workspace:n,preset:r})},[t,n,r]);return e.jsx(v,{onPress:l,...a,children:s})},ta=({children:s,...a})=>{const[t,n]=d.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(v,{onPress:()=>n(!0),...a,children:s}),e.jsxs(Pe,{open:t,onClose:()=>n(!1),dismissable:!0,className:"w-[500px]",children:[e.jsx(F,{heading:"Chat Editing Debug Panel"}),e.jsx(B,{children:e.jsx(aa,{})})]})]})},aa=()=>{const[s,a]=je({key:"debug::chat-editing-model",defaultValue:"default"}),t=n=>{Se(n!=null),a(n.toString())};return e.jsx(Me,{className:"flex flex-col gap-2",items:ea,onSelectionChange:t,selectedKey:s,labelSlot:"Chat Editing Model override",buttonClassName:"w-full",children:n=>e.jsx(ze,{children:e.jsx("span",{className:"text-base",children:n.name})},n.key)})},ie=({header:s,children:a,actions:t})=>e.jsxs("div",{className:"flex flex-col h-full",children:[s&&e.jsx(na,{children:s}),e.jsx(la,{children:a}),t&&e.jsx(ia,{children:t})]}),na=({children:s})=>e.jsx("div",{className:y("flex-shrink-0 flex flex-row items-center justify-center py-2 px-4","bg-zinc-100/95 dark:bg-zinc-800/95","border-zinc-200 dark:border-zinc-700 border-b border-t"),children:s}),la=({children:s})=>e.jsx("div",{className:"flex-1 p-4 flex overflow-hidden relative flex-col gap-2 min-h-0",children:s}),ia=({children:s})=>e.jsx("div",{className:y("flex-shrink-0 flex items-center justify-center w-full p-4 gap-2 flex-col md:flex-row","bg-zinc-100/95 dark:bg-zinc-800/95","border-zinc-200 dark:border-zinc-700 border-t"),children:s}),ra=s=>e.jsx("svg",{viewBox:"0 0 16 16",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M6.125 6C6.045 6.625 6 7.297 6 8s.044 1.375.125 2h.082a5.51 5.51 0 0 1 3.697-3.765L9.875 6zM5 8c0 .693.04 1.365.117 2H2.34A6 6 0 0 1 2 8c0-.701.12-1.374.341-2h2.776A17 17 0 0 0 5 8m.272 3h-2.47a6.02 6.02 0 0 0 3.421 2.733a6 6 0 0 1-.457-.957A10.5 10.5 0 0 1 5.272 11m4.436-6a9 9 0 0 0-.407-1.417c-.213-.554-.455-.969-.698-1.236S8.156 2 8 2s-.36.08-.603.347s-.485.682-.698 1.236c-.159.414-.297.89-.407 1.417zm1.02 0a10.5 10.5 0 0 0-.494-1.776a6 6 0 0 0-.457-.957A6.02 6.02 0 0 1 13.197 5zM5.272 5h-2.47a6.02 6.02 0 0 1 3.421-2.733c-.17.285-.323.608-.457.957c-.201.522-.368 1.12-.494 1.776M16 11.5a4.5 4.5 0 1 1-9 0a4.5 4.5 0 0 1 9 0m-4.854-2.353l-2 2a.5.5 0 0 0 .708.707L11 10.707V13.5a.5.5 0 0 0 1 0v-2.793l1.146 1.147a.5.5 0 0 0 .708-.708l-2-2A.5.5 0 0 0 11.503 9h-.006a.5.5 0 0 0-.348.144z"})}),oa=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M15 16h2.405a4 4 0 0 0 3.936-4.716l-.91-5A4 4 0 0 0 16.497 3H8v12l1.821 5.788c.296.69 1.06 1.316 2.024 1.131C13.374 21.625 15 20.433 15 18.5V16Zm-9-1a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3v12Z"})]})}),ca=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M15 8h2.405a4 4 0 0 1 3.936 4.716l-.91 5A4 4 0 0 1 16.497 21H8V9l1.821-5.788c.296-.69 1.06-1.316 2.024-1.13C13.374 2.375 15 3.566 15 5.5V8ZM6 9a3 3 0 0 0-3 3v6a3 3 0 0 0 3 3V9Z"})]})}),da=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",fillRule:"evenodd",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M9.821 3.212c.296-.69 1.06-1.316 2.024-1.13c1.474.283 3.039 1.401 3.149 3.214L15 5.5V8h2.405a4 4 0 0 1 3.966 4.522l-.03.194l-.91 5a4 4 0 0 1-3.736 3.28l-.199.004H6a3 3 0 0 1-2.995-2.824L3 18v-6a3 3 0 0 1 2.824-2.995L6 9h1.34l2.481-5.788ZM7 11H6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h1v-8Zm4.625-6.92l-2.544 5.937a1 1 0 0 0-.072.259L9 10.41V19h7.496a2 2 0 0 0 1.933-1.486l.035-.156l.91-5a2 2 0 0 0-1.82-2.353L17.405 10H15a2 2 0 0 1-1.995-1.85L13 8V5.5c0-.553-.434-1.116-1.205-1.37l-.17-.05Z"})]})}),ua=({currentTask:s})=>{const a=d.useMemo(()=>s&&s.id!=="0"&&s.status===C.completed&&s.outputImageId,[s]);return e.jsxs(e.Fragment,{children:[e.jsx(pa,{disabled:!a,taskId:s?.id,mediaId:s?.outputImageId}),e.jsx("hr",{className:"h-full border-0 w-[1px] bg-neutral-300 dark:bg-neutral-600 hidden md:block"}),e.jsx(ma,{disabled:!a,task:s})]})},ma=({disabled:s,task:a})=>e.jsxs("div",{className:"flex flex-row items-center justify-center gap-2",children:[e.jsx(ws,{task:a?.rawTask,disabled:s,variant:"filled",color:"normal",size:"normal",icon:e.jsx(ra,{}),scene:"chat-editing"}),e.jsx(vs,{variant:"outlined",color:"normal"})]}),pa=({disabled:s,taskId:a,mediaId:t})=>{const{workspaceId:n}=xe(),[r,l]=d.useState(!1),[c,i]=d.useState(!1),[p,u]=T(),m=d.useMemo(()=>p.reactions.find(x=>x.taskId===a&&x.mediaId===t)||{taskId:a,mediaId:t,likeOrDislike:void 0},[p.reactions,a,t]);d.useEffect(()=>{l(!1),i(!1)},[a,t]);const o=d.useCallback(async x=>{if(s||!a||!t)return;u(k=>{const f=k.reactions.findIndex(w=>w.taskId===a&&w.mediaId===t);f!==-1?k.reactions[f]={taskId:a,mediaId:t,likeOrDislike:x}:k.reactions.push({taskId:a,mediaId:t,likeOrDislike:x})});const j=await V.updateChatTaskReaction({workspaceId:n,taskId:a,mediaId:t,likeOrDislike:x});(j.updateChatTaskReaction===void 0||j.updateChatTaskReaction.likeOrDislike!==x)&&u(k=>{const f=k.reactions.findIndex(w=>w.taskId===a&&w.mediaId===t);f!==-1&&(k.reactions[f]={taskId:a,mediaId:t,likeOrDislike:j.updateChatTaskReaction.likeOrDislike})})},[s,a,t,u,n]),h=d.useCallback(()=>{P("workspace_image_like_click"),m.likeOrDislike===!0?o(void 0):(o(!0),l(!0)),i(!1)},[m.likeOrDislike,o]),g=d.useCallback(()=>{P("workspace_image_dislike_click"),m.likeOrDislike===!1?o(void 0):(o(!1),i(!0)),l(!1)},[m.likeOrDislike,o]);return e.jsxs("div",{className:"flex flex-row items-center justify-center gap-2",children:[e.jsx("span",{className:"text-md text-neutral-500",children:e.jsx(b,{i18nKey:"generation:chat-editing.stage.action-bar.like-or-dislike.label"})}),e.jsx(v,{disabled:s,onPress:h,variant:"ghost",size:"normal",icon:e.jsx(he,{isChoosen:m.likeOrDislike===!0,type:"up",shouldAnimate:r,className:"size-8 p-1"}),className:"p-1 focus:outline-none focus:ring-0"}),e.jsx(v,{disabled:s,onPress:g,variant:"ghost",size:"normal",icon:e.jsx(he,{isChoosen:m.likeOrDislike===!1,type:"down",shouldAnimate:c,className:"size-8 p-1"}),className:"p-1 focus:outline-none focus:ring-0"})]})},he=({isChoosen:s,type:a,shouldAnimate:t=!1,className:n,style:r})=>{const l=a==="up";return e.jsx(R.div,{initial:{scale:1},animate:{scale:s&&t?[1,1.5,1]:1,rotate:s&&t?[0,l?15:-15,0]:0,y:s&&t?[0,l?-5:5,0]:0},transition:{duration:.4,ease:"easeInOut"},className:n,style:r,children:s?l?e.jsx(ca,{className:"size-full text-purple-600"}):e.jsx(oa,{className:"size-full text-purple-600"}):l?e.jsx(da,{className:"size-full text-neutral-500"}):e.jsx(Ue,{className:"size-full text-neutral-500"})})},ha=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",fillRule:"evenodd",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036c-.01-.003-.019 0-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.016-.018Zm.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M13.896 3.03a2 2 0 0 1 2.701-.117l.127.117l4.243 4.243a2 2 0 0 1 .117 2.7l-.117.128l-10.314 10.314a2 2 0 0 1-1.238.578L9.239 21H4.006a1.01 1.01 0 0 1-1.004-.9l-.006-.11v-5.233a2 2 0 0 1 .467-1.284l.12-.13L13.895 3.03ZM12.17 7.584l-7.174 7.174V19H9.24l7.174-7.174l-4.243-4.243Zm3.14-3.14L13.584 6.17l4.243 4.243l1.726-1.726l-4.243-4.243Z"})]})}),xa=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsxs("g",{fill:"none",children:[e.jsx("path",{d:"M24 0v24H0V0h24ZM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01l-.184-.092Z"}),e.jsx("path",{fill:"currentColor",d:"M20 17.5a1.5 1.5 0 0 1 .144 2.993L20 20.5H4a1.5 1.5 0 0 1-.144-2.993L4 17.5h16Zm0-7a1.5 1.5 0 0 1 0 3H4a1.5 1.5 0 0 1 0-3h16Zm0-7a1.5 1.5 0 0 1 0 3H4a1.5 1.5 0 1 1 0-3h16Z"})]})}),ga=({children:s,...a})=>e.jsx(fa,{className:"max-w-4xl w-full",trigger:t=>e.jsx(v,{onPress:t,...a,children:s})}),fa=({trigger:s,className:a,style:t})=>{const[n,r]=d.useState(!1),l=()=>{P("select_workspace_click"),r(!0)},c=()=>r(!1),[i]=T(),{t:p}=D(["generation"]),u=ae(),m=d.useCallback(h=>{u(H.chatEditingWorkspace(h.id)),r(!1)},[u]),o=d.useCallback(h=>{i.workspace?.id===h&&u(H.chatEditing())},[u,i.workspace?.id]);return e.jsxs(e.Fragment,{children:[s(l),e.jsxs(te,{open:n,className:a,style:t,onClose:c,dismissable:!0,children:[e.jsx(F,{heading:p("generation:chat-editing.workspace.selector.title")}),e.jsx(B,{className:"px-4 py-8 w-full",children:e.jsx(Ns,{pageSize:24,cardProps:{onClicked:m,onWorkspaceDelete:o},renderContainer:({children:h})=>e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:h}),loading:e.jsx("div",{className:"flex justify-center items-center min-w-[600px] min-h-[600px]",children:e.jsx(U,{})})})}),e.jsx(K,{className:"sticky bottom-0 bg-white dark:bg-zinc-800 justify-end",children:e.jsx(v,{onPress:c,children:e.jsx(b,{i18nKey:"action:cancel"})})})]})]})};function ja(s){const[a]=T();let t=s||a.workspace?.title||"",n;return t?t.length>32&&(n=t,t=`${t.slice(0,29)}...`):t="Untitled",[t,n]}const He=({title:s,disableTitleEdit:a})=>{const{t}=D(["generation"]),[n,r]=ja(s),[l,c]=d.useState(!1),i=()=>{a||c(!0)},p=()=>{c(!1)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 flex justify-start",children:e.jsx(ga,{variant:"ghost",className:"font-semibold p-2 focus:outline-none gap-1",icon:e.jsx(xa,{}),children:e.jsx("span",{className:"lg:block hidden",children:e.jsx(b,{i18nKey:"generation:chat-editing.stage.header.select-workspace.label"})})})}),e.jsx("div",{className:"flex-1 flex justify-end lg:justify-center",children:e.jsx(mt,{title:r,placement:"bottom",children:e.jsxs("button",{className:"flex items-center gap-1 text-left text-lg font-semibold truncate cursor-pointer",onClick:i,type:"button","aria-label":t("generation:chat-editing.stage.header.update-title.header"),children:[e.jsx("span",{className:"truncate",children:n}),e.jsx(ha,{className:"size-4 opacity-50"})]})})}),e.jsx("div",{className:"flex-1 lg:flex justify-end hidden"}),e.jsx(ba,{open:l,close:p})]})},ba=({open:s,close:a})=>{const{t}=D(["generation"]),[n,r]=d.useState(""),[l,c]=T(),i=d.useCallback(u=>{r(u.target.value)},[]),p=d.useCallback(async()=>{try{const u=await V.updateChatWorkspace({workspaceId:l.workspace.id,title:n});if(!u.updateChatWorkspace)throw new Error("Failed to update workspace title");c(o=>{o.workspace=u.updateChatWorkspace}),a()}catch(u){W.error(u?.message)}},[a,c,n,l.workspace]);return e.jsxs(Pe,{open:s,children:[e.jsx(F,{heading:t("generation:chat-editing.stage.header.update-title.header")}),e.jsx(B,{className:"flex flex-col gap-4",children:e.jsx(pt,{label:t("generation:chat-editing.workspace.creator.form.workspace-title.label"),placeholder:t("generation:chat-editing.workspace.creator.form.workspace-title.placeholder"),value:n,onChange:i})}),e.jsxs(K,{className:"sticky bottom-0 bg-white dark:bg-zinc-800 justify-end",children:[e.jsx(v,{onPress:a,children:e.jsx(b,{i18nKey:"action:cancel"})}),e.jsx(v,{variant:"filled",onPress:p,disabled:!n,children:e.jsx(b,{i18nKey:"action:confirm"})})]})]})},ka=()=>{const[s]=T(),[a]=S(),t=d.useMemo(()=>s.history.find(n=>n.id==a.selectedItemId),[a.selectedItemId,s.history]);return e.jsxs(ie,{header:e.jsx(He,{}),actions:e.jsx(ua,{currentTask:t}),children:[e.jsx("div",{className:"flex items-center justify-center w-full flex-1 min-h-0",children:e.jsx(ya,{task:t})}),e.jsx("div",{className:y("flex items-center justify-center","md:absolute md:bottom-4 md:right-4"),children:e.jsx(va,{className:y("flex gap-2 flex-row md:flex-col","w-fit md:py-4 px-1"),task:t})})]})},ya=({task:s})=>{if(!s)return e.jsx(e.Fragment,{});if(s.outputImageId)return e.jsx(Xt,{mediaId:s.outputImageId,className:"max-w-full max-h-full object-contain rounded-lg"});const a=()=>{if(s.status===C.failed||s.status===C.cancelled){const t=s.rawTask?.outputs?.finish_reason??"other",n=s.rawTask?.outputs.failure_reason??"",r=`generation:chat-editing.stage.finish-reason.${t.toLowerCase()}`,l=`generation:chat-editing.stage.failure-reason.${n.toLowerCase()}`;return e.jsxs("div",{className:"gap-2 flex flex-col items-center justify-center text-wrap",children:[e.jsx("p",{children:e.jsx(b,{i18nKey:[r,""]})}),e.jsx("p",{children:e.jsx(b,{i18nKey:[l,""]})})]})}};return e.jsx(Is,{id:s.id,status:s.status,className:"rounded-lg object-contain aspect-[9/14] min-h-[22rem]",children:a()})},wa=({trigger:s,placement:a})=>{const{t}=D(["generation"]);return e.jsx(Es,{TooltipProps:{delay:100,placement:a},trigger:s,children:e.jsx("div",{className:"p-4 max-w-sm",children:e.jsx(Ee,{as:"article",className:y("prose prose-sm md:prose-normal prose-neutral dark:prose-invert mx-auto","text-black dark:text-white"),children:t("generation:chat-editing.stage.notice.content")})})})},va=({task:s,className:a,style:t})=>{const[n,r]=T(),[,l]=S(),c=se(async({url:h,filename:g})=>await Ls(h,g),async({url:h,filename:g})=>Rs({url:h,fileName:g})),i=d.useCallback(async()=>{if(s?.outputImageId){const h=Cs(s.outputImageId);if(!h)return;P("workspace_image_download_click");const g=Ts({task:s.rawTask}),x=Ss({task:s.rawTask}),j=`${g}.${x}`;await c({url:h,filename:j})}},[c,s]),p=async()=>{if(!s)return;P("workspace_image_delete_confirm_click"),l(g=>{if(g.selectedItemId===s.id){const x=n.history.findLast(j=>j.id!==s.id);g.selectedItemId=x?.id??"0"}}),r(g=>{const x=g.history.findIndex(j=>j.id===s.id);x!==-1&&g.history.splice(x,1)}),Math.random()<.25&&await Ds()},u=ae(),m=()=>{u(H.chatEditing())},o=J();return e.jsx(e.Fragment,{children:e.jsxs("span",{className:y(a,"rounded-full","bg-zinc-100 dark:bg-zinc-700","border border-zinc-300 dark:border-zinc-800"),style:t,children:[o.beingAdmin&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{className:"p-2 rounded-full",variant:"ghost",children:e.jsx(Jt,{className:"size-6 text-orange-400"})}),e.jsx(sa,{className:"p-2 rounded-full",variant:"ghost",children:e.jsx(Ms,{className:"size-6 text-orange-400"})})]}),s?.outputImageId?e.jsx(v,{className:"p-2 rounded-full",variant:"ghost",onPress:i,children:e.jsx(dt,{className:"size-6"})}):null,s?.type===M.StartPoint&&n.workspace?.id?e.jsx(zs,{source:"delete-start-point",workspaceId:n.workspace.id,onSuccess:m,trigger:h=>e.jsx(v,{className:"p-2 rounded-full",variant:"ghost",onPress:h,children:e.jsx(ce,{className:"size-6"})})}):s?.rawTask&&e.jsx(Ps,{className:"p-2 rounded-full",variant:"ghost",task:s.rawTask,onSuccess:p,children:e.jsx(ce,{className:"size-6"})}),e.jsx(wa,{placement:"right",trigger:h=>e.jsx(fe,{onPress:h,className:"p-2 rounded-full",style:t,children:e.jsx(ut,{className:"size-6"})})})]})})},Na=({children:s})=>{const{data:a,loading:t}=Ce();return a?s:t?e.jsx(U,{}):e.jsx(Us,{})},Ia=({mediaId:s,defaultExpandedImageRequirements:a})=>{const{data:t,loading:n}=O(s??A);return e.jsx(Na,{children:e.jsxs("div",{className:"gap-4 flex flex-col items-center",children:[e.jsx(Ca,{}),n?e.jsx(U,{}):e.jsx(Ta,{initMedia:t,defaultExpandedImageRequirements:a})]})})},Ca=()=>{const{t:s}=D(["generation"]);return e.jsx("div",{className:"pt-8 text-2xl flex justify-between items-center",children:e.jsx("div",{className:"prose dark:prose-invert font-black",children:e.jsx("h2",{children:s("generation:chat-editing.workspace.creator.form.heading")})})})},Ta=({initMedia:s,onCreated:a,defaultExpandedImageRequirements:t})=>{const{t:n}=D(["generation"]),r=_s({initialValues:{media:s,title:""}}),l=We(),c=ae(),{data:i,loading:p}=Hs(),u=se(()=>{l("/")},()=>{qs({route:Ys.main("home")})}),m=d.useRef(!1);d.useEffect(()=>{p||(X(i)?m.current=!1:m.current||(be("chat-editing",()=>{u()}),m.current=!0))},[i,p,u]);const[o,h]=Fs(async g=>{if(!g.media||!g.media.id)return;const x=await Bs(g.media.id,g.title);x?(c(H.chatEditingWorkspace(x)),a?.()):console.error("Failed to create chat workspace")},[l]);return e.jsxs(Ws,{className:"flex flex-col md:flex-row gap-8 w-full md:max-w-4xl",form:r,onSubmit:h,children:[e.jsx("div",{className:"flex-1 flex flex-col gap-4 items-center",children:e.jsx($s,{className:"w-full h-auto md:w-full md:h-auto aspect-square",taskPickerShowFileUpload:!1,...r.getInputProps("media")})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4",children:[e.jsxs(Ye,{defaultExpanded:t,children:[e.jsx(Qe,{className:"text-lg",children:e.jsxs(fe,{slot:"trigger",className:"group inline-flex items-center gap-1 outline-none",children:[n("generation:chat-editing.workspace.creator.notice.title"),e.jsx(As,{className:"size-5 transition-transform group-aria-expanded:rotate-90"})]})}),e.jsx(Je,{children:e.jsx(Ee,{className:"prose prose-sm md:prose-normal prose-neutral dark:prose-invert mx-auto",children:n("generation:chat-editing.workspace.creator.notice.content")})})]}),e.jsx("hr",{}),e.jsx(Vs,{input:r.getInputProps("title"),layout:"vertical",children:g=>e.jsxs(e.Fragment,{children:[e.jsx(Ks,{children:n("generation:chat-editing.workspace.creator.form.workspace-title.label")}),e.jsx(Os,{...g,variant:"rounded-normal",placeholder:n("generation:chat-editing.workspace.creator.form.workspace-title.placeholder")}),e.jsx(Zs,{input:g,children:n("generation:chat-editing.workspace.creator.form.workspace-title.helper-text")})]})}),e.jsx(v,{variant:"filled",size:"large",type:"submit",busy:o,disabled:!r.getValues().media,children:e.jsxs("span",{className:"flex flex-row items-center justify-center gap-1",children:[e.jsx(Gs,{}),e.jsx(b,{i18nKey:"generation:chat-editing.workspace.creator.form.action.create"})]})})]})]})},Sa=({mediaId:s})=>e.jsx(ie,{header:e.jsx(He,{disableTitleEdit:!0}),children:e.jsx("div",{className:"flex items-center justify-center w-full flex-1 min-h-0 p-4",children:e.jsx("div",{className:"w-full h-full max-h-full overflow-y-auto",children:e.jsx(Ia,{mediaId:s,defaultExpandedImageRequirements:!0})})})}),Ma=s=>e.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...s,children:e.jsx("path",{fill:"currentColor",d:"M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10a9.96 9.96 0 0 1-4.587-1.112l-3.826 1.067a1.25 1.25 0 0 1-1.54-1.54l1.068-3.823A9.96 9.96 0 0 1 2 12C2 6.477 6.477 2 12 2m0 1.5A8.5 8.5 0 0 0 3.5 12c0 1.47.373 2.883 1.073 4.137l.15.27l-1.112 3.984l3.987-1.112l.27.15A8.5 8.5 0 1 0 12 3.5M8.75 13h4.498a.75.75 0 0 1 .102 1.493l-.102.007H8.75a.75.75 0 0 1-.102-1.493zh4.498zm0-3.5h6.505a.75.75 0 0 1 .101 1.493l-.101.007H8.75a.75.75 0 0 1-.102-1.493zh6.505z"})}),za=()=>e.jsx("div",{className:"flex flex-col h-full p-6",children:e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"flex flex-col items-center justify-center gap-4 text-center max-w-xs",children:e.jsx("div",{className:y("w-16 h-16 rounded-lg bg-zinc-100 dark:bg-zinc-800","border-2 border-dashed border-zinc-300 dark:border-zinc-600","flex items-center justify-center"),children:e.jsx(Ma,{className:"size-8"})})})})}),ln=()=>{const{workspaceId:s}=xe(),[a]=$e(),t=Ae(),n=Qs(),[r,l]=d.useMemo(()=>{const c=H.chatEditing();let i=t.pathname;if(n?i=i.replace(Js(c.embedded.toString(),"/embedded"),""):i=i.replace(c.web.toString(),""),i==="")return[e.jsx("div",{className:"w-full flex justify-center items-center",children:e.jsx(de,{})}),null];if(i.startsWith("/creator")){const p=a.get("mediaId")??void 0;return[e.jsx(Sa,{mediaId:p}),e.jsx(za,{})]}return i.startsWith("/workspace/")?s?[e.jsx(d.Suspense,{fallback:e.jsx(De,{}),children:e.jsx(Pa,{workspaceId:s})}),e.jsx(Qt,{})]:[e.jsx("div",{className:"w-full h-full flex justify-center",children:e.jsx(de,{})}),null]:[null,null]},[n,t.pathname,a,s]);return e.jsx(Xs,{scene:"chat-editing",headerSlot:e.jsx(ht,{value:et.ChatEditing}),right:l,main:r,mainProps:{className:"overflow-auto"}})},Pa=({workspaceId:s})=>{const{data:a,isLoading:t}=st({id:s},{suspense:!0,revalidateOnFocus:!1}),{items:n}=Da(s);return t||!a?e.jsx(e.Fragment,{children:e.jsx(ie,{children:e.jsx(U,{})})}):e.jsx(Ea,{workspace:a,tasks:n})},Ea=({workspace:s,tasks:a=[]})=>{const[,t]=T(),[n,r]=S(),{data:l}=tt({workspaceId:s.id},{suspense:!0,revalidateOnFocus:!1});d.useEffect(()=>{t(u=>{if(u.reactions.length=0,!!l)for(const m of l)m&&u.reactions.push({taskId:m.taskId,mediaId:m.mediaId,likeOrDislike:m.likeOrDislike})})},[l,t]);const c=d.useCallback((u,m=!1)=>{const o=ee(u);o!==void 0&&t(h=>{const g=h.history.findIndex(x=>x.id===o.id);if(g!==-1){h.history[g]=o;return}m&&h.history.push(o)})},[t]),i=d.useCallback(u=>{for(const m of u)c(m,!1)},[c]);d.useEffect(()=>{const u={id:"0",prompt:"",status:C.completed,outputImageId:s.initialImage,type:M.StartPoint};t(o=>{o.history.length=0,o.history.push(u),o.workspace=s});let m="0";if(a&&a.length>0)for(const o of a)c(o,!0),o.status===C.completed&&(m=o.id);r(o=>{o.selectedItemId=m,o.isLoading=!1})},[c,r,t,a,s,s.initialImage]);const p=at();return d.useEffect(()=>{let u;if(p){const m=nt.subscribe(o=>{i([o])});u=()=>m.unsubscribe()}else{const m=window.setInterval(async()=>{try{const o=await lt({last:30,parameterFields:["prompts","mediaId","modelId","chat","model","inputs","workflowName","enlarge","enlargeModel","upscale","strength","samplingSteps"]}),h=ot(o.data?.me?.tasks?.edges?.map(g=>g?.node));i(h)}catch(o){console.error(o)}},5e3);u=()=>window.clearInterval(m)}return u},[p,i]),n.isLoading?e.jsx(De,{}):e.jsx("div",{className:"flex flex-grow flex-col w-full h-[var(--visible-height)] md:h-[calc(var(--visible-height)-150px)]",children:e.jsx(ka,{})})},Da=s=>{const{items:a,hasMore:t,loading:n,loadMore:r,reset:l}=it({fetcher:V.getChatWorkspaceTasks,getArgs:c=>({workspaceId:s,first:30,after:c?.chatWorkspaceTasks?.pageInfo?.endCursor}),getItems:c=>xt(c.chatWorkspaceTasks),getHasMore:c=>c.chatWorkspaceTasks?.pageInfo.hasNextPage??!1,getTotalCount:c=>c.chatWorkspaceTasks?.totalCount??void 0});return d.useEffect(()=>{l()},[l,s]),d.useEffect(()=>{t&&r()},[a,t,r]),{items:a,loading:n}};export{ln as Component};
